<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVI SCAN - AI-Powered Digital Forensics Tool</title>
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    <link rel="manifest" href="/static/site.webmanifest">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #00d4ff 0%, #3b82f6 25%, #8b5cf6 75%, #ec4899 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --border-radius: 16px;
            --shadow: 0 20px 40px rgba(0,0,0,0.1);
            --shadow-hover: 0 30px 60px rgba(0,0,0,0.15);
        }

        /* Dark Mode Variables (Default) - Matching React UI */
        [data-theme="dark"] {
            --dark-bg: #020617;
            --card-bg: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-color: #3b82f6;
            --input-bg: rgba(15, 23, 42, 0.8);
            --input-border: rgba(51, 65, 85, 0.5);
            --nav-bg: rgba(15, 23, 42, 0.95);
            --nav-border: rgba(51, 65, 85, 0.5);
            --status-bg: rgba(59, 130, 246, 0.1);
            --file-bg: rgba(15, 23, 42, 0.8);
            --upload-bg: rgba(15, 23, 42, 0.5);
            --upload-border: rgba(51, 65, 85, 0.5);
            --result-bg: rgba(15, 23, 42, 0.8);
            --result-border: rgba(51, 65, 85, 0.5);
        }

        /* Light Mode Variables - Soft, elevated look */
        [data-theme="light"] {
            /* Background & surfaces */
            --dark-bg: #f3f4f7;              /* page background */
            --card-bg: #ffffff;              /* main cards */
            --result-bg: #ffffff;
            --result-border: rgba(148, 163, 184, 0.35);
            --file-bg: #f9fafb;
            --upload-bg: #f3f4ff;            /* slight tint for dropzones */
            --upload-border: rgba(129, 140, 248, 0.45);
            --status-bg: rgba(129, 140, 248, 0.10);

            /* Text */
            --text-primary: #0f172a;         /* slate-900 */
            --text-secondary: #6b7280;       /* slate-500 */

            /* Accents */
            --accent-color: #6366f1;         /* indigo-500 */
            --input-bg: rgba(255, 255, 255, 0.95);
            --input-border: rgba(148, 163, 184, 0.6);

            /* Navigation */
            --nav-bg: rgba(255, 255, 255, 0.96);
            --nav-border: rgba(203, 213, 225, 0.9);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background: var(--dark-bg);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Global Scrollbar Styling */
        /* Webkit browsers (Chrome, Safari, Edge) */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--input-bg);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.5);
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.8);
        }

        /* Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(59, 130, 246, 0.5) var(--input-bg);
        }

        /* Dark theme specific scrollbar colors */
        [data-theme="dark"] ::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.8);
        }

        [data-theme="dark"] ::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.5);
        }

        [data-theme="dark"] ::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.8);
        }

        [data-theme="dark"] * {
            scrollbar-color: rgba(59, 130, 246, 0.5) rgba(15, 23, 42, 0.8);
        }

        /* Light theme specific scrollbar colors */
        [data-theme="light"] ::-webkit-scrollbar-track {
            background: rgba(243, 244, 246, 0.8);
        }

        [data-theme="light"] ::-webkit-scrollbar-thumb {
            background: rgba(156, 163, 175, 0.6);
        }

        [data-theme="light"] ::-webkit-scrollbar-thumb:hover {
            background: rgba(107, 114, 128, 0.8);
        }

        [data-theme="light"] * {
            scrollbar-color: rgba(156, 163, 175, 0.6) rgba(243, 244, 246, 0.8);
        }

        /* Animated Background */
        .bg-animated {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            transition: opacity 0.3s ease;
        }

        [data-theme="dark"] .bg-animated {
            background: #020617;
            background-size: 400% 400%;
        }

        [data-theme="light"] .bg-animated {
            background: #f5f5f5;
            background-size: 400% 400%;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Header - Matching React UI */
        .main-header {
            background: var(--nav-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--nav-border);
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1rem;
            height: 64px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.3s ease;
            text-decoration: none;
            color: var(--accent-color);
            font-weight: 700;
            font-size: 1.25rem;
        }

        .logo:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }

        .logo i {
            font-size: 1.75rem;
            color: var(--accent-color);
            filter: drop-shadow(0 2px 4px rgba(59, 130, 246, 0.3));
            transition: all 0.3s ease;
        }

        .logo:hover i {
            filter: drop-shadow(0 4px 8px rgba(59, 130, 246, 0.5));
        }

        .logo span {
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        /* Hide any search/magnifying glass icons in the logo area */
        .logo .fa-search,
        .logo i.fa-search,
        .logo [class*="search"],
        .logo [class*="magnifying"] {
            display: none !important;
        }

        /* Search Bar - Matching React UI */
        .header-search {
            flex: 1;
            max-width: 32rem;
            margin: 0 2rem;
            display: none;
        }

        .header-search.active {
            display: block;
        }

        .search-input-wrapper {
            position: relative;
        }

        .search-input-wrapper svg {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 1.25rem;
            height: 1.25rem;
            color: var(--text-secondary);
            pointer-events: none;
        }

        .search-input {
            width: 100%;
            padding: 0.5rem 0.75rem 0.5rem 2.5rem;
            border: 1px solid var(--nav-border);
            border-radius: 0.5rem;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .search-input::placeholder {
            color: var(--text-secondary);
        }

        /* Header Actions - Matching React UI */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-btn {
            padding: 0.5rem;
            border-radius: 0.375rem;
            color: var(--text-secondary);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-btn:hover {
            color: var(--text-primary);
            background: var(--input-bg);
        }

        .header-btn svg {
            width: 1.25rem;
            height: 1.25rem;
        }

        .notification-btn {
            position: relative;
        }

        .exit-session-btn {
            color: #ef4444;
        }

        .exit-session-btn:hover {
            color: #dc2626;
            background: rgba(239, 68, 68, 0.1);
        }

        .notification-dot {
            position: absolute;
            top: 0.375rem;
            right: 0.375rem;
            width: 0.5rem;
            height: 0.5rem;
            background: #ef4444;
            border-radius: 50%;
            border: 2px solid var(--nav-bg);
        }

        .profile-btn {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            overflow: hidden;
            border: 1px solid var(--nav-border);
        }

        .profile-btn img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--status-bg);
            border: 1px solid var(--accent-color);
            border-radius: 25px;
            color: var(--accent-color);
            font-weight: 500;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-color);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Navigation Bar */
        .navbar {
            background: var(--nav-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--nav-border);
            padding: 1rem 0;
            position: sticky;
            top: 80px;
            z-index: 999;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.8rem 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            background: rgba(0, 212, 255, 0.1);
            border-color: var(--accent-color);
            color: var(--accent-color);
            transform: translateY(-2px);
        }

        .nav-link.active {
            background: var(--primary-gradient);
            border-color: var(--accent-color);
            color: white;
        }

        .nav-link i {
            font-size: 1rem;
        }
        .main-container {
            padding: 2rem 1rem;
            max-width: 1280px;
            margin: 0 auto;
        }

        @media (min-width: 640px) {
            .main-container {
                padding: 2rem 1.5rem;
            }
        }

        @media (min-width: 1024px) {
            .main-container {
                padding: 2rem 2rem;
            }
        }

        /* Command Interface */
        .command-interface {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--result-border);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .command-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .command-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.025em;
        }

        .ai-badge {
            background: var(--secondary-gradient);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .command-input-group {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .command-input {
            width: 100%;
            padding: 1rem 1.5rem;
            background: var(--input-bg);
            border: 2px solid var(--input-border);
            border-radius: 25px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .command-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
            background: rgba(255, 255, 255, 0.08);
        }

        .command-input::placeholder {
            color: var(--text-secondary);
        }

        /* Upload Styles - Matching React UI */
        .upload-section {
            margin-top: 2rem;
        }

        .upload-section-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .upload-dropzone {
            transition: all 0.2s ease;
            border: 2px dashed var(--upload-border);
            border-radius: 0.75rem;
            padding: 2.5rem;
            text-align: center;
            cursor: pointer;
            background: var(--upload-bg);
            position: relative;
        }
        
        .upload-dropzone:hover {
            border-color: var(--accent-color);
            background: rgba(59, 130, 246, 0.05);
        }

        .upload-dropzone.upload-dropzone-active {
            border-color: var(--accent-color);
            background: rgba(59, 130, 246, 0.1);
        }
        
        .upload-icon-wrapper {
            width: 4rem;
            height: 4rem;
            margin: 0 auto 1rem;
            background: var(--input-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .upload-icon-wrapper svg {
            width: 2rem;
            height: 2rem;
        }

        .upload-text {
            font-size: 1.125rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .upload-hint {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }
        
        .uploaded-files {
            margin-top: 1.5rem;
            background: var(--card-bg);
            border-radius: 0.75rem;
            padding: 1rem;
            border: 1px solid var(--result-border);
            transition: background-color 0.3s ease;
        }

        .uploaded-files h4 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }
        
        .uploaded-file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--file-bg);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            transition: background-color 0.3s ease;
            border: 1px solid var(--result-border);
        }

        .uploaded-file-item:hover {
            background: var(--input-bg);
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.875rem;
        }
        
        .file-size {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
        
        .file-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            background: var(--status-bg);
            color: var(--accent-color);
            font-weight: 500;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .file-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .file-action-btn {
            padding: 0.25rem 0.5rem;
            background: transparent;
            border: 1px solid var(--result-border);
            border-radius: 0.375rem;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s ease;
        }

        .file-action-btn:hover {
            background: var(--input-bg);
            color: var(--text-primary);
            border-color: var(--accent-color);
        }

        /* Theme Toggle Switch */
        .theme-toggle {
            position: relative;
            display: inline-block;
            width: 70px;
            height: 35px;
        }

        .theme-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .theme-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--input-bg);
            border: 2px solid var(--input-border);
            border-radius: 35px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .theme-slider:before {
            position: absolute;
            content: "";
            height: 27px;
            width: 27px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .theme-toggle input:checked + .theme-slider {
            background: var(--accent-color);
            border-color: var(--accent-color);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1), 0 0 20px rgba(59, 130, 246, 0.3);
        }

        .theme-toggle input:checked + .theme-slider:before {
            transform: translateX(35px);
            background: #8b5cf6;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.4);
        }

        .theme-toggle .theme-icon {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
        }

        .theme-toggle .theme-icon.sun {
            right: 10px;
            color: #fbbf24;
        }

        .theme-toggle .theme-icon.moon {
            left: 10px;
            color: #6366f1;
        }

        .theme-toggle input:checked ~ .theme-icon.sun {
            opacity: 0.4;
            transform: translateY(-50%) scale(0.8);
        }

        .theme-toggle input:not(:checked) ~ .theme-icon.moon {
            opacity: 0.4;
            transform: translateY(-50%) scale(0.8);
        }

        .theme-toggle:hover .theme-slider {
            transform: scale(1.05);
        }

        /* Preference Settings */
        .preference-settings {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .preference-item {
            background: var(--file-bg);
            border-radius: 12px;
            border: 1px solid var(--result-border);
            padding: 1.25rem;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .preference-item:hover {
            border-color: var(--accent-color);
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.1);
        }

        .preference-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .preference-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .preference-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .preference-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            transition: 0.3s;
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preference-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .preference-toggle input:checked + .preference-slider {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }

        .preference-toggle input:checked + .preference-slider:before {
            transform: translateX(26px);
            background: white;
        }

        .preference-icon {
            color: var(--text-secondary);
            font-size: 12px;
            z-index: 1;
            transition: color 0.3s ease;
        }

        .preference-toggle input:checked + .preference-slider .preference-icon {
            color: white;
        }

        /* Sound Selection */
        .sound-selection {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .sound-label {
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sound-label::before {
            content: "ðŸ””";
            font-size: 1rem;
        }

        .sound-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .chime-dropdown {
            flex: 1;
            background: var(--input-bg);
            border: 2px solid var(--input-border);
            border-radius: 10px;
            padding: 0.6rem 0.8rem;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.8rem center;
            background-size: 1rem;
            padding-right: 2.5rem;
        }

        .chime-dropdown:hover {
            border-color: var(--accent-color);
            background-color: var(--file-bg);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
        }

        .chime-dropdown:focus {
            outline: none;
            border-color: var(--accent-color);
            background-color: var(--file-bg);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
            transform: translateY(-1px);
        }

        .chime-dropdown option {
            background: var(--card-bg);
            color: var(--text-primary);
            padding: 0.5rem;
            font-weight: 500;
        }

        .test-sound-btn {
            background: linear-gradient(135deg, var(--accent-color), #7c3aed);
            border: none;
            border-radius: 10px;
            padding: 0.6rem 0.8rem;
            color: white;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
            position: relative;
            overflow: hidden;
            min-width: 44px;
            height: 44px;
        }

        .test-sound-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .test-sound-btn:hover {
            background: linear-gradient(135deg, #7c3aed, var(--accent-color));
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }

        .test-sound-btn:hover::before {
            left: 100%;
        }

        .test-sound-btn:active {
            transform: translateY(0) scale(0.98);
        }

        .test-sound-btn i {
            font-size: 0.9rem;
            z-index: 1;
            position: relative;
        }

        /* Dark mode specific adjustments */
        [data-theme="dark"] .chime-dropdown {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ccc' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
        }

        /* Light mode specific adjustments */
        [data-theme="light"] .chime-dropdown {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23555' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
        }

        /* Settings Button */
        .settings-btn {
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 12px;
            padding: 0.8rem;
            color: var(--text-primary);
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 45px;
            height: 45px;
        }

        .settings-btn:hover {
            background: var(--file-bg);
            border-color: var(--accent-color);
            transform: translateY(-2px) rotate(90deg);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        /* Settings Sidebar */
        .settings-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-left: 1px solid var(--result-border);
            z-index: 2000;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: -10px 0 30px rgba(0, 0, 0, 0.2);
            overflow-y: auto;
        }

        .settings-sidebar.open {
            right: 0;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2rem 2rem 1rem;
            border-bottom: 1px solid var(--result-border);
        }

        .sidebar-header h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .sidebar-close {
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 8px;
            padding: 0.5rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-close:hover {
            background: var(--file-bg);
            border-color: var(--accent-color);
            transform: scale(1.1);
        }

        .sidebar-content {
            padding: 1rem 2rem 2rem;
        }

        .sidebar-section {
            margin-bottom: 2rem;
        }

        .sidebar-section h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--result-border);
        }

        /* Profile Card */
        .profile-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--file-bg);
            border-radius: 12px;
            border: 1px solid var(--result-border);
            transition: all 0.3s ease;
        }

        .profile-card:hover {
            background: var(--input-bg);
            transform: translateY(-2px);
        }

        .profile-avatar {
            width: 50px;
            height: 50px;
            background: var(--primary-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.2rem;
        }

        .profile-role {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Manage Cases Button */
        .manage-cases-btn {
            width: 100%;
            background: var(--primary-gradient);
            border: none;
            border-radius: 12px;
            padding: 1rem;
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .manage-cases-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .manage-cases-btn:active {
            transform: translateY(0);
        }

        .manage-cases-btn i {
            font-size: 1rem;
        }

        /* Theme Settings */
        .theme-settings {
            padding: 1rem;
            background: var(--file-bg);
            border-radius: 12px;
            border: 1px solid var(--result-border);
        }

        .theme-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-primary);
            font-weight: 500;
            cursor: pointer;
        }

        /* Preference Items */
        .preference-item {
            margin-bottom: 1rem;
        }

        .preference-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-primary);
            font-weight: 500;
            cursor: pointer;
            padding: 0.8rem;
            background: var(--file-bg);
            border-radius: 8px;
            border: 1px solid var(--result-border);
            transition: all 0.3s ease;
        }

        .preference-label:hover {
            background: var(--input-bg);
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 25px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 25px;
            transition: all 0.3s ease;
        }

        .switch-slider:before {
            position: absolute;
            content: "";
            height: 19px;
            width: 19px;
            left: 2px;
            bottom: 2px;
            background: var(--accent-color);
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .toggle-switch input:checked + .switch-slider {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }

        .toggle-switch input:checked + .switch-slider:before {
            transform: translateX(25px);
            background: white;
        }

        /* Format Buttons */
        .format-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .format-btn {
            flex: 1;
            background: var(--file-bg);
            border: 1px solid var(--result-border);
            border-radius: 8px;
            padding: 0.8rem 0.5rem;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .format-btn:hover {
            background: var(--input-bg);
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .format-btn.active {
            background: var(--accent-color);
            border-color: var(--accent-color);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .format-btn i {
            font-size: 1.1rem;
        }

        .format-btn span {
            font-size: 0.8rem;
            font-weight: 700;
        }

        /* PDF Export Section */
        .pdf-export-section {
            padding: 0.5rem 0;
        }

        .pdf-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .pdf-export-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
        }

        .pdf-export-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
        }

        .pdf-export-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .pdf-export-btn i {
            font-size: 1.3rem;
        }

        .pdf-options {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1rem;
            padding: 1rem;
            background: var(--input-bg);
            border-radius: 10px;
            border: 1px solid var(--input-border);
        }

        .pdf-option-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-primary);
            padding: 0.5rem;
            border-radius: 6px;
            transition: background 0.2s ease;
        }

        .pdf-option-label:hover {
            background: var(--file-bg);
        }

        .pdf-option-label input[type="radio"] {
            cursor: pointer;
            accent-color: var(--accent-color);
        }

        .pdf-option-label span {
            flex: 1;
        }

        /* System Info */
        .system-info {
            padding: 1rem;
            background: var(--file-bg);
            border-radius: 12px;
            border: 1px solid var(--result-border);
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }

        .info-item:last-child {
            margin-bottom: 0;
        }

        .info-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .info-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        .status-online {
            color: #10b981;
            font-weight: 600;
        }

        /* Sidebar Overlay */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1500;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .settings-sidebar {
                width: 100%;
                right: -100%;
            }
        }
        
        /* Auto-complete dropdown */
        .autocomplete-container {
            position: relative;
            width: 100%;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--result-border);
            border-radius: 0 0 15px 15px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: var(--shadow);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .autocomplete-item {
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            border-bottom: 1px solid var(--result-border);
            transition: all 0.2s ease;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: var(--status-bg);
            color: var(--accent-color);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-category {
            background: rgba(255, 255, 255, 0.05);
            padding: 0.5rem 1rem;
            font-weight: 600;
            color: var(--accent-color);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .execute-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary-gradient);
            border: none;
            color: white;
            padding: 0.7rem 1.5rem;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .execute-btn:hover {
            transform: translateY(-50%) translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .execute-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: translateY(-50%);
        }

        /* Quick Commands */
        .quick-commands {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .command-category {
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .command-category:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
            border-color: var(--accent-color);
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin-bottom: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .category-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
        }

        .category-icon.get { background: var(--success-gradient); }
        .category-icon.search { background: var(--warning-gradient); }
        .category-icon.analyze { background: var(--danger-gradient); }
        .category-icon.summarize { background: var(--primary-gradient); }

        .command-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .command-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            padding: 0.7rem 1rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            text-align: left;
            font-family: 'Courier New', monospace;
        }

        .command-btn:hover {
            background: rgba(0, 212, 255, 0.1);
            border-color: var(--accent-color);
            color: var(--accent-color);
            transform: translateX(5px);
        }

        /* Results Section */
        .results-section {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 300px;
        }

        /* Command History */
        .command-history {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .history-item:hover {
            background: rgba(0, 212, 255, 0.05);
            border-color: var(--accent-color);
        }

        .history-command {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .command-icon {
            width: 35px;
            height: 35px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: white;
        }

        .command-icon.get { background: var(--success-gradient); }
        .command-icon.search { background: var(--warning-gradient); }
        .command-icon.analyze { background: var(--danger-gradient); }
        .command-icon.summarize { background: var(--primary-gradient); }

        .command-text {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: var(--text-primary);
            flex: 1;
        }

        .command-status {
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-success { background: rgba(74, 222, 128, 0.2); color: #4ade80; }
        .status-error { background: rgba(248, 113, 113, 0.2); color: #f87171; }
        .status-warning { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .status-info { background: rgba(96, 165, 250, 0.2); color: #60a5fa; }

        .history-timestamp {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        /* Enhanced Result Display */
        .result-card {
            background: var(--result-bg);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--result-border);
            margin-bottom: 1rem;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .result-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .result-count {
            background: var(--accent-color);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .result-items {
            display: grid;
            gap: 0.8rem;
        }

        .result-item {
            background: var(--file-bg);
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid var(--result-border);
            transition: all 0.3s ease;
        }

        .result-item:hover {
            background: var(--input-bg);
            border-color: var(--accent-color);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .item-title {
            font-weight: 600;
            color: var(--accent-color);
        }

        .item-meta {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .item-content {
            color: var(--text-primary);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Command Builder */
        .command-builder {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .builder-step {
            margin-bottom: 1.5rem;
        }

        .step-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .step-number {
            width: 25px;
            height: 25px;
            background: var(--accent-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .builder-select {
            width: 100%;
            padding: 0.8rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .builder-select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        .builder-input {
            width: 100%;
            padding: 0.8rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .builder-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        .builder-input::placeholder {
            color: var(--text-secondary);
        }

        .preview-command {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-family: 'Courier New', monospace;
            color: var(--accent-color);
            font-size: 1rem;
            margin-top: 1rem;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .results-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .export-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .export-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }

        .export-btn:hover {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .clear-chat-btn {
            background: rgba(255, 68, 68, 0.1) !important;
            border-color: rgba(255, 68, 68, 0.3) !important;
            color: #ff4444 !important;
        }

        .clear-chat-btn:hover {
            background: #ff4444 !important;
            color: white !important;
            border-color: #ff4444 !important;
            transform: translateY(-1px);
        }

        .result-content {
            background: var(--result-bg);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--result-border);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
            color: var(--text-primary);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        .result-json {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .status-success { color: #4ade80; }
        .status-error { color: #f87171; }
        .status-warning { color: #fbbf24; }
        .status-info { color: #60a5fa; }

        /* Stats Section */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-top: 2px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-container {
                padding: 1rem;
            }
            
            .command-interface,
            .results-section {
                padding: 1.5rem;
            }
            
            .quick-commands {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .command-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--card-bg);
            margin: 2% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            background: var(--primary-gradient);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: background-color 0.3s;
        }

        .modal-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .file-preview {
            background: var(--bg-secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .file-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .info-item {
            background: var(--bg-secondary);
            padding: 0.8rem;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-label {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.3rem;
        }

        .info-value {
            color: var(--text-secondary);
        }

        /* Sidebar Toggle Button */
        .sidebar-toggle-btn {
            position: fixed;
            left: 1rem;
            top: 5rem;
            z-index: 150;
            width: 2.5rem;
            height: 2.5rem;
            background: var(--card-bg);
            border: 1px solid var(--nav-border);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .sidebar-toggle-btn:hover {
            background: var(--input-bg);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .sidebar-toggle-btn svg {
            width: 1.25rem;
            height: 1.25rem;
            color: var(--text-primary);
        }


        /* Investigation Sidebar - Matching React UI */
        .investigation-sidebar {
            width: 320px;
            background: var(--card-bg);
            border-right: 1px solid var(--nav-border);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 64px);
            position: fixed;
            left: 0;
            top: 64px;
            z-index: 100;
            transition: transform 0.3s ease;
            overflow: hidden;
        }

        .investigation-sidebar.collapsed {
            transform: translateX(-100%);
        }

        /* Removed - replaced with tab bar */

        /* Sidebar Tab Bar (Browser-style tabs) */
        .sidebar-tab-bar {
            display: flex;
            gap: 0.25rem;
            padding: 0.5rem;
            border-bottom: 1px solid var(--nav-border);
            background: var(--sidebar-bg);
        }

        .sidebar-tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--input-bg);
            color: var(--text-secondary);
            border: 1px solid var(--input-border);
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .sidebar-tab:hover {
            background: var(--file-bg);
            color: var(--text-primary);
        }

        .sidebar-tab.active {
            background: var(--card-bg);
            color: var(--accent-color);
            border-color: var(--accent-color);
            border-bottom-color: var(--card-bg);
            z-index: 1;
            margin-bottom: -1px;
        }

        .sidebar-tab i {
            font-size: 0.875rem;
        }

        .sidebar-tab span {
            font-size: 0.8rem;
        }

        /* Sidebar Tab Content */
        .sidebar-tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .sidebar-tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* Smart Analysis Sidebar Button */
        .sidebar-smart-analysis {
            padding: 0.5rem;
            border-bottom: 1px solid var(--nav-border);
        }

        .smart-analysis-sidebar-btn {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .smart-analysis-sidebar-btn:hover {
            background: linear-gradient(135deg, #ff5252, #ff7979);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }

        .smart-analysis-sidebar-btn i {
            font-size: 1rem;
        }

        .sidebar-history {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .history-header {
            padding: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
        }

        .history-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 0.25rem;
            position: relative;
        }

        .history-item:hover {
            background: var(--input-bg);
        }

        .history-item.active {
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .history-item-icon {
            width: 1rem;
            height: 1rem;
            flex-shrink: 0;
            color: var(--text-secondary);
        }

        .history-item-title {
            flex: 1;
            font-size: 0.875rem;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .history-item.active .history-item-title {
            color: var(--text-primary);
        }

        .history-item-delete {
            opacity: 0;
            padding: 0.25rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .history-item:hover .history-item-delete {
            opacity: 1;
        }

        .history-item-delete:hover {
            color: #ef4444;
        }

        /* Stats in Sidebar */
        .sidebar-stats {
            padding: 1rem;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .sidebar-stats-header {
            padding: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
        }

        .sidebar-stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }

        .sidebar-stat-card {
            background: var(--input-bg);
            border-radius: 0.5rem;
            padding: 0.75rem;
            border: 1px solid var(--nav-border);
            transition: all 0.2s ease;
        }

        .sidebar-stat-card:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--accent-color);
        }

        .sidebar-stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.25rem;
        }

        .sidebar-stat-label {
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Upload in Header */
        .header-upload {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: 1rem;
        }

        .header-upload-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .header-upload-btn:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        .header-upload-btn svg {
            width: 16px;
            height: 16px;
        }

        .header-upload-dropdown {
            position: relative;
        }

        .header-upload-menu {
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--nav-border);
            border-radius: 0.5rem;
            padding: 1rem;
            min-width: 320px;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            display: none;
        }

        .header-upload-menu.active {
            display: block;
        }

        .header-upload-dropzone {
            border: 2px dashed var(--upload-border);
            border-radius: 0.5rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            background: var(--upload-bg);
            transition: all 0.2s ease;
        }

        .header-upload-dropzone:hover {
            border-color: var(--accent-color);
            background: rgba(59, 130, 246, 0.05);
        }

        .header-upload-icon {
            width: 2rem;
            height: 2rem;
            margin: 0 auto 0.5rem;
            color: var(--text-secondary);
        }

        .header-upload-text {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .header-upload-hint {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Main Content Area with Sidebar */
        .main-content-with-sidebar {
            margin-left: 320px;
            min-height: calc(100vh - 64px);
            transition: margin-left 0.3s ease;
        }

        .main-content-with-sidebar.sidebar-collapsed {
            margin-left: 0;
        }

        /* Forensic Chat Interface Styles - Matching React UI */
        .chat-section {
            background: transparent;
            border-radius: 0;
            padding: 0;
            margin-bottom: 0;
            box-shadow: none;
            border: none;
            position: relative;
            overflow: visible;
            backdrop-filter: none;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 64px);
            width: 100%;
        }

        .main-content-with-sidebar .container {
            padding: 0;
            max-width: 100%;
        }

        .chat-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-color), #667eea, #764ba2, var(--accent-color));
            background-size: 200% 100%;
            animation: forensicPulse 3s ease-in-out infinite;
        }

        @keyframes forensicPulse {
            0%, 100% { 
                background-position: 0% 50%;
                opacity: 0.8; 
            }
            50% { 
                background-position: 100% 50%;
                opacity: 1; 
            }
        }

        .chat-header-bar {
            height: 64px;
            border-bottom: 1px solid var(--nav-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            background: var(--card-bg);
        }

        .clear-chat-header-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--nav-border);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .clear-chat-header-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .clear-chat-header-btn svg {
            width: 16px;
            height: 16px;
        }

        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .chat-back-btn {
            padding: 0.5rem;
            border-radius: 50%;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chat-back-btn:hover {
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .chat-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Hide any search/magnifying glass icons in the chat title area */
        .chat-title::before,
        .chat-title::after,
        .chat-title i.fa-search,
        .chat-title .fa-search,
        .chat-header-left .fa-search,
        .chat-header-left i.fa-search {
            display: none !important;
        }

        .download-report-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--input-bg);
            color: var(--text-primary);
            border: 1px solid var(--nav-border);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .download-report-btn:hover {
            background: var(--result-bg);
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background: var(--dark-bg);
            scroll-behavior: auto; /* Changed from 'smooth' to prevent scroll jumps during streaming */
            max-width: 100%;
            width: 100%;
        }

        .chat-message-wrapper {
            display: flex;
            gap: 0;
            padding: 1rem 0;
            margin: 0;
            max-width: 100%;
            width: 100%;
            justify-content: flex-start;
            transition: background-color 0.2s ease;
        }

        .chat-message-wrapper:hover {
            background: transparent;
        }

        .chat-message-wrapper.user-message {
            justify-content: flex-end;
        }

        .chat-message-wrapper.user-message:hover {
            background: transparent;
        }

        .chat-avatar {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 0.25rem;
        }

        .chat-avatar.ai {
            background: #2563eb;
            color: white;
            box-shadow: 0 2px 6px rgba(37, 99, 235, 0.3);
        }

        .chat-avatar.user {
            background: #64748b;
            color: white;
            box-shadow: 0 2px 6px rgba(100, 116, 139, 0.3);
        }

        /* Chat messages scrollbar uses global styles */

        .chat-message {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex: 1;
        }

        .chat-message.user-message {
            align-items: flex-end;
        }

        .chat-message-wrapper.user-message .chat-message {
            align-items: flex-end;
        }

        .chat-message-bubble {
            padding: 0.875rem 1.125rem;
            border-radius: 1rem;
            font-size: 0.9375rem;
            line-height: 1.6;
            word-wrap: break-word;
            max-width: 75%;
            animation: messageSlideIn 0.3s ease-out;
            position: relative;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .chat-message-bubble.ai {
            background: transparent;
            color: var(--text-primary);
            border: none;
            border-bottom-left-radius: 0.25rem;
            padding: 0.5rem 0;
        }

        .chat-message-bubble.user {
            background: #2563eb;
            color: white;
            border: none;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }

        .chat-message-bubble pre {
            background: var(--input-bg);
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 0.5rem 0;
            border: 1px solid var(--nav-border);
        }

        .chat-message-bubble code {
            background: var(--input-bg);
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.875em;
            border: 1px solid var(--nav-border);
        }

        .chat-message-bubble pre code {
            background: transparent;
            padding: 0;
            border: none;
        }

        .chat-message-timestamp {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            padding: 0 0.25rem;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message.ai-message::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, var(--accent-color), #667eea, #764ba2);
            border-radius: 20px;
            z-index: -1;
            opacity: 0.1;
        }

        /* Error message styling */
        .chat-message.ai-message.error-message {
            background: rgba(248, 113, 113, 0.1);
            border: 2px solid rgba(248, 113, 113, 0.5);
            box-shadow: 0 6px 25px rgba(248, 113, 113, 0.2);
        }

        .chat-message.ai-message.error-message::before {
            background: linear-gradient(135deg, #f87171, #ef4444, #dc2626);
            opacity: 0.2;
        }

        .chat-message.ai-message.error-message .message-content {
            color: #fca5a5;
        }

        .chat-message.ai-message.error-message .message-content strong {
            color: #f87171;
        }

        /* Streaming message styles */
        .chat-message-wrapper.streaming-message-wrapper {
            animation: messageSlideIn 0.3s ease-out;
        }

        .chat-message-wrapper.streaming-message-wrapper .chat-message-bubble {
            position: relative;
            background: transparent;
            border: none;
            box-shadow: none;
            animation: none;
        }

        @keyframes streamingPulse {
            0%, 100% {
            box-shadow: 0 0 20px rgba(37, 99, 235, 0.15);
            border-color: var(--accent-color);
            }
            50% {
            box-shadow: 0 0 30px rgba(37, 99, 235, 0.25);
            border-color: #60a5fa;
            }
        }

        .streaming-text {
            position: relative;
            color: var(--text-primary);
            opacity: 0.85;
            transition: opacity 0.2s ease;
        }

        /* Enhanced streaming content styling */
        .streaming-content {
            display: inline;
            color: var(--text-primary);
            line-height: 1.7;
            letter-spacing: 0.01em;
            word-spacing: 0.05em;
        }

        /* Smooth text appearance during streaming */
        .streaming-content p,
        .streaming-content li,
        .streaming-content span {
            animation: textFadeIn 0.3s ease-in;
        }

        @keyframes textFadeIn {
            from {
                opacity: 0.6;
            }
            to {
                opacity: 1;
            }
        }

        /* Finalized message styling - polished and readable */
        .chat-message-wrapper:not(.streaming-message-wrapper) .chat-message-bubble {
            color: var(--text-primary);
            opacity: 1;
        }

        .chat-message-wrapper:not(.streaming-message-wrapper) .streaming-content,
        .chat-message-wrapper:not(.streaming-message-wrapper) .chat-message-bubble {
            color: var(--text-primary);
            line-height: 1.7;
            letter-spacing: 0.01em;
            word-spacing: 0.05em;
        }

        .streaming-cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background: linear-gradient(180deg, #2563eb 0%, #60a5fa 100%);
            margin-left: 4px;
            margin-bottom: -2px;
            animation: blink 1s infinite;
            vertical-align: middle;
            border-radius: 1px;
            box-shadow: 0 0 4px rgba(37, 99, 235, 0.6);
            position: relative;
            z-index: 1;
            flex-shrink: 0;
        }

        /* Enhanced cursor for better visibility */
        .streaming-text .streaming-cursor {
            background: linear-gradient(180deg, #3b82f6 0%, #60a5fa 50%, #93c5fd 100%);
            box-shadow: 0 0 6px rgba(37, 99, 235, 0.8), 0 0 12px rgba(59, 130, 246, 0.4);
            width: 2.5px;
        }

        @keyframes blink {
            0%, 49% {
                opacity: 1;
                transform: scaleY(1);
            }
            50%, 100% {
                opacity: 0.3;
                transform: scaleY(0.9);
            }
        }

        /* Smooth cursor pulse for active streaming */
        .streaming-message-wrapper .streaming-cursor {
            animation: blink 1s infinite, pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 6px rgba(37, 99, 235, 0.8), 0 0 12px rgba(59, 130, 246, 0.4);
            }
            50% {
                box-shadow: 0 0 8px rgba(37, 99, 235, 1), 0 0 16px rgba(59, 130, 246, 0.6);
            }
        }

        /* Image Citations Gallery Styles */
        .image-citations-section {
            margin-top: 1.5rem;
            padding: 1.25rem;
            background: rgba(139, 92, 246, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .image-citations-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            color: var(--accent-color);
            font-size: 1rem;
        }

        .image-citations-header i {
            font-size: 1.2rem;
        }

        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .more-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .image-gallery-item {
            position: relative;
            background: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--result-border);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            user-select: none;
        }
        
        .image-gallery-item * {
            cursor: pointer;
        }

        .image-gallery-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.3);
        }

        .image-thumbnail-container {
            position: relative;
            width: 100%;
            padding-top: 100%; /* Square aspect ratio */
            overflow: hidden;
            background: #f3f4f6;
        }

        .image-thumbnail {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .image-gallery-item:hover .image-thumbnail {
            transform: scale(1.1);
        }

        .image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .image-gallery-item:hover .image-overlay {
            opacity: 1;
        }

        .image-overlay i {
            color: white;
            font-size: 1.5rem;
        }

        .image-info {
            padding: 0.75rem;
        }

        .image-filename {
            font-size: 0.85rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.25rem;
        }

        .context-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .attachment-badge {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .file-badge {
            background: rgba(139, 92, 246, 0.1);
            color: var(--accent-color);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .more-images-section {
            margin-top: 1rem;
        }

        .more-images-btn {
            width: 100%;
            padding: 0.75rem;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            color: var(--accent-color);
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        .more-images-btn:hover {
            background: rgba(139, 92, 246, 0.2);
        }

        /* Image Modal Styles */
        .image-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 2rem;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .image-modal-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .image-modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: background 0.2s;
            z-index: 10001;
        }

        .image-modal-close:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .image-modal-image {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
        }

        .image-modal-info {
            margin-top: 1rem;
            text-align: center;
            color: var(--text-primary);
        }

        /* Quit Session Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .confirm-modal {
            background: var(--card-bg);
            border: 1px solid var(--result-border);
            border-radius: 16px;
            padding: 2rem;
            max-width: 420px;
            width: 85%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            color: var(--text-primary);
        }

        .confirm-modal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--result-border);
        }

        .confirm-modal .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0;
        }

        .confirm-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #4f46e5 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
        }

        .btn-secondary {
            background: rgba(51, 65, 85, 0.5);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: rgba(51, 65, 85, 0.8);
        }

        /* Confidence Indicator */
        .confidence-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 8px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .confidence-high {
            background: rgba(76, 175, 80, 0.2);
            border-color: rgba(76, 175, 80, 0.4);
            color: #4caf50;
        }

        .confidence-medium {
            background: rgba(255, 193, 7, 0.2);
            border-color: rgba(255, 193, 7, 0.4);
            color: #ffc107;
        }

        .confidence-low {
            background: rgba(244, 67, 54, 0.2);
            border-color: rgba(244, 67, 54, 0.4);
            color: #f44336;
        }

        .confidence-bar {
            width: 40px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .confidence-fill.high {
            background: linear-gradient(90deg, #4caf50, #8bc34a);
        }

        .confidence-fill.medium {
            background: linear-gradient(90deg, #ffc107, #ff9800);
        }

        .confidence-fill.low {
            background: linear-gradient(90deg, #f44336, #e91e63);
        }

        /* Response Time Indicator */
        .response-time-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 8px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid rgba(33, 150, 243, 0.4);
            color: #2196f3;
        }

        .response-time-indicator i {
            font-size: 0.8rem;
        }

        /* Model Selection Dropdown */
        .model-selector {
            position: relative;
            display: inline-block;
            margin-left: 1rem;
        }

        .model-dropdown {
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 12px;
            padding: 8px 16px;
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            min-width: 200px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .model-dropdown:hover {
            background: var(--file-bg);
            border-color: var(--accent-color);
            transform: translateY(-1px);
        }

        .model-dropdown.active {
            background: var(--status-bg);
            border-color: var(--accent-color);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }

        .model-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .model-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .model-provider {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .model-dropdown-arrow {
            transition: transform 0.3s ease;
            color: var(--text-secondary);
        }

        .model-dropdown.active .model-dropdown-arrow {
            transform: rotate(180deg);
        }

        .model-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--result-border);
            border-radius: 12px;
            margin-top: 8px;
            padding: 8px 0;
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .model-options.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .model-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s ease;
            border-bottom: 1px solid var(--result-border);
        }

        .model-option:last-child {
            border-bottom: none;
        }

        .model-option:hover {
            background: var(--input-bg);
        }

        .model-option.selected {
            background: var(--status-bg);
            color: var(--accent-color);
        }

        .model-option-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .model-option-description {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .model-availability {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .model-option.unavailable {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .model-option.unavailable:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .model-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-left: 8px;
        }

        .model-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Forensic Badge */
        .forensic-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: linear-gradient(135deg, #00d4ff, #667eea);
            color: white;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0, 212, 255, 0.3);
        }

        .llm-status {
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1));
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 0.8rem;
            font-weight: 500;
            color: #22c55e;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .llm-status:hover {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(16, 185, 129, 0.2));
            border-color: #22c55e;
        }

        .llm-indicator {
            font-size: 0.9rem;
        }

        .llm-model {
            font-weight: 600;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(0, 212, 255, 0.2);
            margin-bottom: 15px;
            max-width: 90%;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-color);
            border-radius: 50%;
            animation: typingPulse 1.4s ease-in-out infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingPulse {
            0%, 60%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            30% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* LLM Badge */
        .llm-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
            animation: pulse-glow 2s infinite;
        }

        .llm-badge i {
            font-size: 10px;
        }

        /* RAG Badge */
        .rag-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            color: white;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
            box-shadow: 0 2px 6px rgba(139, 92, 246, 0.3);
        }

        .rag-badge i {
            font-size: 10px;
        }

            color: var(--accent-color);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .quality-warning {
            font-size: 0.7rem;
            color: var(--text-secondary);
            padding: 4px 8px;
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
            border-radius: 4px;
            margin-top: 0.25rem;
        }

        @keyframes pulse-glow {
            0%, 100% { 
                box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 4px 16px rgba(255, 107, 107, 0.5);
                transform: scale(1.02);
            }
        }

        .message-content {
            line-height: 1.5;
        }

        .message-text {
            margin-top: 0.5rem;
        }

        /* Structured Response Styling - Enhanced for Forensic Analysis */
        .analysis-section {
            margin: 1.5rem 0;
            border: none;
            border-radius: 0;
            overflow: visible;
            box-shadow: none;
            background: transparent;
        }

        .analysis-section:hover {
            transform: none;
            box-shadow: none;
        }

        .section-header {
            margin: 0;
            margin-bottom: 0.75rem;
            padding: 0;
            font-size: 0.95rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.625rem;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            font-size: 0.85rem;
            background: transparent;
            color: #2563eb;
            border: none;
        }

        /* Forensic-specific section headers - All use blue bold text */
        .executive-summary-header,
        .evidence-header,
        .timeline-header,
        .relationship-header,
        .security-header,
        .pattern-header,
        .recommendation-header,
        .integrity-header,
        .analysis-header:not(.smart-analysis-panel .analysis-header),
        .findings-header,
        .warning-header,
        .details-header {
            background: transparent;
            color: #2563eb;
            border: none;
        }

        /* Smart Analysis Panel Styles */
        .smart-analysis-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            backdrop-filter: blur(4px);
        }

        .smart-analysis-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .smart-analysis-panel {
            position: relative;
            width: 90%;
            max-width: 1000px;
            max-height: 85vh;
            background: var(--card-bg);
            border-radius: 16px;
            border: 1px solid var(--result-border);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .smart-analysis-panel .analysis-header {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            padding: 1.25rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .smart-analysis-panel .analysis-header h3 {
            margin: 0;
            color: white;
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .smart-analysis-panel .close-analysis {
            background: none;
            border: none;
            color: white;
            font-size: 1.75rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background 0.3s ease;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .smart-analysis-panel .close-analysis:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .analysis-tabs {
            display: flex;
            background: var(--input-bg);
            border-bottom: 1px solid var(--result-border);
            padding: 0.5rem;
            gap: 0.5rem;
        }

        .tab-button {
            flex: 1;
            padding: 0.75rem 1rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .tab-button:hover {
            background: var(--file-bg);
            color: var(--text-primary);
        }

        .tab-button.active {
            background: linear-gradient(135deg, #2563eb, #4f46e5);
            color: white;
        }

        .smart-analysis-panel .analysis-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            max-height: calc(85vh - 140px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .smart-analysis-panel .analysis-section {
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: var(--file-bg);
            border-radius: 12px;
            border: 1px solid var(--result-border);
        }

        .smart-analysis-panel .analysis-section h4 {
            color: var(--accent-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .smart-analysis-panel .analysis-section h4 i {
            color: var(--accent-color);
        }

        .analysis-item {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--result-border);
        }

        .exploration-panel,
        .filter-panel,
        .insights-panel {
            padding: 1rem;
        }

        .exploration-controls,
        .filter-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .explore-btn {
            padding: 0.75rem 1.5rem;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .explore-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .exploration-results,
        .filter-results,
        .insights-results {
            margin-top: 1.5rem;
            padding: 1rem;
            background: var(--file-bg);
            border-radius: 8px;
            min-height: 200px;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 0.75rem;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .insight-btn {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .insight-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .section-content {
            padding: 0;
            background: transparent;
            line-height: 1.7;
            margin-top: 0.5rem;
            color: var(--text-primary);
        }

        .bullet-point {
            margin: 0.5rem 0;
            padding: 0;
            line-height: 1.7;
            color: var(--text-primary);
        }

        .bullet-point i {
            display: none;
        }

        /* Evidence citation styling - plain text */
        .evidence-citation {
            background: transparent;
            border: none;
            padding: 0;
            margin: 0.5rem 0;
            border-radius: 0;
            font-size: inherit;
            font-family: inherit;
        }

        /* Timeline item styling - plain text */
        .timeline-item {
            position: relative;
            padding-left: 0;
            margin: 0.5rem 0;
            border: none;
        }

        .timeline-item::before {
            display: none;
        }

        .message-timestamp {
            font-size: 0.8em;
            opacity: 0.7;
            margin-top: 5px;
        }

        .chat-input-container {
            padding: 1.5rem;
            background: var(--card-bg);
            border-top: 1px solid var(--nav-border);
            position: sticky;
            bottom: 0;
            max-width: 100%;
            width: 100%;
            z-index: 10;
        }

        .chat-input-wrapper {
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
            position: relative;
            background: var(--input-bg);
            border: 1px solid var(--nav-border);
            border-radius: 1.5rem;
            box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.05), 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            padding-right: 5rem;
        }

        .chat-input-wrapper:focus-within {
            box-shadow: 0 0 0 2px rgba(84, 54, 218, 0.2), 0 2px 8px rgba(0, 0, 0, 0.1);
            border-color: rgba(84, 54, 218, 0.5);
        }

        .chat-input {
            width: 100%;
            padding: 0.875rem 4.5rem 0.875rem 1.25rem;
            background: transparent;
            border: none;
            border-radius: 1.5rem;
            color: var(--text-primary);
            font-size: 1rem;
            line-height: 1.5;
            transition: all 0.2s ease;
            outline: none;
            resize: none;
            max-height: 200px;
            overflow-y: auto;
        }

        .chat-input:focus {
            outline: none;
        }

        .chat-input::placeholder {
            color: var(--text-secondary);
        }

        .chat-send-btn,
        .chat-stop-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            padding: 0.5rem;
            background: var(--text-primary);
            color: var(--dark-bg);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            opacity: 0.5;
        }

        .chat-send-btn {
            right: 0.5rem;
        }

        .chat-stop-btn {
            right: 3rem;
            background: #ef4444;
            color: white;
            opacity: 1;
        }

        .chat-stop-btn:hover {
            background: #dc2626;
            opacity: 1;
        }

        .chat-input-wrapper:has(.chat-input:not(:placeholder-shown)) .chat-send-btn,
        .chat-send-btn:hover:not(:disabled) {
            opacity: 1;
            background: #ab68ff;
            color: white;
        }

        .chat-send-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .chat-disclaimer {
            text-align: center;
            margin-top: 0.75rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .detailed-results {
            margin-top: 15px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(22, 33, 62, 0.6));
            border-radius: 12px;
            border: 1px solid rgba(0, 212, 255, 0.3);
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
        }


        .detailed-results h4 {
            color: var(--accent-color);
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            border-bottom: 1px solid rgba(0, 212, 255, 0.2);
            padding-bottom: 8px;
        }

        .detailed-results ul {
            margin: 0;
            padding-left: 0;
            list-style: none;
        }

        .detailed-results li {
            margin-bottom: 12px;
            font-size: 0.9em;
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            transition: all 0.3s ease;
        }

        .detailed-results li:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--accent-color);
            transform: translateY(-1px);
        }

        .detailed-results .result-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .detailed-results .result-item .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .detailed-results .result-item .item-type {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .detailed-results .result-item .item-source {
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-style: italic;
        }

        .detailed-results .result-item .item-content {
            color: var(--text-primary);
            line-height: 1.4;
        }

        .detailed-results .result-item .item-meta {
            margin-top: 8px;
            display: flex;
            gap: 15px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .detailed-results .result-item .item-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .detailed-results .result-item .item-meta i {
            color: var(--accent-color);
        }

        .detailed-results .forensic-summary {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(102, 126, 234, 0.1));
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 15px;
            color: var(--accent-color);
            font-weight: 600;
            text-align: center;
            font-size: 0.9rem;
        }

        .toggle-details {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(102, 126, 234, 0.1));
            border: 1px solid rgba(0, 212, 255, 0.3);
            color: var(--accent-color);
            cursor: pointer;
            font-size: 0.85em;
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.3s ease;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 5px;
        }

        .toggle-details:hover {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(102, 126, 234, 0.2));
            border-color: var(--accent-color);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.2);
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 15px;
            color: var(--text-secondary);
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            background: var(--accent-color);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .chat-action-buttons {
            margin-top: 10px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .analysis-section {
            margin-bottom: 1.5rem;
            padding: 0;
            background: transparent;
            border-radius: 0;
            border: none;
        }

        .analysis-section h5 {
            color: #ffffff;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
        }

            justify-content: space-between;
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid var(--accent-color);
        }

        .query-analysis {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .query-analysis h6 {
            color: var(--accent-color);
            margin-bottom: 10px;
        }

        .query-analysis ul {
            margin: 5px 0;
            padding-left: 20px;
        }

        .query-analysis li {
            margin: 3px 0;
        }
    </style>
</head>
<body>
    <div class="bg-animated"></div>
    
    <!-- Header - Matching React UI -->
    <header class="main-header">
        <div class="header-content">
            <!-- Left Side - Logo -->
            <a href="/cases" class="logo">
                <i class="fas fa-fingerprint"></i>
                <span>EVI SCAN</span>
            </a>

            <!-- Case Info Badge (if opened from a case) -->
            {% if case_id and case_name %}
            <div class="case-badge" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; margin-right: auto; margin-left: 1rem;">
                <i class="fas fa-folder" style="color: var(--accent-color);"></i>
                <div style="display: flex; flex-direction: column;">
                    <span style="font-size: 0.75rem; color: var(--text-secondary); font-weight: 500;">Case</span>
                    <span style="font-size: 0.875rem; color: var(--text-primary); font-weight: 600;">{{ case_name }}</span>
                </div>
            </div>
            {% endif %}

            <!-- Right Side - Upload and Actions -->
            <div class="header-actions">
                <!-- Upload Section in Header -->
                <div class="header-upload">
                    <div class="header-upload-dropdown">
                        <button class="header-upload-btn" id="headerUploadBtn" title="Upload UFDR">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                            Upload UFDR
                        </button>
                        <div class="header-upload-menu" id="headerUploadMenu">
                            <input type="file" id="fileInput" accept=".json,.zip,.html" multiple style="display: none;">
                            <div id="uploadDropzone" class="header-upload-dropzone">
                                <div class="header-upload-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                    </svg>
                                </div>
                                <div class="header-upload-text">Upload UFDR Report</div>
                                <div class="header-upload-hint">Click or drag .zip, .json, or .html files</div>
                            </div>
                            <div style="margin-top: 1rem; display: flex; justify-content: center;">
                                <button id="clearUploadsBtn" class="header-upload-btn" style="background: #ef4444; font-size: 0.75rem; padding: 0.375rem 0.75rem;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                    Clear All
                                </button>
                            </div>
                            <div id="uploadedFilesContainer" class="uploaded-files" style="display: none; margin-top: 1rem; max-height: 200px; overflow-y: auto;">
                                <!-- Uploaded files will appear here -->
                        </div>
                    </div>
                </div>
                <button class="header-btn" id="themeToggleBtn" title="Toggle theme">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" id="themeIcon">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                </button>
                <button class="header-btn notification-btn" title="Notifications">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                    </svg>
                    <span class="notification-dot"></span>
                </button>
                <button class="header-btn exit-session-btn" id="exitSessionBtn" title="Exit Session">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                </button>
                <button class="header-btn settings-btn" id="settingsBtn" title="Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Settings Sidebar -->
    <div class="settings-sidebar" id="settingsSidebar">
        <div class="sidebar-header">
            <h3>Settings</h3>
            <button class="sidebar-close" id="sidebarClose">
                <i class="fas fa-arrow-left"></i>
            </button>
        </div>
        
        <div class="sidebar-content">
            <!-- Profile Section -->
            <div class="sidebar-section">
                <h4>Profile</h4>
                <div class="profile-card">
                    <div class="profile-avatar" id="mainProfileAvatar" style="position: relative; overflow: hidden;">
                        {% if profile_picture %}
                            <img src="/static/{{ profile_picture }}" alt="Profile" id="mainProfileImage" style="width: 100%; height: 100%; object-fit: cover; display: block;">
                            <i class="fas fa-user" id="mainProfileIcon" style="display: none;"></i>
                        {% else %}
                            <img src="" alt="Profile" id="mainProfileImage" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                            <i class="fas fa-user" id="mainProfileIcon" style="display: block;"></i>
                        {% endif %}
                    </div>
                    <div class="profile-info">
                        <div class="profile-name">{{ name if name else 'Forensic Analyst' }}</div>
                        <div class="profile-role">@{{ username if username else 'user' }}</div>
                    </div>
                </div>
                <button class="manage-cases-btn" id="manageCasesBtn">
                    <i class="fas fa-folder-open"></i>
                    <span>Manage Cases</span>
                </button>
                <a href="/logout" class="manage-cases-btn" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); text-decoration: none; margin-top: 0.5rem;">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </div>


            <!-- Preferences -->
            <div class="sidebar-section">
                <h4>Preferences</h4>
                <div class="preference-settings">
                    <!-- Sound Settings Card -->
                    <div class="preference-item">
                        <!-- Sound Notifications Toggle -->
                        <label class="preference-label">
                            <span>Sound Notifications</span>
                            <div class="preference-toggle">
                                <input type="checkbox" id="soundNotificationToggle" />
                                <label for="soundNotificationToggle" class="preference-slider">
                                    <i class="fas fa-volume-up preference-icon"></i>
                                </label>
                            </div>
                        </label>
                        
                        <!-- Chime Sound Selection -->
                        <div class="sound-selection" id="soundSelection">
                            <label class="sound-label">Chime Sound:</label>
                            <div class="sound-controls">
                                <select id="chimeSelect" class="chime-dropdown">
                                    <option value="mixkit-alert-quick-chime-766.wav">Quick Alert</option>
                                    <option value="mixkit-doorbell-tone-2864.wav">Doorbell</option>
                                    <option value="mixkit-relaxing-bell-chime-3109.wav">Relaxing Bell</option>
                                </select>
                                <button class="test-sound-btn" id="testSoundBtn">
                                    <i class="fas fa-play"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Model Selection Card -->
                    <div class="preference-item">
                        <label class="preference-label">
                            <span>AI Model</span>
                        </label>
                        <div class="model-selector">
                            <div class="model-dropdown" id="modelDropdown" title="Select AI model">
                                <span id="currentModelName">Loading models...</span>
                                <span class="model-dropdown-icon">â–¼</span>
                            </div>
                            <div class="model-options" id="modelOptions">
                                <!-- Model options will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Export Format Settings -->
            <div class="sidebar-section">
                <h4>Export Format</h4>
                <div class="format-buttons">
                    <button class="format-btn" data-format="txt">
                        <i class="fas fa-file-alt"></i>
                        <span>TXT</span>
                    </button>
                    <button class="format-btn" data-format="xml">
                        <i class="fas fa-file-code"></i>
                        <span>XML</span>
                    </button>
                    <button class="format-btn" data-format="json">
                        <i class="fas fa-file-code"></i>
                        <span>JSON</span>
                    </button>
                </div>
            </div>
            
            <!-- PDF Export for Court -->
            <div class="sidebar-section">
                <h4>Court Report Export</h4>
                <div class="pdf-export-section">
                    <p class="pdf-description">Generate a professional PDF report suitable for court presentation</p>
                    <button class="pdf-export-btn" id="pdfExportBtn">
                        <i class="fas fa-file-pdf"></i>
                        <span>Export as PDF</span>
                    </button>
                </div>
            </div>
            
            <!-- System Info -->
            <div class="sidebar-section">
                <h4>System</h4>
                <div class="system-info">
                    <div class="info-item">
                        <span class="info-label">Version</span>
                        <span class="info-value">v3.0.0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Status</span>
                        <span class="info-value status-online">Online</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Quit Session Confirmation Modal -->
    <div class="modal-overlay" id="quitSessionModal" style="display: none;">
        <div class="confirm-modal">
            <div class="modal-header">
                <div style="display: flex; align-items: center; gap: 0.625rem;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 1.25rem; color: #f59e0b;"></i>
                    <h2 class="modal-title">Quit Session</h2>
                </div>
            </div>
            <div style="padding: 1rem 0;">
                <p style="margin-bottom: 1rem; color: var(--text-primary);">Are you sure you want to quit this session and return to Case Manager?</p>
                <p style="color: var(--text-secondary); font-size: 0.875rem;">All your chat history, settings, queries, and uploaded files will be saved to this session. You can return to this session anytime.</p>
            </div>
            <div class="confirm-actions">
                <button type="button" class="btn btn-secondary" id="cancelQuitBtn">No, Stay</button>
                <button type="button" class="btn btn-primary" id="confirmQuitBtn">Yes, Quit Session</button>
            </div>
        </div>
    </div>

    <!-- Smart Analysis Panel -->
    <div class="modal-overlay smart-analysis-overlay" id="smartAnalysisPanel" style="display: none;">
        <div class="smart-analysis-panel">
            <div class="analysis-header">
                <h3><i class="fas fa-brain"></i> Dynamic Smart Analysis</h3>
                <button class="close-analysis" id="closeSmartAnalysisBtn">Ã—</button>
            </div>
            
            <!-- Analysis Tabs -->
            <div class="analysis-tabs">
                <button class="tab-button active" data-tab="overview">
                    <i class="fas fa-chart-bar"></i> Overview
                </button>
                <button class="tab-button" data-tab="explore">
                    <i class="fas fa-search"></i> Explore
                </button>
                <button class="tab-button" data-tab="filter">
                    <i class="fas fa-filter"></i> Filter
                </button>
                <button class="tab-button" data-tab="insights">
                    <i class="fas fa-lightbulb"></i> Insights
                </button>
            </div>
            
            <!-- Tab Content -->
            <div class="analysis-content" id="analysisContent">
                <!-- Overview Tab -->
                <div class="tab-content active" id="overviewTab">
                    <!-- Analysis results will be populated here -->
                </div>
                
                <!-- Explore Tab -->
                <div class="tab-content" id="exploreTab">
                    <div class="exploration-panel">
                        <!-- Data Type Tabs -->
                        <div class="explore-data-tabs" style="
                            display: flex;
                            background: var(--input-bg);
                            border-bottom: 1px solid var(--result-border);
                            padding: 0.5rem;
                            gap: 0.5rem;
                        ">
                            <button class="explore-data-tab active" data-explore-type="messages" onclick="switchExploreType('messages')" style="
                                flex: 1;
                                padding: 0.75rem 1rem;
                                background: linear-gradient(135deg, #2563eb, #4f46e5);
                                border: none;
                                color: white;
                                font-size: 0.9rem;
                                font-weight: 500;
                                cursor: pointer;
                                border-radius: 8px;
                                transition: all 0.2s ease;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                gap: 0.5rem;
                            ">
                                <i class="fas fa-comments"></i> Messages
                            </button>
                            <button class="explore-data-tab" data-explore-type="contacts" onclick="switchExploreType('contacts')" style="
                                flex: 1;
                                padding: 0.75rem 1rem;
                                background: transparent;
                                border: none;
                                color: var(--text-secondary);
                                font-size: 0.9rem;
                                font-weight: 500;
                                cursor: pointer;
                                border-radius: 8px;
                                transition: all 0.2s ease;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                gap: 0.5rem;
                            ">
                                <i class="fas fa-address-book"></i> Contacts
                            </button>
                            <button class="explore-data-tab" data-explore-type="calls" onclick="switchExploreType('calls')" style="
                                flex: 1;
                                padding: 0.75rem 1rem;
                                background: transparent;
                                border: none;
                                color: var(--text-secondary);
                                font-size: 0.9rem;
                                font-weight: 500;
                                cursor: pointer;
                                border-radius: 8px;
                                transition: all 0.2s ease;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                gap: 0.5rem;
                            ">
                                <i class="fas fa-phone"></i> Call Logs
                            </button>
                        </div>
                        <div class="exploration-results" id="explorationResults">
                            <div style="text-align: center; padding: 2rem;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--accent-color);"></i>
                                <p style="margin-top: 1rem;">Loading data...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Filter Tab -->
                <div class="tab-content" id="filterTab">
                    <div class="filter-panel">
                        <h4><i class="fas fa-filter"></i> Dynamic Filtering</h4>
                        <div class="filter-controls">
                            <div class="filter-group">
                                <label>Search Keywords:</label>
                                <input type="text" id="keywordFilter" placeholder="Enter keywords...">
                            </div>
                            <div class="filter-group">
                                <label>Contact:</label>
                                <select id="contactFilter">
                                    <option value="">All Contacts</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>File Type:</label>
                                <select id="fileTypeFilter">
                                    <option value="">All Types</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Risk Level:</label>
                                <select id="riskFilter">
                                    <option value="">All Levels</option>
                                    <option value="high">High Risk</option>
                                    <option value="medium">Medium Risk</option>
                                    <option value="low">Low Risk</option>
                                </select>
                            </div>
                        </div>
                        <div class="filter-results" id="filterResults">
                            <p>Apply filters to see results...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Insights Tab -->
                <div class="tab-content" id="insightsTab">
                    <div class="insights-panel">
                        <h4><i class="fas fa-lightbulb"></i> Interactive Insights</h4>
                        <div class="insights-controls">
                            <button class="insight-btn" id="generateInsightsBtn">
                                <i class="fas fa-sync"></i> Generate New Insights
                            </button>
                            <button class="insight-btn" id="exportInsightsBtn">
                                <i class="fas fa-download"></i> Export Insights
                            </button>
                        </div>
                        <div class="insights-results" id="insightsResults">
                            <p>Click "Generate New Insights" to analyze current data...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle-btn" id="sidebarToggleBtn" aria-label="Toggle sidebar">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="sidebarToggleIcon">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>

    <!-- Investigation Sidebar - Matching React UI -->
    <div class="investigation-sidebar" id="investigationSidebar">
        <!-- Tab Bar (Browser-style tabs) -->
        <div class="sidebar-tab-bar">
            <button class="sidebar-tab active" data-tab="history" id="historyTab">
                <i class="fas fa-history"></i>
                <span>History</span>
            </button>
            <button class="sidebar-tab" data-tab="stats" id="statsTab">
                <i class="fas fa-chart-bar"></i>
                <span>Stats</span>
            </button>
        </div>

        <!-- Smart Analysis Button -->
        <div class="sidebar-smart-analysis">
            <button class="smart-analysis-sidebar-btn" id="smartAnalysisBtn" title="Dynamic Smart Analysis">
                <i class="fas fa-brain"></i>
                <span>Smart Analysis</span>
            </button>
        </div>

        <!-- History Section -->
        <div class="sidebar-tab-content active" id="historyTabContent">
        <div class="sidebar-history">
            <div class="history-header">History</div>
            <div id="investigationHistory">
                <!-- History items will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Stats Section -->
        <div class="sidebar-tab-content" id="statsTabContent">
        <div class="sidebar-stats">
            <div class="sidebar-stats-header">Statistics</div>
            <div class="sidebar-stats-grid">
                <div class="sidebar-stat-card">
                    <div class="sidebar-stat-number" id="totalFiles">0</div>
                    <div class="sidebar-stat-label">UFDR Files</div>
                </div>
                <div class="sidebar-stat-card">
                    <div class="sidebar-stat-number" id="totalContacts">0</div>
                    <div class="sidebar-stat-label">Contacts</div>
                </div>
                <div class="sidebar-stat-card">
                    <div class="sidebar-stat-number" id="totalMessages">0</div>
                    <div class="sidebar-stat-label">Messages</div>
                </div>
                <div class="sidebar-stat-card">
                    <div class="sidebar-stat-number" id="totalCalls">0</div>
                    <div class="sidebar-stat-label">Call Logs</div>
                </div>
                <div class="sidebar-stat-card" id="imagesStatCard" style="cursor: pointer;" onclick="window.location.href='/images'">
                    <div class="sidebar-stat-number" id="totalImages">0</div>
                    <div class="sidebar-stat-label">Images</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Main Content with Sidebar -->
    <div class="main-content-with-sidebar" id="mainContentWithSidebar">
        <!-- AI Chat Assistant - Matching React UI -->
        <div class="chat-section">
            <!-- Chat Header -->
            <div class="chat-header-bar">
                <div class="chat-header-left">
                    <button class="chat-back-btn" onclick="window.history.back()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="19" y1="12" x2="5" y2="12"></line>
                            <polyline points="12 19 5 12 12 5"></polyline>
                        </svg>
                    </button>
                    <h2 class="chat-title" id="chatTitle">New Investigation</h2>
                </div>
                <button class="clear-chat-header-btn" id="clearChatBtn" title="Clear Chat">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                    Clear Chat
                </button>
            </div>
            
            <!-- Chat Container -->
            <div class="chat-container">
                <div id="chatMessages" class="chat-messages">
                    <div class="chat-message-wrapper">
                        <div class="chat-message">
                            <div class="chat-message-bubble ai">
                                Ready to investigate. What would you like to know about this case?
                            </div>
                            <div class="chat-message-timestamp" id="welcomeTimestamp"></div>
                        </div>
                    </div>
                </div>
                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <textarea id="chatInput" class="chat-input" rows="1"
                               placeholder="Message EVI SCAN..." 
                               oninput="this.style.height = ''; this.style.height = Math.min(this.scrollHeight, 200) + 'px'"></textarea>
                        <button id="chatStopBtn" class="chat-stop-btn" title="Stop generation" style="display: none;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="6" y="6" width="12" height="12" rx="2"></rect>
                            </svg>
                        </button>
                        <button id="chatSendBtn" class="chat-send-btn" title="Send">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </div>
                    <div class="chat-disclaimer">
                        AI can make mistakes. Please verify important evidence manually.
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Clear all stored data on page load to ensure fresh start
        (function clearAllDataOnLoad() {
            // Clear all localStorage items
            localStorage.removeItem('theme');
            localStorage.removeItem('investigationSessions');
            localStorage.removeItem('sidebarCollapsed');
            localStorage.removeItem('soundNotifications');
            localStorage.removeItem('selectedChime');
            localStorage.removeItem('statsVisible');
            localStorage.removeItem('ufdr_chat_history');
            
            // Clear any other potential localStorage items (comprehensive cleanup)
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key) {
                    keysToRemove.push(key);
                }
            }
            keysToRemove.forEach(key => localStorage.removeItem(key));
            
            // Clear sessionStorage as well
            sessionStorage.clear();
            
            console.log('All stored data cleared - fresh start');
        })();

        // Theme Management
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const themeIcon = document.getElementById('themeIcon');
        const htmlElement = document.documentElement;

        // Update theme icon based on current theme
        function updateThemeIcon(theme) {
            if (themeIcon) {
                if (theme === 'dark') {
                    themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />';
                } else {
                    themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />';
                }
            }
        }

        // Initialize theme from localStorage or default to dark
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            htmlElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        // Save preferences to session
        async function savePreferencesToSession() {
            const sessionId = '{{ session_id }}' || sessionStorage.getItem('session_id');
            if (!sessionId || sessionId === 'None' || sessionId === '') {
                console.warn('âš ï¸ No session_id available, cannot save preferences');
                return;
            }
            
            try {
                // Get fresh references to all elements (in case DOM changed)
                const theme = htmlElement.getAttribute('data-theme') || 'dark';
                const modelIdEl = document.getElementById('currentModelName');
                const modelId = modelIdEl ? modelIdEl.textContent : '';
                const soundToggle = document.getElementById('soundNotificationToggle');
                const chimeSelect = document.getElementById('chimeSelect');
                
                // Read sound state - use the JavaScript variable as fallback
                let soundEnabled = false;
                if (soundToggle) {
                    soundEnabled = soundToggle.checked;
                } else {
                    // Fallback to JavaScript variable if element not found
                    soundEnabled = soundNotificationsEnabled;
                    console.warn('âš ï¸ soundNotificationToggle element not found, using variable:', soundEnabled);
                }
                
                // Default chime if sound is enabled but no chime selected
                const defaultChime = 'mixkit-alert-quick-chime-766.wav';
                // Get chime value - use default if sound is enabled but no chime selected
                let soundChime = '';
                if (soundEnabled) {
                    if (chimeSelect && chimeSelect.value) {
                        soundChime = chimeSelect.value;
                    } else {
                        // Use JavaScript variable as fallback
                        soundChime = selectedChime || defaultChime;
                    }
                }
                
                const preferences = {
                    theme: theme,
                    model_id: modelId,
                    sound_enabled: soundEnabled,
                    sound_chime: soundChime
                };
                
                console.log('ðŸ’¾ Auto-saving preferences:', {
                    session_id: sessionId,
                    sound_enabled: preferences.sound_enabled,
                    sound_chime: preferences.sound_chime,
                    toggle_checked: soundToggle ? soundToggle.checked : 'N/A',
                    toggle_exists: !!soundToggle,
                    variable_value: soundNotificationsEnabled
                });
                
                const response = await fetch(`/api/sessions/${sessionId}/preferences`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(preferences)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('âœ… Preferences saved successfully:', {
                        saved_sound_enabled: result.preferences?.sound_enabled,
                        saved_sound_chime: result.preferences?.sound_chime
                    });
                } else {
                    const errorText = await response.text();
                    console.error('âŒ Failed to save preferences:', response.status, errorText);
                }
            } catch (error) {
                console.error('âŒ Error saving preferences:', error);
            }
        }

        // Toggle theme function
        function toggleTheme() {
            const currentTheme = htmlElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            htmlElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
            
            // Save to session
            savePreferencesToSession();
        }

        // Event listener for header theme toggle button
        if (themeToggleBtn) {
            themeToggleBtn.addEventListener('click', toggleTheme);
        }

        // Initialize theme on page load
        document.addEventListener('DOMContentLoaded', initializeTheme);

        // Investigation History Management
        // Start with empty sessions - localStorage was cleared on page load
        let investigationSessions = [];
        let currentSessionId = null;

        function createNewInvestigation() {
            const newSession = {
                id: Date.now().toString(),
                title: 'New Investigation',
                date: new Date().toLocaleDateString(),
                messages: []
            };
            investigationSessions.unshift(newSession);
            currentSessionId = newSession.id;
            saveSessions();
            updateHistoryDisplay();
            clearChatMessages();
            addWelcomeMessage();
        }

        function saveSessions() {
            localStorage.setItem('investigationSessions', JSON.stringify(investigationSessions));
        }

        function updateHistoryDisplay() {
            const historyContainer = document.getElementById('investigationHistory');
            if (!historyContainer) return;

            historyContainer.innerHTML = '';
            investigationSessions.forEach(session => {
                const item = document.createElement('div');
                item.className = `history-item ${session.id === currentSessionId ? 'active' : ''}`;
                item.innerHTML = `
                    <svg class="history-item-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <div class="history-item-title">${session.title}</div>
                    <button class="history-item-delete" onclick="deleteSession('${session.id}')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                `;
                item.onclick = () => switchSession(session.id);
                historyContainer.appendChild(item);
            });
        }

        function switchSession(sessionId) {
            currentSessionId = sessionId;
            saveSessions();
            updateHistoryDisplay();
            loadSessionMessages(sessionId);
        }

        function deleteSession(sessionId) {
            if (confirm('Are you sure you want to delete this investigation?')) {
                investigationSessions = investigationSessions.filter(s => s.id !== sessionId);
                if (currentSessionId === sessionId) {
                    currentSessionId = investigationSessions.length > 0 ? investigationSessions[0].id : null;
                    if (currentSessionId) {
                        loadSessionMessages(currentSessionId);
                    } else {
                        createNewInvestigation();
                    }
                }
                saveSessions();
                updateHistoryDisplay();
            }
        }

        function loadSessionMessages(sessionId) {
            const session = investigationSessions.find(s => s.id === sessionId);
            if (!session) return;

            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;
            
            chatMessages.innerHTML = '';
            
            if (session.messages.length === 0) {
                addWelcomeMessage();
            } else {
                session.messages.forEach(msg => {
                    // Use addChatMessage for consistent rendering with metadata support
                    if (typeof addChatMessage === 'function') {
                        // Extract metadata if available
                        const metadata = msg.metadata || {};
                        addChatMessage(
                            msg.text || msg.content || '',
                            msg.sender || msg.role || 'user',
                            metadata.detailedResults || null,
                            metadata.llm_used || metadata.llmUsed || false,
                            metadata.confidence || null,
                            metadata.rag_used || metadata.ragUsed || false,
                            metadata.response_time || metadata.responseTime || null,
                            metadata.image_citations || metadata.imageCitations || null,
                            metadata.has_images || metadata.hasImages || false
                        );
                    } else {
                        // Fallback to simple rendering if addChatMessage not available
                        addMessageToChat(msg.sender || msg.role || 'user', msg.text || msg.content || '', msg.timestamp);
                    }
                });
                
                // Scroll to bottom after loading
                setTimeout(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 100);
            }
        }

        function addWelcomeMessage() {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;
            
            // Check if welcome message already exists
            const existingWelcome = chatMessages.querySelector('#welcomeTimestamp');
            if (!existingWelcome) {
                // Add welcome message HTML if it doesn't exist
                const welcomeWrapper = document.createElement('div');
                welcomeWrapper.className = 'chat-message-wrapper';
                welcomeWrapper.innerHTML = `
                    <div class="chat-message">
                        <div class="chat-message-bubble ai">
                            Ready to investigate. What would you like to know about this case?
                        </div>
                        <div class="chat-message-timestamp" id="welcomeTimestamp"></div>
                    </div>
                `;
                chatMessages.appendChild(welcomeWrapper);
            }
            
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const welcomeTimestamp = document.getElementById('welcomeTimestamp');
            if (welcomeTimestamp) {
                welcomeTimestamp.textContent = timestamp;
            }
        }

        function addMessageToChat(sender, text, timestamp) {
            const chatMessages = document.getElementById('chatMessages');
            const wrapper = document.createElement('div');
            wrapper.className = `chat-message-wrapper ${sender === 'user' ? 'user-message' : ''}`;
            
            const message = document.createElement('div');
            message.className = 'chat-message';
            if (sender === 'user') message.classList.add('user-message');
            
            const bubble = document.createElement('div');
            bubble.className = `chat-message-bubble ${sender === 'ai' ? 'ai' : 'user'}`;
            bubble.textContent = text;
            
            const time = document.createElement('div');
            time.className = 'chat-message-timestamp';
            time.textContent = timestamp || new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            message.appendChild(bubble);
            message.appendChild(time);
            
            wrapper.appendChild(message);
            chatMessages.appendChild(wrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Download Report Functionality
        function downloadReport() {
            if (!currentSessionId) return;
            const session = investigationSessions.find(s => s.id === currentSessionId);
            if (!session) return;

            const reportContent = `
INVESTIGATION REPORT
Case ID: ${session.id}
Date: ${new Date().toLocaleString()}
----------------------------------------

TRANSCRIPT:
${session.messages.map(m => `[${m.timestamp || new Date().toLocaleTimeString()}] ${m.sender.toUpperCase()}: ${m.text}`).join('\n\n')}

----------------------------------------
EVIDENCE SUMMARY:
- Analyzed ${session.messages.length} interactions.
- Key findings recorded.
- Chain of custody preserved.

Generated by EVI SCAN AI
            `;

            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Investigation_Report_${session.id}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Update addChatMessage to save to session with full metadata
        const originalAddChatMessage = window.addChatMessage || function() {};
        window.addChatMessage = function(message, sender, detailedResults, llmUsed, confidence, ragUsed, responseTime, imageCitations, hasImages) {
            // Call original function
            originalAddChatMessage(message, sender, detailedResults, llmUsed, confidence, ragUsed, responseTime, imageCitations, hasImages);
            
            // Save to current session with full metadata (for consistency with restored sessions)
            if (currentSessionId) {
                const session = investigationSessions.find(s => s.id === currentSessionId);
                if (session) {
                    // Save message with metadata to match database structure
                    session.messages.push({
                        role: sender, // Use 'role' to match database format
                        sender: sender, // Keep 'sender' for backward compatibility
                        content: message, // Use 'content' to match database format
                        text: message, // Keep 'text' for backward compatibility
                        timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                        metadata: {
                            detailedResults: detailedResults || null,
                            llm_used: llmUsed || false,
                            llmUsed: llmUsed || false, // Both formats for compatibility
                            confidence: confidence || null,
                            rag_used: ragUsed || false,
                            ragUsed: ragUsed || false, // Both formats for compatibility
                            response_time: responseTime || null,
                            responseTime: responseTime || null, // Both formats for compatibility
                            image_citations: imageCitations || null,
                            imageCitations: imageCitations || null, // Both formats for compatibility
                            has_images: hasImages || false,
                            hasImages: hasImages || false // Both formats for compatibility
                        }
                    });
                    // Update title if it's the first user message
                    if (sender === 'user' && session.messages.filter(m => (m.sender === 'user' || m.role === 'user')).length === 1) {
                        session.title = message.length > 20 ? message.substring(0, 20) + '...' : message;
                        const chatTitle = document.getElementById('chatTitle');
                        if (chatTitle) {
                            chatTitle.textContent = session.title;
                        }
                    }
                    saveSessions();
                    updateHistoryDisplay();
                }
            }
        };

        // Update send button visibility based on input
        function updateSendButton() {
            const chatInput = document.getElementById('chatInput');
            const chatSendBtn = document.getElementById('chatSendBtn');
            if (chatInput && chatSendBtn) {
                if (chatInput.value.trim()) {
                    chatSendBtn.style.opacity = '1';
                    chatSendBtn.style.background = '#ab68ff';
                    chatSendBtn.style.color = 'white';
                } else {
                    chatSendBtn.style.opacity = '0.5';
                    chatSendBtn.style.background = 'var(--text-primary)';
                    chatSendBtn.style.color = 'var(--dark-bg)';
                }
            }
        }

        // Initialize investigation history
        // Sidebar Toggle Functionality
        let sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        
        function toggleSidebar() {
            const sidebar = document.getElementById('investigationSidebar');
            const mainContent = document.getElementById('mainContentWithSidebar');
            const toggleBtn = document.getElementById('sidebarToggleBtn');
            const toggleIcon = document.getElementById('sidebarToggleIcon');
            
            sidebarCollapsed = !sidebarCollapsed;
            
            if (sidebarCollapsed) {
                sidebar.classList.add('collapsed');
                mainContent.classList.add('sidebar-collapsed');
                toggleBtn.style.left = '1rem';
                // Change icon to menu when sidebar is closed
                toggleIcon.innerHTML = '<line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>';
            } else {
                sidebar.classList.remove('collapsed');
                mainContent.classList.remove('sidebar-collapsed');
                toggleBtn.style.left = '21rem';
                // Change icon to left arrow when sidebar is open
                toggleIcon.innerHTML = '<line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline>';
            }
            
            localStorage.setItem('sidebarCollapsed', sidebarCollapsed);
        }
        
        function initializeSidebar() {
            const sidebar = document.getElementById('investigationSidebar');
            const mainContent = document.getElementById('mainContentWithSidebar');
            const toggleBtn = document.getElementById('sidebarToggleBtn');
            const toggleIcon = document.getElementById('sidebarToggleIcon');
            
            if (sidebarCollapsed) {
                sidebar.classList.add('collapsed');
                mainContent.classList.add('sidebar-collapsed');
                toggleBtn.style.left = '1rem';
                toggleIcon.innerHTML = '<line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>';
            } else {
                toggleBtn.style.left = '21rem';
                toggleIcon.innerHTML = '<line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline>';
            }
            
            if (toggleBtn) {
                toggleBtn.addEventListener('click', toggleSidebar);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            initializeSidebar();
            
            // Check if we have a session_id from backend (from Case Manager)
            const backendSessionId = '{{ session_id }}' || null;
            
            if (backendSessionId && backendSessionId !== 'None' && backendSessionId !== '') {
                // Restore session from database
                try {
                    console.log('Restoring session:', backendSessionId);
                    const response = await fetch(`/api/sessions/${backendSessionId}`);
                    const sessionData = await response.json();
                    
                    console.log('ðŸ“¦ Session data received:', {
                        status: sessionData.status,
                        chat_history_count: sessionData.chat_history?.length || 0,
                        has_preferences: !!sessionData.preferences,
                        preferences: sessionData.preferences,
                        sound_enabled_raw: sessionData.preferences?.sound_enabled,
                        sound_enabled_type: typeof sessionData.preferences?.sound_enabled
                    });
                    
                    if (sessionData.status === 'SUCCESS') {
                        // Restore chat history
                        if (sessionData.chat_history && sessionData.chat_history.length > 0) {
                            console.log(`ðŸ“œ Found ${sessionData.chat_history.length} chat message(s) to restore`);
                            console.log('ðŸ“ First message:', sessionData.chat_history[0]);
                            console.log(`ðŸ“œ Restoring ${sessionData.chat_history.length} chat message(s)`);
                            
                            // Wait a bit for DOM to be ready
                            setTimeout(() => {
                                const chatMessages = document.getElementById('chatMessages');
                                if (!chatMessages) {
                                    console.error('âŒ chatMessages element not found!');
                                    return;
                                }
                                
                                // Clear existing messages
                                clearChatMessages();
                                
                                // Clear any stale investigation content
                                const chatTitle = document.getElementById('chatTitle');
                                if (chatTitle && chatTitle.textContent === 'New Investigation') {
                                    // Reset title if it's still showing default
                                    const sessionTitle = sessionData.session?.title || 'Investigation';
                                    chatTitle.textContent = sessionTitle;
                                }
                                
                                // Don't add welcome message if we have chat history
                                sessionData.chat_history.forEach((msg, index) => {
                                    const content = msg.content || '';
                                    if (!content) {
                                        console.warn(`âš ï¸ Skipping empty message at index ${index}`);
                                        return;
                                    }
                                    
                                    console.log(`   Restoring ${msg.role} message ${index + 1}/${sessionData.chat_history.length}: ${content.substring(0, 50)}...`);
                                    
                                    if (msg.role === 'user') {
                                        // Use the actual addChatMessage function
                                        if (typeof addChatMessage === 'function') {
                                            addChatMessage(content, 'user');
                                        } else {
                                            console.error('âŒ addChatMessage function not found!');
                                            // Fallback: manually add message
                                            const wrapper = document.createElement('div');
                                            wrapper.className = 'chat-message-wrapper user-message';
                                            wrapper.innerHTML = `
                                                <div class="chat-message user-message">
                                                    <div class="chat-message-bubble user">${content}</div>
                                                    <div class="chat-message-timestamp">${msg.timestamp || new Date().toLocaleTimeString()}</div>
                                                </div>
                                            `;
                                            chatMessages.appendChild(wrapper);
                                        }
                                    } else if (msg.role === 'assistant') {
                                        // Parse metadata if available
                                        let metadata = {};
                                        if (msg.metadata) {
                                            try {
                                                metadata = typeof msg.metadata === 'string' ? JSON.parse(msg.metadata) : msg.metadata;
                                            } catch (e) {
                                                console.warn('âš ï¸ Error parsing metadata:', e);
                                                metadata = {};
                                            }
                                        }
                                        
                                        // Use the actual addChatMessage function
                                        if (typeof addChatMessage === 'function') {
                                            addChatMessage(
                                                content, 
                                                'assistant',
                                                metadata.detailedResults || null, // detailedResults
                                                metadata.llm_used || metadata.llmUsed || false, // llmUsed
                                                metadata.confidence || null, // confidence
                                                metadata.rag_used || metadata.ragUsed || false, // ragUsed
                                                metadata.response_time || metadata.responseTime || null, // responseTime
                                                metadata.image_citations || metadata.imageCitations || null, // imageCitations
                                                metadata.has_images || metadata.hasImages || false // hasImages
                                            );
                                        } else {
                                            console.error('âŒ addChatMessage function not found!');
                                            // Fallback: manually add message
                                            const wrapper = document.createElement('div');
                                            wrapper.className = 'chat-message-wrapper assistant-message';
                                            wrapper.innerHTML = `
                                                <div class="chat-message assistant-message">
                                                    <div class="chat-message-bubble assistant">${content}</div>
                                                    <div class="chat-message-timestamp">${msg.timestamp || new Date().toLocaleTimeString()}</div>
                                                </div>
                                            `;
                                            chatMessages.appendChild(wrapper);
                                        }
                                    }
                                });
                                
                                // Also save restored messages to local session structure for consistency
                                if (currentSessionId) {
                                    const session = investigationSessions.find(s => s.id === currentSessionId);
                                    if (!session) {
                                        // Create session if it doesn't exist
                                        investigationSessions.push({
                                            id: currentSessionId,
                                            title: sessionData.session?.title || 'Investigation',
                                            date: new Date().toLocaleDateString(),
                                            messages: []
                                        });
                                    }
                                    const targetSession = investigationSessions.find(s => s.id === currentSessionId);
                                    if (targetSession) {
                                        // Clear and repopulate with restored messages (with metadata)
                                        targetSession.messages = sessionData.chat_history.map(msg => {
                                            const metadata = msg.metadata || {};
                                            return {
                                                role: msg.role,
                                                sender: msg.role === 'user' ? 'user' : 'ai',
                                                content: msg.content || '',
                                                text: msg.content || '', // Backward compatibility
                                                timestamp: msg.timestamp || new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                                                metadata: metadata
                                            };
                                        });
                                        saveSessions();
                                        updateHistoryDisplay();
                                        console.log('âœ… Saved restored chat history to local session structure');
                                    }
                                }
                                
                                // Scroll to bottom after restoring
                                setTimeout(() => {
                                    chatMessages.scrollTop = chatMessages.scrollHeight;
                                    console.log('âœ… Chat history restored successfully');
                                }, 100);
                            }, 100);
                        } else {
                            console.log('â„¹ï¸ No chat history found, adding welcome message');
                            // No chat history, add welcome message
                            setTimeout(() => {
                                addWelcomeMessage();
                            }, 100);
                        }
                        
                        // Restore preferences
                        if (sessionData.preferences) {
                            const prefs = sessionData.preferences;
                            
                            // Restore theme
                            if (prefs.theme) {
                                const theme = prefs.theme === 'light' ? 'light' : 'dark';
                                document.documentElement.setAttribute('data-theme', theme);
                                updateThemeIcon(theme); // Update the icon
                                const themeToggle = document.getElementById('themeToggle');
                                if (themeToggle) {
                                    themeToggle.checked = (theme === 'light');
                                }
                                localStorage.setItem('theme', theme);
                                console.log('âœ… Restored theme:', theme);
                            }
                            
                            // Restore model selection
                            if (prefs.model_id) {
                                console.log('ðŸ”„ Restoring model preference:', prefs.model_id);
                                
                                // Store the model ID to be applied after models load
                                // This ensures model restoration happens after the model list is loaded
                                sessionStorage.setItem('restored_model_id', prefs.model_id);
                                
                                // Wait a bit for sidebar to be ready
                                setTimeout(() => {
                                    const modelDropdown = document.getElementById('modelDropdown');
                                    const currentModelName = document.getElementById('currentModelName');
                                    
                                    if (modelDropdown) {
                                        modelDropdown.textContent = prefs.model_id;
                                    }
                                    
                                    // Update current model display immediately (will be updated again when models load)
                                    if (currentModelName) {
                                        currentModelName.textContent = prefs.model_id;
                                        console.log('âœ… Restored model_id (temporary):', prefs.model_id);
                                    } else {
                                        console.warn('âš ï¸ currentModelName element not found during restoration (sidebar may not be ready yet)');
                                    }
                                    
                                    // Try to load models if not already loaded, which will trigger the restoration
                                    // This ensures models are loaded and then the restored model is applied
                                    if (typeof loadAvailableModels === 'function') {
                                        loadAvailableModels();
                                    }
                                }, 100);
                            }
                            
                            // Restore sound settings (with delay to ensure DOM is ready)
                            setTimeout(() => {
                                const soundToggle = document.getElementById('soundNotificationToggle');
                                const chimeSelect = document.getElementById('chimeSelect');
                                
                                console.log('ðŸ” Sound restoration debug:', {
                                    'prefs.sound_enabled': prefs.sound_enabled,
                                    'type': typeof prefs.sound_enabled,
                                    'is_1': prefs.sound_enabled === 1,
                                    'is_true': prefs.sound_enabled === true,
                                    'is_undefined': prefs.sound_enabled === undefined,
                                    'is_null': prefs.sound_enabled === null,
                                    'toggle_exists': !!soundToggle
                                });
                                
                                if (prefs.sound_enabled !== undefined && prefs.sound_enabled !== null) {
                                    if (soundToggle) {
                                        // Handle multiple possible formats: 1, true, "1", "true", etc.
                                        let soundEnabled = false;
                                        if (prefs.sound_enabled === 1 || prefs.sound_enabled === true) {
                                            soundEnabled = true;
                                        } else if (typeof prefs.sound_enabled === 'string') {
                                            soundEnabled = prefs.sound_enabled.toLowerCase() === 'true' || prefs.sound_enabled === '1';
                                        } else if (typeof prefs.sound_enabled === 'number') {
                                            soundEnabled = prefs.sound_enabled !== 0;
                                        }
                                        
                                        soundToggle.checked = soundEnabled;
                                        soundNotificationsEnabled = soundEnabled;
                                        localStorage.setItem('soundNotifications', soundNotificationsEnabled.toString());
                                        console.log('âœ… Restored sound_enabled:', soundNotificationsEnabled, '(from raw value:', prefs.sound_enabled, ')');
                                    } else {
                                        console.error('âŒ soundNotificationToggle element not found during restoration!');
                                    }
                                } else {
                                    console.warn('âš ï¸ sound_enabled is undefined or null in preferences, using default (false)');
                                }
                                
                                // Restore chime (use default if sound is enabled but no chime was saved)
                                const defaultChime = 'mixkit-alert-quick-chime-766.wav';
                                const soundIsEnabled = prefs.sound_enabled === 1 || prefs.sound_enabled === true;
                                const chimeToUse = prefs.sound_chime || (soundIsEnabled ? defaultChime : '');
                                
                                if (chimeToUse && chimeSelect) {
                                    chimeSelect.value = chimeToUse;
                                    selectedChime = chimeToUse;
                                    localStorage.setItem('selectedChime', selectedChime);
                                    console.log('âœ… Restored sound_chime:', selectedChime);
                                } else if (soundIsEnabled && chimeSelect) {
                                    // Sound is enabled but no chime saved - use default
                                    chimeSelect.value = defaultChime;
                                    selectedChime = defaultChime;
                                    localStorage.setItem('selectedChime', selectedChime);
                                    console.log('âœ… Using default chime (sound enabled but no chime was saved):', defaultChime);
                                }
                            }, 200);
                        }
                        
                        // Store session_id for future use
                        currentSessionId = backendSessionId;
                        sessionStorage.setItem('session_id', backendSessionId);
                        
                        console.log('Session restored successfully');
                    } else {
                        console.error('Failed to restore session:', sessionData.message);
                        // Fall back to creating new investigation
                        if (investigationSessions.length === 0) {
                            createNewInvestigation();
                        }
                    }
                } catch (error) {
                    console.error('Error restoring session:', error);
                    // Fall back to creating new investigation
                    if (investigationSessions.length === 0) {
                        createNewInvestigation();
                    }
                }
            } else {
                // No backend session, use local investigation sessions
            if (investigationSessions.length === 0) {
                createNewInvestigation();
            } else {
                updateHistoryDisplay();
                if (currentSessionId) {
                    loadSessionMessages(currentSessionId);
                    }
                }
            }

            // Tab switching functionality
            setupSidebarTabs();
            
            // Clear chat button
            const clearChatBtn = document.getElementById('clearChatBtn');
            if (clearChatBtn) {
                clearChatBtn.addEventListener('click', clearChatOnly);
            }
            
            // Update send button on input
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('input', updateSendButton);
                chatInput.addEventListener('keyup', updateSendButton);
            }
            
            // Update welcome message timestamp (only if no chat history was restored)
            if (!backendSessionId || backendSessionId === 'None' || backendSessionId === '') {
            addWelcomeMessage();
            }
            updateSendButton();
        });

        function clearChatMessages() {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                chatMessages.innerHTML = '';
            }
        }

        // Sound Notification Management
        const soundNotificationToggle = document.getElementById('soundNotificationToggle');
        const chimeSelect = document.getElementById('chimeSelect');
        const testSoundBtn = document.getElementById('testSoundBtn');
        let soundNotificationsEnabled = false;
        let selectedChime = 'mixkit-alert-quick-chime-766.wav';

        function initializeSoundNotifications() {
            // Check if we have a session - if so, don't initialize from localStorage
            // (session restoration will handle it)
            const backendSessionId = '{{ session_id }}' || null;
            const hasSession = backendSessionId && backendSessionId !== 'None' && backendSessionId !== '';
            
            if (hasSession) {
                // Session will be restored, so don't initialize from localStorage yet
                // Just set defaults but don't override
                console.log('â³ Session detected - skipping localStorage initialization (will be restored from database)');
                return;
            }
            
            // No session - initialize from localStorage
            const savedSoundSetting = localStorage.getItem('soundNotifications') === 'true';
            const savedChime = localStorage.getItem('selectedChime') || 'mixkit-alert-quick-chime-766.wav';
            
            soundNotificationsEnabled = savedSoundSetting;
            selectedChime = savedChime;
            
            if (soundNotificationToggle) {
            soundNotificationToggle.checked = savedSoundSetting;
            }
            if (chimeSelect) {
            chimeSelect.value = savedChime;
            }
        }

        function toggleSoundNotifications() {
            // Get fresh reference to toggle (in case DOM changed)
            const toggle = document.getElementById('soundNotificationToggle');
            if (toggle) {
                soundNotificationsEnabled = toggle.checked;
            localStorage.setItem('soundNotifications', soundNotificationsEnabled.toString());
                console.log('ðŸ”” Sound notifications toggled:', soundNotificationsEnabled);
                // Save to session database immediately
                savePreferencesToSession();
            } else {
                console.error('âŒ soundNotificationToggle element not found!');
            }
        }

        function updateSelectedChime() {
            selectedChime = chimeSelect.value;
            localStorage.setItem('selectedChime', selectedChime);
            // Save to session database
            savePreferencesToSession();
        }

        function playCompletionSound() {
            if (!soundNotificationsEnabled) return;
            
            // Play the selected chime sound
            const audio = new Audio(`/chimes/${selectedChime}`);
            audio.volume = 0.7; // Set volume to 70%
            audio.play().catch(error => {
                console.log('Could not play sound:', error);
                // Fallback to Web Audio API if file fails
                playFallbackSound();
            });
        }

        function playFallbackSound() {
            // Fallback sound using Web Audio API
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        function testSelectedSound() {
            const audio = new Audio(`/chimes/${selectedChime}`);
            audio.volume = 0.7;
            audio.play().catch(error => {
                console.log('Could not play test sound:', error);
                playFallbackSound();
            });
        }

        // Initialize sound notifications on page load
        // Initialize sound notifications (but skip if we have a session - restoration will handle it)
        document.addEventListener('DOMContentLoaded', function() {
            initializeSoundNotifications();

            // Add event listeners (always set these up)
            if (soundNotificationToggle) {
        soundNotificationToggle.addEventListener('change', toggleSoundNotifications);
            }
            if (chimeSelect) {
        chimeSelect.addEventListener('change', updateSelectedChime);
            }
            if (testSoundBtn) {
        testSoundBtn.addEventListener('click', testSelectedSound);
            }
        });

        // Smart Analysis Functions
        let currentAnalysisData = null;
        let currentExplorationData = null;

        async function showSmartAnalysis() {
            const panel = document.getElementById('smartAnalysisPanel');
            const overviewContent = document.getElementById('overviewTab');
            
            if (!panel || !overviewContent) {
                console.error('Smart Analysis panel elements not found');
                return;
            }
            
            // Show panel
            panel.style.display = 'flex';
            panel.style.pointerEvents = 'auto';
            setTimeout(() => {
                panel.classList.add('active');
            }, 10);
            document.body.style.overflow = 'hidden';
            
            // Show loading state
            overviewContent.innerHTML = `
                <div class="analysis-section">
                    <h4><i class="fas fa-spinner fa-spin"></i> Analyzing Data...</h4>
                    <p>Performing intelligent analysis of uploaded UFDR data...</p>
                </div>
            `;
            
            // Switch to overview tab
            switchTab('overview');
            
            try {
                // First check if data is available by checking stats
                const statsResponse = await fetch('/api/stats');
                const statsData = await statsResponse.json();
                const hasData = statsData && (
                    (statsData.total_contacts && statsData.total_contacts > 0) ||
                    (statsData.total_messages && statsData.total_messages > 0) ||
                    (statsData.total_calls && statsData.total_calls > 0) ||
                    (statsData.total_files && statsData.total_files > 0)
                );
                
                if (!hasData) {
                    overviewContent.innerHTML = `
                        <div class="analysis-section">
                            <h4><i class="fas fa-info-circle"></i> No Data Available</h4>
                            <p>No UFDR data is currently loaded. Please upload a UFDR file first to perform analysis.</p>
                            <p style="margin-top: 1rem; color: var(--text-secondary); font-size: 0.875rem;">
                                <i class="fas fa-lightbulb"></i> Tip: Use the "Upload UFDR" button in the header to upload your forensic data.
                            </p>
                        </div>
                    `;
                    return;
                }
                
                // Perform analysis
                const response = await fetch('/api/smart-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                console.log('Smart Analysis Response:', result);
                
                if (result.status === 'SUCCESS') {
                    currentAnalysisData = result.analysis;
                    if (result.analysis.exploration_data) {
                        currentExplorationData = result.analysis.exploration_data;
                    }
                    displayAnalysisResults(result.analysis);
                } else {
                    overviewContent.innerHTML = `
                        <div class="analysis-section">
                            <h4><i class="fas fa-exclamation-triangle"></i> Analysis Failed</h4>
                            <p>${result.message || 'Unable to perform analysis. Please ensure UFDR data is uploaded.'}</p>
                            ${result.message && result.message.includes('No UFDR data') ? `
                                <p style="margin-top: 1rem; color: var(--text-secondary); font-size: 0.875rem;">
                                    <i class="fas fa-lightbulb"></i> If you just restored a session, the data should be available. Try refreshing the page.
                                </p>
                            ` : ''}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Smart Analysis error:', error);
                overviewContent.innerHTML = `
                    <div class="analysis-section">
                        <h4><i class="fas fa-exclamation-triangle"></i> Error</h4>
                        <p>Failed to perform analysis: ${error.message}</p>
                        <p style="margin-top: 1rem; color: var(--text-secondary); font-size: 0.875rem;">
                            Please ensure UFDR data is uploaded and try again.
                        </p>
                    </div>
                `;
            }
        }

        function hideSmartAnalysis() {
            const panel = document.getElementById('smartAnalysisPanel');
            if (panel) {
                panel.classList.remove('active');
                panel.style.pointerEvents = 'none';
                setTimeout(() => {
                    panel.style.display = 'none';
                }, 300);
                document.body.style.overflow = '';
            }
        }

        function switchTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            const tabBtn = document.querySelector(`[data-tab="${tabName}"]`);
            const tabContent = document.getElementById(`${tabName}Tab`);
            
            if (tabBtn) tabBtn.classList.add('active');
            if (tabContent) tabContent.classList.add('active');
            
            // Auto-load messages when Explore tab is opened
            if (tabName === 'explore') {
                loadExploreData();
            }
        }
        
        async function loadExploreData() {
            const resultsDiv = document.getElementById('explorationResults');
            if (!resultsDiv) return;
            
            // Show loading
            resultsDiv.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--accent-color);"></i>
                    <p style="margin-top: 1rem;">Loading data...</p>
                </div>
            `;
            
            try {
                const response = await fetch('/api/explore-data');
                const result = await response.json();
                
                if (result.status === 'SUCCESS') {
                    currentExplorationData = result.data;
                    window.explorationData = result.data;
                    window.explorationMessages = result.data.messages || [];
                    window.explorationContacts = result.data.contacts || [];
                    window.explorationCalls = result.data.calls || [];
                    
                    // Update tab counts
                    const messagesTab = document.querySelector('[data-explore-type="messages"]');
                    const contactsTab = document.querySelector('[data-explore-type="contacts"]');
                    const callsTab = document.querySelector('[data-explore-type="calls"]');
                    
                    if (messagesTab) {
                        messagesTab.innerHTML = `<i class="fas fa-comments"></i> Messages (${window.explorationMessages.length})`;
                    }
                    if (contactsTab) {
                        contactsTab.innerHTML = `<i class="fas fa-address-book"></i> Contacts (${window.explorationContacts.length})`;
                    }
                    if (callsTab) {
                        callsTab.innerHTML = `<i class="fas fa-phone"></i> Call Logs (${window.explorationCalls.length})`;
                    }
                    
                    // Display messages by default
                    displayAllMessages(result.data);
                } else {
                    resultsDiv.innerHTML = `
                        <div class="analysis-section">
                            <h4><i class="fas fa-exclamation-triangle"></i> Error</h4>
                            <p>${result.message || 'Failed to load data'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading exploration data:', error);
                resultsDiv.innerHTML = `
                    <div class="analysis-section">
                        <h4><i class="fas fa-exclamation-triangle"></i> Error</h4>
                        <p>Failed to load data: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function switchExploreType(type) {
            // Update tab buttons
            document.querySelectorAll('.explore-data-tab').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'transparent';
                btn.style.color = 'var(--text-secondary)';
            });
            
            const activeBtn = document.querySelector(`[data-explore-type="${type}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.style.background = 'linear-gradient(135deg, #2563eb, #4f46e5)';
                activeBtn.style.color = 'white';
            }
            
            // Display the selected type
            if (!window.explorationData) {
                loadExploreData();
                return;
            }
            
            if (type === 'messages') {
                displayAllMessages(window.explorationData);
            } else if (type === 'contacts') {
                displayContacts();
            } else if (type === 'calls') {
                displayCalls();
            }
        }
        
        function displayAllMessages(data) {
            const resultsDiv = document.getElementById('explorationResults');
            if (!resultsDiv) return;
            
            const messages = data.messages || [];
            
            let html = `
                <div style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; padding: 1rem 0;">
                    <i class="fas fa-comments" style="color: #3b82f6; font-size: 1.25rem;"></i>
                    <h4 style="color: var(--text-primary); margin: 0; font-size: 1.1rem; font-weight: 600;">
                        Messages (${messages.length} items)
                    </h4>
                </div>
                <div class="messages-list" style="
                    max-height: calc(85vh - 320px);
                    overflow-y: auto;
                    padding-right: 0.5rem;
                    scrollbar-width: thin;
                    scrollbar-color: rgba(59, 130, 246, 0.3) transparent;
                ">
            `;
            
            if (messages.length === 0) {
                html += `
                    <div class="analysis-section" style="text-align: center; padding: 2rem;">
                        <p style="color: var(--text-secondary);">No messages found in the uploaded data.</p>
                    </div>
                `;
            } else {
                messages.forEach((message, index) => {
                    const text = message.text || message.content || '';
                    html += `
                        <div class="message-item" style="
                            background: rgba(30, 58, 138, 0.15);
                            border: 1px solid rgba(59, 130, 246, 0.25);
                            border-radius: 8px;
                            padding: 1rem;
                            margin-bottom: 0.75rem;
                            cursor: pointer;
                            transition: all 0.2s ease;
                        " 
                        onmouseover="this.style.background='rgba(30, 58, 138, 0.25)'; this.style.borderColor='rgba(59, 130, 246, 0.5)'; this.style.transform='translateX(2px)';"
                        onmouseout="this.style.background='rgba(30, 58, 138, 0.15)'; this.style.borderColor='rgba(59, 130, 246, 0.25)'; this.style.transform='translateX(0)';"
                        onclick="insertMessageIntoChat(${index})">
                            <div style="margin-bottom: 0.75rem; font-size: 0.875rem; line-height: 1.6;">
                                <span style="color: var(--text-secondary);">From:</span> 
                                <span style="color: var(--text-primary); font-weight: 500;">${escapeHtml(message.from || 'Unknown')}</span>
                                <span style="color: var(--text-secondary); margin-left: 1rem;">To:</span> 
                                <span style="color: var(--text-primary); font-weight: 500;">${escapeHtml(message.to || 'Unknown')}</span>
                            </div>
                            <div style="color: var(--text-primary); margin-bottom: 0.75rem; line-height: 1.6; font-size: 0.95rem;">
                                ${escapeHtml(text)}
                            </div>
                            ${message.timestamp ? `
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                    ${escapeHtml(message.timestamp)}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            
            resultsDiv.innerHTML = html;
            
            // Store messages globally for chat insertion
            window.explorationMessages = messages;
        }
        
        function displayContacts() {
            const contacts = window.explorationContacts || [];
            const resultsDiv = document.getElementById('explorationResults');
            if (!resultsDiv) return;
            
            let html = `
                <div style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; padding: 1rem 0;">
                    <i class="fas fa-address-book" style="color: #3b82f6; font-size: 1.25rem;"></i>
                    <h4 style="color: var(--text-primary); margin: 0; font-size: 1.1rem; font-weight: 600;">
                        Contacts (${contacts.length} items)
                    </h4>
                </div>
                <div class="contacts-list" style="
                    max-height: calc(85vh - 320px);
                    overflow-y: auto;
                    padding-right: 0.5rem;
                    scrollbar-width: thin;
                    scrollbar-color: rgba(59, 130, 246, 0.3) transparent;
                ">
            `;
            
            if (contacts.length === 0) {
                html += `
                    <div class="analysis-section" style="text-align: center; padding: 2rem;">
                        <p style="color: var(--text-secondary);">No contacts found.</p>
                    </div>
                `;
            } else {
                contacts.forEach((contact, index) => {
                    html += `
                        <div class="analysis-item" style="
                            background: rgba(30, 58, 138, 0.15);
                            border: 1px solid rgba(59, 130, 246, 0.25);
                            border-radius: 8px;
                            padding: 1rem;
                            margin-bottom: 0.75rem;
                            cursor: pointer;
                            transition: all 0.2s ease;
                        " 
                        onmouseover="this.style.background='rgba(30, 58, 138, 0.25)'; this.style.borderColor='rgba(59, 130, 246, 0.5)'; this.style.transform='translateX(2px)';"
                        onmouseout="this.style.background='rgba(30, 58, 138, 0.15)'; this.style.borderColor='rgba(59, 130, 246, 0.25)'; this.style.transform='translateX(0)';"
                        onclick="insertContactIntoChat(${index})">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="color: var(--text-primary);">${escapeHtml(contact.name || 'Unknown')}</strong>
                                    ${contact.phone ? `<div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;">${escapeHtml(contact.phone)}</div>` : ''}
                                    ${contact.email ? `<div style="font-size: 0.875rem; color: var(--text-secondary);">${escapeHtml(contact.email)}</div>` : ''}
                                </div>
                                <i class="fas fa-chevron-right" style="color: var(--text-secondary);"></i>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            
            resultsDiv.innerHTML = html;
        }
        
        function displayCalls() {
            const calls = window.explorationCalls || [];
            const resultsDiv = document.getElementById('explorationResults');
            if (!resultsDiv) return;
            
            let html = `
                <div style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; padding: 1rem 0;">
                    <i class="fas fa-phone" style="color: #3b82f6; font-size: 1.25rem;"></i>
                    <h4 style="color: var(--text-primary); margin: 0; font-size: 1.1rem; font-weight: 600;">
                        Call Logs (${calls.length} items)
                    </h4>
                </div>
                <div class="calls-list" style="
                    max-height: calc(85vh - 320px);
                    overflow-y: auto;
                    padding-right: 0.5rem;
                    scrollbar-width: thin;
                    scrollbar-color: rgba(59, 130, 246, 0.3) transparent;
                ">
            `;
            
            if (calls.length === 0) {
                html += `
                    <div class="analysis-section" style="text-align: center; padding: 2rem;">
                        <p style="color: var(--text-secondary);">No calls found.</p>
                    </div>
                `;
            } else {
                calls.forEach((call, index) => {
                    const duration = call.duration ? `${call.duration}s` : 'Unknown';
                    html += `
                        <div class="analysis-item" style="
                            background: rgba(30, 58, 138, 0.15);
                            border: 1px solid rgba(59, 130, 246, 0.25);
                            border-radius: 8px;
                            padding: 1rem;
                            margin-bottom: 0.75rem;
                            cursor: pointer;
                            transition: all 0.2s ease;
                        " 
                        onmouseover="this.style.background='rgba(30, 58, 138, 0.25)'; this.style.borderColor='rgba(59, 130, 246, 0.5)'; this.style.transform='translateX(2px)';"
                        onmouseout="this.style.background='rgba(30, 58, 138, 0.15)'; this.style.borderColor='rgba(59, 130, 246, 0.25)'; this.style.transform='translateX(0)';"
                        onclick="insertCallIntoChat(${index})">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="color: var(--text-primary);">${escapeHtml(call.from || 'Unknown')}</strong>
                                    <span style="margin: 0 0.5rem;">â†’</span>
                                    <strong style="color: var(--text-primary);">${escapeHtml(call.to || 'Unknown')}</strong>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                        Duration: ${duration} | Direction: ${call.direction || 'unknown'}
                                        ${call.timestamp ? ` | ${escapeHtml(call.timestamp)}` : ''}
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right" style="color: var(--text-secondary);"></i>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            
            resultsDiv.innerHTML = html;
        }
        
        function insertMessageIntoChat(index) {
            if (!window.explorationMessages || index >= window.explorationMessages.length) return;
            
            const message = window.explorationMessages[index];
            const chatInput = document.getElementById('chatInput');
            
            if (!chatInput) return;
            
            // Format the message for insertion
            const messageText = `[Selected Message Context]
From: ${message.from || 'Unknown'}
To: ${message.to || 'Unknown'}
Timestamp: ${message.timestamp || 'Unknown'}
Message: "${message.text || message.content || ''}"

Please analyze this message and answer my questions about it.`;
            
            chatInput.value = messageText;
            chatInput.focus();
            
            // Trigger input event to update send button
            chatInput.dispatchEvent(new Event('input', { bubbles: true }));
            
            // Close the smart analysis panel
            hideSmartAnalysis();
            
            // Scroll to chat input
            chatInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        function insertContactIntoChat(index) {
            if (!window.explorationContacts || index >= window.explorationContacts.length) return;
            
            const contact = window.explorationContacts[index];
            const chatInput = document.getElementById('chatInput');
            
            if (!chatInput) return;
            
            const contactText = `[Selected Contact Context]
Name: ${contact.name || 'Unknown'}
Phone: ${contact.phone || 'N/A'}
Email: ${contact.email || 'N/A'}

Please analyze this contact and answer my questions about them.`;
            
            chatInput.value = contactText;
            chatInput.focus();
            chatInput.dispatchEvent(new Event('input', { bubbles: true }));
            hideSmartAnalysis();
            chatInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        function insertCallIntoChat(index) {
            if (!window.explorationCalls || index >= window.explorationCalls.length) return;
            
            const call = window.explorationCalls[index];
            const chatInput = document.getElementById('chatInput');
            
            if (!chatInput) return;
            
            const callText = `[Selected Call Context]
From: ${call.from || 'Unknown'}
To: ${call.to || 'Unknown'}
Duration: ${call.duration || 'Unknown'}s
Direction: ${call.direction || 'unknown'}
Timestamp: ${call.timestamp || 'Unknown'}

Please analyze this call and answer my questions about it.`;
            
            chatInput.value = callText;
            chatInput.focus();
            chatInput.dispatchEvent(new Event('input', { bubbles: true }));
            hideSmartAnalysis();
            chatInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function exploreData(type) {
            const resultsDiv = document.getElementById('explorationResults');
            if (!resultsDiv) {
                console.error('Exploration results div not found');
                return;
            }
            
            if (!currentExplorationData && !currentAnalysisData) {
                resultsDiv.innerHTML = `
                    <div class="analysis-section">
                        <h4><i class="fas fa-info-circle"></i> No Data Available</h4>
                        <p>Please run Smart Analysis first to explore data.</p>
                    </div>
                `;
                return;
            }
            
            // Show loading
            resultsDiv.innerHTML = `<p><i class="fas fa-spinner fa-spin"></i> Loading ${type}...</p>`;
            
            // Get exploration data from current analysis
            const explorationData = currentExplorationData || (currentAnalysisData && currentAnalysisData.exploration_data) || {};
            
            let html = '';
            const items = explorationData[type] || [];
            
            if (items.length === 0) {
                html = `
                    <div class="analysis-section">
                        <h4><i class="fas fa-info-circle"></i> No ${type} Found</h4>
                        <p>No ${type} data available in the uploaded UFDR files.</p>
                    </div>
                `;
            } else {
                html = `<h4 style="margin-bottom: 1rem; color: var(--accent-color);">
                    <i class="fas fa-${type === 'contacts' ? 'address-book' : type === 'messages' ? 'comments' : type === 'calls' ? 'phone' : 'file'}"></i> 
                    ${type.charAt(0).toUpperCase() + type.slice(1)} (${items.length} items)
                </h4>`;
                
                // Display items based on type
                if (type === 'contacts') {
                    html += '<div style="display: grid; gap: 0.75rem;">';
                    items.slice(0, 50).forEach((contact, index) => {
                        html += `
                            <div class="analysis-item" style="cursor: pointer;" onclick="showItemDetails('contact', ${index}, '${type}')">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${escapeHtml(contact.name || 'Unknown')}</strong>
                                        ${contact.phone ? `<div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;">${escapeHtml(contact.phone)}</div>` : ''}
                                        ${contact.email ? `<div style="font-size: 0.875rem; color: var(--text-secondary);">${escapeHtml(contact.email)}</div>` : ''}
                                    </div>
                                    <i class="fas fa-chevron-right" style="color: var(--text-secondary);"></i>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    if (items.length > 50) {
                        html += `<p style="margin-top: 1rem; color: var(--text-secondary); font-size: 0.875rem;">Showing first 50 of ${items.length} contacts</p>`;
                    }
                } else if (type === 'messages') {
                    html += '<div style="display: grid; gap: 0.75rem; max-height: 500px; overflow-y: auto;">';
                    items.slice(0, 100).forEach((message, index) => {
                        const text = message.text || message.content || '';
                        const snippet = text.length > 100 ? text.substring(0, 100) + '...' : text;
                        
                        // Use resolved names if available, otherwise use phone numbers
                        const fromDisplay = message.from_name && message.from_name !== 'Unknown' 
                            ? `${escapeHtml(message.from_name)} (${escapeHtml(message.from || 'Unknown')})`
                            : escapeHtml(message.from || 'Unknown');
                        const toDisplay = message.to_name && message.to_name !== 'Unknown'
                            ? `${escapeHtml(message.to_name)} (${escapeHtml(message.to || 'Unknown')})`
                            : escapeHtml(message.to || 'Unknown');
                        
                        html += `
                            <div class="analysis-item" style="cursor: pointer;" onclick="showItemDetails('message', ${index}, '${type}')">
                                <div style="margin-bottom: 0.5rem;">
                                    <strong>From:</strong> ${fromDisplay} 
                                    <strong style="margin-left: 1rem;">To:</strong> ${toDisplay}
                                </div>
                                <div style="color: var(--text-primary); margin-bottom: 0.5rem;">${escapeHtml(snippet)}</div>
                                ${message.timestamp ? `<div style="font-size: 0.75rem; color: var(--text-secondary);">${escapeHtml(message.timestamp)}</div>` : ''}
                            </div>
                        `;
                    });
                    html += '</div>';
                    if (items.length > 100) {
                        html += `<p style="margin-top: 1rem; color: var(--text-secondary); font-size: 0.875rem;">Showing first 100 of ${items.length} messages</p>`;
                    }
                } else if (type === 'calls') {
                    html += '<div style="display: grid; gap: 0.75rem;">';
                    items.slice(0, 50).forEach((call, index) => {
                        const duration = call.duration ? `${call.duration}s` : 'Unknown';
                        
                        // Use resolved names if available, otherwise use phone numbers
                        const fromDisplay = call.from_name && call.from_name !== 'Unknown'
                            ? `${escapeHtml(call.from_name)} (${escapeHtml(call.from || 'Unknown')})`
                            : escapeHtml(call.from || 'Unknown');
                        const toDisplay = call.to_name && call.to_name !== 'Unknown'
                            ? `${escapeHtml(call.to_name)} (${escapeHtml(call.to || 'Unknown')})`
                            : escapeHtml(call.to || 'Unknown');
                        
                        html += `
                            <div class="analysis-item" style="cursor: pointer;" onclick="showItemDetails('call', ${index}, '${type}')">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${fromDisplay}</strong> â†’ 
                                        <strong>${toDisplay}</strong>
                                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                            Duration: ${duration} | Direction: ${call.direction || 'unknown'}
                                            ${call.timestamp ? ` | ${escapeHtml(call.timestamp)}` : ''}
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-right" style="color: var(--text-secondary);"></i>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    if (items.length > 50) {
                        html += `<p style="margin-top: 1rem; color: var(--text-secondary); font-size: 0.875rem;">Showing first 50 of ${items.length} calls</p>`;
                    }
                } else if (type === 'files') {
                    html += '<div style="display: grid; gap: 0.75rem;">';
                    items.slice(0, 50).forEach((file, index) => {
                        const sizeMB = file.size_bytes ? (file.size_bytes / (1024 * 1024)).toFixed(2) + ' MB' : 'Unknown size';
                        html += `
                            <div class="analysis-item" style="cursor: pointer;" onclick="showItemDetails('file', ${index}, '${type}')">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${escapeHtml(file.filename || 'Unknown')}</strong>
                                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                            Type: ${file.file_type || 'unknown'} | Size: ${sizeMB}
                                            ${file.sensitive ? ' | <span style="color: #ef4444;">âš ï¸ Sensitive</span>' : ''}
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-right" style="color: var(--text-secondary);"></i>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    if (items.length > 50) {
                        html += `<p style="margin-top: 1rem; color: var(--text-secondary); font-size: 0.875rem;">Showing first 50 of ${items.length} files</p>`;
                    }
                }
            }
            
            resultsDiv.innerHTML = html;
        }

        function showItemDetails(type, index, dataType) {
            if (!currentExplorationData && !currentAnalysisData) return;
            
            const explorationData = currentExplorationData || (currentAnalysisData && currentAnalysisData.exploration_data) || {};
            const items = explorationData[dataType] || [];
            
            if (index >= items.length) return;
            
            const item = items[index];
            let details = '';
            
            if (type === 'contact') {
                details = `
                    <h4>Contact Details</h4>
                    <p><strong>Name:</strong> ${escapeHtml(item.name || 'Unknown')}</p>
                    ${item.phone ? `<p><strong>Phone:</strong> ${escapeHtml(item.phone)}</p>` : ''}
                    ${item.email ? `<p><strong>Email:</strong> ${escapeHtml(item.email)}</p>` : ''}
                    ${item.source_file ? `<p><strong>Source File:</strong> ${escapeHtml(item.source_file)}</p>` : ''}
                `;
            } else if (type === 'message') {
                details = `
                    <h4>Message Details</h4>
                    <p><strong>From:</strong> ${escapeHtml(item.from || 'Unknown')}</p>
                    <p><strong>To:</strong> ${escapeHtml(item.to || 'Unknown')}</p>
                    <p><strong>Content:</strong></p>
                    <div style="background: var(--file-bg); padding: 1rem; border-radius: 8px; margin-top: 0.5rem;">
                        ${escapeHtml(item.text || item.content || 'No content')}
                    </div>
                    ${item.timestamp ? `<p style="margin-top: 0.5rem;"><strong>Timestamp:</strong> ${escapeHtml(item.timestamp)}</p>` : ''}
                    ${item.source_file ? `<p><strong>Source File:</strong> ${escapeHtml(item.source_file)}</p>` : ''}
                `;
            } else if (type === 'call') {
                details = `
                    <h4>Call Details</h4>
                    <p><strong>From:</strong> ${escapeHtml(item.from || 'Unknown')}</p>
                    <p><strong>To:</strong> ${escapeHtml(item.to || 'Unknown')}</p>
                    <p><strong>Duration:</strong> ${item.duration ? item.duration + ' seconds' : 'Unknown'}</p>
                    <p><strong>Direction:</strong> ${item.direction || 'unknown'}</p>
                    ${item.timestamp ? `<p><strong>Timestamp:</strong> ${escapeHtml(item.timestamp)}</p>` : ''}
                    ${item.source_file ? `<p><strong>Source File:</strong> ${escapeHtml(item.source_file)}</p>` : ''}
                `;
            } else if (type === 'file') {
                const sizeMB = item.size_bytes ? (item.size_bytes / (1024 * 1024)).toFixed(2) + ' MB' : 'Unknown size';
                details = `
                    <h4>File Details</h4>
                    <p><strong>Filename:</strong> ${escapeHtml(item.filename || 'Unknown')}</p>
                    <p><strong>Type:</strong> ${item.file_type || 'unknown'}</p>
                    <p><strong>Size:</strong> ${sizeMB}</p>
                    ${item.sensitive ? '<p><strong>Status:</strong> <span style="color: #ef4444;">âš ï¸ Sensitive File</span></p>' : ''}
                    ${item.source_file ? `<p><strong>Source File:</strong> ${escapeHtml(item.source_file)}</p>` : ''}
                `;
            }
            
            // Show in a modal or alert (simple alert for now)
            alert(details);
        }

        function setupFilterControls() {
            const keywordFilter = document.getElementById('keywordFilter');
            const contactFilter = document.getElementById('contactFilter');
            const fileTypeFilter = document.getElementById('fileTypeFilter');
            const riskFilter = document.getElementById('riskFilter');
            
            // Populate filter options when analysis data is available
            if (currentAnalysisData) {
                populateFilterOptions();
            }
            
            // Add event listeners for filter changes
            if (keywordFilter) {
                keywordFilter.addEventListener('input', debounce(applyDynamicFilter, 500));
            }
            if (contactFilter) {
                contactFilter.addEventListener('change', applyDynamicFilter);
            }
            if (fileTypeFilter) {
                fileTypeFilter.addEventListener('change', applyDynamicFilter);
            }
            if (riskFilter) {
                riskFilter.addEventListener('change', applyDynamicFilter);
            }
        }

        function populateFilterOptions() {
            if (!currentAnalysisData) return;
            
            const filterOptions = currentAnalysisData.filter_options || {};
            const contactFilter = document.getElementById('contactFilter');
            const fileTypeFilter = document.getElementById('fileTypeFilter');
            
            // Populate contact filter
            if (contactFilter && filterOptions.contact_names) {
                const currentValue = contactFilter.value;
                contactFilter.innerHTML = '<option value="">All Contacts</option>';
                filterOptions.contact_names.slice(0, 50).forEach(contact => {
                    const option = document.createElement('option');
                    option.value = contact;
                    option.textContent = contact;
                    contactFilter.appendChild(option);
                });
                if (currentValue) {
                    contactFilter.value = currentValue;
                }
            }
            
            // Populate file type filter
            if (fileTypeFilter && filterOptions.file_types) {
                const currentValue = fileTypeFilter.value;
                fileTypeFilter.innerHTML = '<option value="">All Types</option>';
                filterOptions.file_types.forEach(fileType => {
                    const option = document.createElement('option');
                    option.value = fileType;
                    option.textContent = `.${fileType}`;
                    fileTypeFilter.appendChild(option);
                });
                if (currentValue) {
                    fileTypeFilter.value = currentValue;
                }
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function applyDynamicFilter() {
            const resultsDiv = document.getElementById('filterResults');
            if (!resultsDiv) {
                console.error('Filter results div not found');
                return;
            }
            
            if (!currentExplorationData && !currentAnalysisData) {
                resultsDiv.innerHTML = `
                    <div class="analysis-section">
                        <h4><i class="fas fa-info-circle"></i> No Data Available</h4>
                        <p>Please run Smart Analysis first to apply filters.</p>
                    </div>
                `;
                return;
            }
            
            // Get filter values
            const keywordFilter = document.getElementById('keywordFilter');
            const contactFilter = document.getElementById('contactFilter');
            const fileTypeFilter = document.getElementById('fileTypeFilter');
            const riskFilter = document.getElementById('riskFilter');
            
            const keyword = keywordFilter ? keywordFilter.value.toLowerCase().trim() : '';
            const contact = contactFilter ? contactFilter.value : '';
            const fileType = fileTypeFilter ? fileTypeFilter.value : '';
            const riskLevel = riskFilter ? riskFilter.value : '';
            
            // Get exploration data
            const explorationData = currentExplorationData || (currentAnalysisData && currentAnalysisData.exploration_data) || {};
            
            // Get suspicious activities for risk filtering
            const suspiciousActivities = currentAnalysisData && currentAnalysisData.suspicious_activity || [];
            
            // Show loading
            resultsDiv.innerHTML = `<p><i class="fas fa-spinner fa-spin"></i> Filtering data...</p>`;
            
            // Apply filters
            let filteredResults = {
                messages: [],
                contacts: [],
                calls: [],
                files: [],
                suspicious: []
            };
            
            // Filter messages
            if (explorationData.messages) {
                filteredResults.messages = explorationData.messages.filter(msg => {
                    const text = (msg.text || msg.content || '').toLowerCase();
                    const from = (msg.from || '').toLowerCase();
                    const to = (msg.to || '').toLowerCase();
                    
                    const matchesKeyword = !keyword || text.includes(keyword) || from.includes(keyword) || to.includes(keyword);
                    const matchesContact = !contact || from.includes(contact.toLowerCase()) || to.includes(contact.toLowerCase());
                    
                    return matchesKeyword && matchesContact;
                });
            }
            
            // Filter contacts
            if (explorationData.contacts) {
                filteredResults.contacts = explorationData.contacts.filter(contact_item => {
                    const name = (contact_item.name || '').toLowerCase();
                    const phone = (contact_item.phone || '').toLowerCase();
                    const email = (contact_item.email || '').toLowerCase();
                    
                    const matchesKeyword = !keyword || name.includes(keyword) || phone.includes(keyword) || email.includes(keyword);
                    const matchesContact = !contact || name.includes(contact.toLowerCase()) || phone.includes(contact.toLowerCase());
                    
                    return matchesKeyword && matchesContact;
                });
            }
            
            // Filter calls
            if (explorationData.calls) {
                filteredResults.calls = explorationData.calls.filter(call => {
                    const from = (call.from || '').toLowerCase();
                    const to = (call.to || '').toLowerCase();
                    
                    const matchesKeyword = !keyword || from.includes(keyword) || to.includes(keyword);
                    const matchesContact = !contact || from.includes(contact.toLowerCase()) || to.includes(contact.toLowerCase());
                    
                    return matchesKeyword && matchesContact;
                });
            }
            
            // Filter files
            if (explorationData.files) {
                filteredResults.files = explorationData.files.filter(file => {
                    const filename = (file.filename || '').toLowerCase();
                    const fileTypeMatch = !fileType || filename.endsWith(`.${fileType.toLowerCase()}`);
                    const keywordMatch = !keyword || filename.includes(keyword);
                    
                    return fileTypeMatch && keywordMatch;
                });
            }
            
            // Filter suspicious activities by risk level
            if (riskLevel && suspiciousActivities.length > 0) {
                filteredResults.suspicious = suspiciousActivities.filter(activity => {
                    const severity = (activity.severity || 'LOW').toUpperCase();
                    return severity === riskLevel.toUpperCase();
                });
            } else if (!riskLevel) {
                filteredResults.suspicious = suspiciousActivities;
            }
            
            // Display filtered results
            displayFilterResults(filteredResults, keyword, contact, fileType, riskLevel);
        }

        function displayFilterResults(results, keyword, contact, fileType, riskLevel) {
            const resultsDiv = document.getElementById('filterResults');
            if (!resultsDiv) return;
            
            let html = '<h4 style="margin-bottom: 1rem; color: var(--accent-color);"><i class="fas fa-filter"></i> Filter Results</h4>';
            
            // Show active filters
            const activeFilters = [];
            if (keyword) activeFilters.push(`Keywords: "${keyword}"`);
            if (contact) activeFilters.push(`Contact: ${contact}`);
            if (fileType) activeFilters.push(`File Type: .${fileType}`);
            if (riskLevel) activeFilters.push(`Risk Level: ${riskLevel.toUpperCase()}`);
            
            if (activeFilters.length > 0) {
                html += `<div style="margin-bottom: 1rem; padding: 0.75rem; background: var(--file-bg); border-radius: 8px; font-size: 0.875rem;">
                    <strong>Active Filters:</strong> ${activeFilters.join(' â€¢ ')}
                </div>`;
            }
            
            // Display results by category
            const totalResults = results.messages.length + results.contacts.length + results.calls.length + results.files.length + results.suspicious.length;
            
            if (totalResults === 0) {
                html += `
                    <div class="analysis-section">
                        <h4><i class="fas fa-info-circle"></i> No Results</h4>
                        <p>No items match the current filter criteria. Try adjusting your filters.</p>
                    </div>
                `;
            } else {
                // Messages
                if (results.messages.length > 0) {
                    html += `<div style="margin-bottom: 1.5rem;">
                        <h5 style="color: var(--accent-color); margin-bottom: 0.75rem;">
                            <i class="fas fa-comments"></i> Messages (${results.messages.length})
                        </h5>
                        <div style="display: grid; gap: 0.75rem; max-height: 300px; overflow-y: auto;">`;
                    results.messages.slice(0, 20).forEach((msg, index) => {
                        const text = msg.text || msg.content || '';
                        const snippet = text.length > 80 ? text.substring(0, 80) + '...' : text;
                        html += `
                            <div class="analysis-item">
                                <div><strong>${escapeHtml(msg.from || 'Unknown')}</strong> â†’ <strong>${escapeHtml(msg.to || 'Unknown')}</strong></div>
                                <div style="font-size: 0.875rem; color: var(--text-primary); margin-top: 0.25rem;">${escapeHtml(snippet)}</div>
                                ${msg.timestamp ? `<div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">${escapeHtml(msg.timestamp)}</div>` : ''}
                            </div>
                        `;
                    });
                    html += '</div>';
                    if (results.messages.length > 20) {
                        html += `<p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">Showing first 20 of ${results.messages.length} messages</p>`;
                    }
                    html += '</div>';
                }
                
                // Contacts
                if (results.contacts.length > 0) {
                    html += `<div style="margin-bottom: 1.5rem;">
                        <h5 style="color: var(--accent-color); margin-bottom: 0.75rem;">
                            <i class="fas fa-address-book"></i> Contacts (${results.contacts.length})
                        </h5>
                        <div style="display: grid; gap: 0.75rem;">`;
                    results.contacts.slice(0, 20).forEach(contact_item => {
                        html += `
                            <div class="analysis-item">
                                <div><strong>${escapeHtml(contact_item.name || 'Unknown')}</strong></div>
                                ${contact_item.phone ? `<div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;">${escapeHtml(contact_item.phone)}</div>` : ''}
                                ${contact_item.email ? `<div style="font-size: 0.875rem; color: var(--text-secondary);">${escapeHtml(contact_item.email)}</div>` : ''}
                            </div>
                        `;
                    });
                    html += '</div>';
                    if (results.contacts.length > 20) {
                        html += `<p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">Showing first 20 of ${results.contacts.length} contacts</p>`;
                    }
                    html += '</div>';
                }
                
                // Calls
                if (results.calls.length > 0) {
                    html += `<div style="margin-bottom: 1.5rem;">
                        <h5 style="color: var(--accent-color); margin-bottom: 0.75rem;">
                            <i class="fas fa-phone"></i> Calls (${results.calls.length})
                        </h5>
                        <div style="display: grid; gap: 0.75rem;">`;
                    results.calls.slice(0, 20).forEach(call => {
                        const duration = call.duration ? `${call.duration}s` : 'Unknown';
                        html += `
                            <div class="analysis-item">
                                <div><strong>${escapeHtml(call.from || 'Unknown')}</strong> â†’ <strong>${escapeHtml(call.to || 'Unknown')}</strong></div>
                                <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                    Duration: ${duration} | Direction: ${call.direction || 'unknown'}
                                    ${call.timestamp ? ` | ${escapeHtml(call.timestamp)}` : ''}
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    if (results.calls.length > 20) {
                        html += `<p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">Showing first 20 of ${results.calls.length} calls</p>`;
                    }
                    html += '</div>';
                }
                
                // Files
                if (results.files.length > 0) {
                    html += `<div style="margin-bottom: 1.5rem;">
                        <h5 style="color: var(--accent-color); margin-bottom: 0.75rem;">
                            <i class="fas fa-file"></i> Files (${results.files.length})
                        </h5>
                        <div style="display: grid; gap: 0.75rem;">`;
                    results.files.slice(0, 20).forEach(file => {
                        const sizeMB = file.size_bytes ? (file.size_bytes / (1024 * 1024)).toFixed(2) + ' MB' : 'Unknown size';
                        html += `
                            <div class="analysis-item">
                                <div><strong>${escapeHtml(file.filename || 'Unknown')}</strong></div>
                                <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                    Type: ${file.file_type || 'unknown'} | Size: ${sizeMB}
                                    ${file.sensitive ? ' | <span style="color: #ef4444;">âš ï¸ Sensitive</span>' : ''}
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    if (results.files.length > 20) {
                        html += `<p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">Showing first 20 of ${results.files.length} files</p>`;
                    }
                    html += '</div>';
                }
                
                // Suspicious Activities
                if (results.suspicious.length > 0) {
                    html += `<div style="margin-bottom: 1.5rem;">
                        <h5 style="color: var(--accent-color); margin-bottom: 0.75rem;">
                            <i class="fas fa-exclamation-triangle"></i> Suspicious Activities (${results.suspicious.length})
                        </h5>
                        <div style="display: grid; gap: 0.75rem;">`;
                    results.suspicious.slice(0, 20).forEach(activity => {
                        const severity = activity.severity || 'LOW';
                        const severityColor = severity === 'HIGH' ? '#ef4444' : severity === 'MEDIUM' ? '#f59e0b' : '#6b7280';
                        html += `
                            <div class="analysis-item" style="border-left: 3px solid ${severityColor};">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                            <span style="color: ${severityColor}; font-weight: 600;">${severity}</span>
                                            <span style="font-size: 0.875rem; color: var(--text-secondary);">${activity.type || 'suspicious_activity'}</span>
                                        </div>
                                        <div style="color: var(--text-primary);">${escapeHtml(activity.message || 'Suspicious activity detected')}</div>
                                        ${activity.snippet ? `<div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem; font-style: italic;">${escapeHtml(activity.snippet)}</div>` : ''}
                                        ${activity.timestamp ? `<div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">${escapeHtml(activity.timestamp)}</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    if (results.suspicious.length > 20) {
                        html += `<p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">Showing first 20 of ${results.suspicious.length} suspicious activities</p>`;
                    }
                    html += '</div>';
                }
            }
            
            resultsDiv.innerHTML = html;
        }

        function displayAnalysisResults(analysis) {
            console.log('Displaying analysis results:', analysis);
            currentAnalysisData = analysis;
            currentExplorationData = analysis.exploration_data;
            
            // Populate filter options after analysis
            populateFilterOptions();
            
            const overviewContent = document.getElementById('overviewTab');
            if (!overviewContent) return;
            
            let html = '';
            
            // Report Header
            html += `
                <div class="analysis-section">
                    <h4><i class="fas fa-file-alt"></i> ${analysis.report_type || 'Dynamic Analysis Report'}</h4>
                    <div class="analysis-item">
                        <p><strong>Generated:</strong> ${analysis.generated_at || new Date().toLocaleString()}</p>
                        <p><strong>Status:</strong> ${analysis.analysis_complete ? 'âœ… Complete' : 'âŒ Failed'}</p>
                    </div>
                </div>
            `;
            
            // Summary Section
            if (analysis.summary) {
                html += `
                    <div class="analysis-section">
                        <h4><i class="fas fa-info-circle"></i> Executive Summary</h4>
                        <div class="analysis-item">
                            <p>${analysis.summary}</p>
                        </div>
                    </div>
                `;
            }
            
            // Key Findings
            if (analysis.key_findings && analysis.key_findings.length > 0) {
                html += `
                    <div class="analysis-section">
                        <h4><i class="fas fa-search"></i> Key Findings</h4>
                        <div class="analysis-item">
                            ${analysis.key_findings.map(finding => `<p>â€¢ ${finding}</p>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Security Assessment
            if (analysis.security_assessment) {
                const assessment = analysis.security_assessment;
                html += `
                    <div class="analysis-section">
                        <h4><i class="fas fa-shield-alt"></i> Security Assessment</h4>
                        <div class="analysis-item">
                            <h5>Risk Level: <span style="color: ${assessment.risk_level === 'HIGH' ? '#ff4444' : assessment.risk_level === 'MEDIUM' ? '#ffaa00' : '#00ff88'}">${assessment.risk_level}</span></h5>
                            <p><strong>Assessment:</strong> ${assessment.assessment}</p>
                            ${assessment.suspicious_activities ? `<p><strong>Suspicious Activities:</strong> ${assessment.suspicious_activities}</p>` : ''}
                            ${assessment.sensitive_files ? `<p><strong>Sensitive Files:</strong> ${assessment.sensitive_files}</p>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Data Statistics
            if (analysis.data_statistics) {
                const stats = analysis.data_statistics;
                html += `
                    <div class="analysis-section">
                        <h4><i class="fas fa-chart-bar"></i> Data Statistics</h4>
                        <div class="analysis-item">
                            ${stats.total_files ? `<p><strong>Total Files:</strong> ${stats.total_files}</p>` : ''}
                            ${stats.total_contacts ? `<p><strong>Total Contacts:</strong> ${stats.total_contacts}</p>` : ''}
                            ${stats.total_messages ? `<p><strong>Total Messages:</strong> ${stats.total_messages}</p>` : ''}
                            ${stats.total_calls ? `<p><strong>Total Calls:</strong> ${stats.total_calls}</p>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Recommendations
            if (analysis.recommendations && analysis.recommendations.length > 0) {
                html += `
                    <div class="analysis-section">
                        <h4><i class="fas fa-lightbulb"></i> Recommendations</h4>
                        ${analysis.recommendations.map(rec => {
                            let className = 'recommendation';
                            if (rec.includes('âš ï¸') || rec.includes('immediate')) {
                                className += ' warning';
                            } else if (rec.includes('âœ…')) {
                                className += ' success';
                            }
                            return `<div class="${className}"><p>${rec}</p></div>`;
                        }).join('')}
                    </div>
                `;
            }
            
            overviewContent.innerHTML = html || '<p>No analysis data available.</p>';
        }

        // Sidebar Management
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsSidebar = document.getElementById('settingsSidebar');
        const sidebarClose = document.getElementById('sidebarClose');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        // Open sidebar
        function openSidebar() {
            settingsSidebar.classList.add('open');
            sidebarOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Reload models when sidebar opens (in case LM Studio wasn't running initially)
            setTimeout(() => {
                loadAvailableModels();
            }, 200);
        }

        // Close sidebar
        function closeSidebar() {
            settingsSidebar.classList.remove('open');
            sidebarOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Event listeners
        settingsBtn.addEventListener('click', openSidebar);
        sidebarClose.addEventListener('click', closeSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);

        // Close sidebar on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && settingsSidebar.classList.contains('open')) {
                closeSidebar();
            }
        });

        // Manage Cases Button & Exit Session Button - Quit Session (Initialize after DOM is ready)
        document.addEventListener('DOMContentLoaded', function() {
            const manageCasesBtn = document.getElementById('manageCasesBtn');
            const exitSessionBtn = document.getElementById('exitSessionBtn');
            const quitSessionModal = document.getElementById('quitSessionModal');
            const cancelQuitBtn = document.getElementById('cancelQuitBtn');
            const confirmQuitBtn = document.getElementById('confirmQuitBtn');

            function openQuitModal() {
                if (quitSessionModal) {
                    quitSessionModal.style.display = 'flex';
                    setTimeout(() => {
                        quitSessionModal.classList.add('active');
                    }, 10);
                    document.body.style.overflow = 'hidden';
                }
            }

            function closeQuitModal() {
                if (quitSessionModal) {
                    quitSessionModal.classList.remove('active');
                    setTimeout(() => {
                        quitSessionModal.style.display = 'none';
                    }, 300);
                    document.body.style.overflow = '';
                }
            }

            // Function to open quit modal (shared by both buttons)
            function triggerQuitModal() {
                // Close settings sidebar first if open
                if (typeof closeSidebar === 'function') {
                    closeSidebar();
                }
                // Show quit session confirmation modal
                setTimeout(() => {
                    openQuitModal();
                }, 300);
            }

            if (manageCasesBtn) {
                manageCasesBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Manage Cases button clicked');
                    triggerQuitModal();
                });
            } else {
                console.error('Manage Cases button not found');
            }

            // Exit Session button in header
            if (exitSessionBtn) {
                exitSessionBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Exit Session button clicked');
                    triggerQuitModal();
                });
            } else {
                console.error('Exit Session button not found');
            }

            // Quit Session Modal handlers
            if (cancelQuitBtn) {
                cancelQuitBtn.addEventListener('click', closeQuitModal);
            }

            if (confirmQuitBtn) {
                confirmQuitBtn.addEventListener('click', async function() {
                    // All session data is already being saved automatically via session persistence
                    // Chat history, preferences, queries, and uploaded files are all persisted
                    // Just ensure we save current preferences state
                    const currentSessionId = '{{ session_id }}' || sessionStorage.getItem('session_id');
                    
                    if (currentSessionId && currentSessionId !== 'None' && currentSessionId !== '') {
                        try {
                            // Save ALL current preferences before quitting (theme, model, sound settings)
                            const theme = document.documentElement.getAttribute('data-theme') || 'dark';
                            const modelId = document.getElementById('currentModelName')?.textContent || '';
                            const soundToggle = document.getElementById('soundNotificationToggle');
                            const chimeSelect = document.getElementById('chimeSelect');
                            
                            // Default chime if sound is enabled but no chime selected
                            const defaultChime = 'mixkit-alert-quick-chime-766.wav';
                            const soundEnabled = soundToggle ? soundToggle.checked : false;
                            // Get chime value - use default if sound is enabled but no chime selected
                            let soundChime = '';
                            if (soundEnabled) {
                                soundChime = (chimeSelect && chimeSelect.value) ? chimeSelect.value : defaultChime;
                            }
                            
                            const preferences = {
                                theme: theme,
                                model_id: modelId,
                                sound_enabled: soundEnabled,
                                sound_chime: soundChime
                            };
                            
                            console.log('ðŸ’¾ Saving all preferences before quitting:', {
                                theme: preferences.theme,
                                model_id: preferences.model_id,
                                sound_enabled: preferences.sound_enabled,
                                sound_chime: preferences.sound_chime,
                                toggle_checked: soundToggle ? soundToggle.checked : 'N/A',
                                chime_value: chimeSelect ? chimeSelect.value : 'N/A'
                            });
                            
                            // Save preferences via API
                            await fetch(`/api/sessions/${currentSessionId}/preferences`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(preferences)
                            }).then(response => {
                                if (response.ok) {
                                    console.log('âœ… All preferences saved successfully before quitting');
                                } else {
                                    console.warn('âš ï¸ Could not save preferences:', response.status);
                                }
                            }).catch(err => {
                                console.warn('âš ï¸ Error saving preferences:', err);
                            });
                        } catch (error) {
                            console.log('Session data already saved');
                        }
                    }

                    // Close modal and redirect to case manager
                    closeQuitModal();
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 300);
                });
            }

            // Close quit session modal when clicking outside
            if (quitSessionModal) {
                quitSessionModal.addEventListener('click', function(e) {
                    if (e.target === quitSessionModal) {
                        closeQuitModal();
                    }
                });
            }

            // Close modal on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && quitSessionModal && quitSessionModal.classList.contains('active')) {
                    closeQuitModal();
                }
            });
        });

        // Function to check if data is available and update Smart Analysis button state
        async function updateSmartAnalysisButtonState() {
            const smartAnalysisBtn = document.getElementById('smartAnalysisBtn');
            if (!smartAnalysisBtn) return;
            
            try {
                const statsResponse = await fetch('/api/stats');
                const statsData = await statsResponse.json();
                const hasData = statsData && (
                    (statsData.total_contacts && statsData.total_contacts > 0) ||
                    (statsData.total_messages && statsData.total_messages > 0) ||
                    (statsData.total_calls && statsData.total_calls > 0) ||
                    (statsData.total_files && statsData.total_files > 0)
                );
                
                if (hasData) {
                    smartAnalysisBtn.disabled = false;
                    smartAnalysisBtn.style.opacity = '1';
                    smartAnalysisBtn.style.cursor = 'pointer';
                    smartAnalysisBtn.title = 'Dynamic Smart Analysis - Click to analyze uploaded UFDR data';
                } else {
                    smartAnalysisBtn.disabled = true;
                    smartAnalysisBtn.style.opacity = '0.6';
                    smartAnalysisBtn.style.cursor = 'not-allowed';
                    smartAnalysisBtn.title = 'Smart Analysis - Upload UFDR data first';
                }
            } catch (error) {
                console.error('Error checking data availability:', error);
                // On error, allow button to be clicked (it will show error message)
                smartAnalysisBtn.disabled = false;
                smartAnalysisBtn.style.opacity = '1';
            }
        }

        // Smart Analysis Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            const smartAnalysisBtn = document.getElementById('smartAnalysisBtn');
            const closeSmartAnalysisBtn = document.getElementById('closeSmartAnalysisBtn');
            const smartAnalysisPanel = document.getElementById('smartAnalysisPanel');
            
            // Check data availability and update button state
            updateSmartAnalysisButtonState();
            
            // Re-check after files are loaded (for restored sessions)
            setTimeout(() => {
                updateSmartAnalysisButtonState();
            }, 1000);
            
            // Tab switching
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tab = this.getAttribute('data-tab');
                    if (tab) switchTab(tab);
                });
            });
            
            // Open Smart Analysis
            if (smartAnalysisBtn) {
                smartAnalysisBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (!this.disabled) {
                        showSmartAnalysis();
                    } else {
                        // Show notification if button is disabled
                        if (typeof showNotification === 'function') {
                            showNotification('Please upload UFDR data first to use Smart Analysis', 'warning');
                        }
                    }
                });
            }
            
            // Close Smart Analysis
            if (closeSmartAnalysisBtn) {
                closeSmartAnalysisBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    hideSmartAnalysis();
                });
            }
            
            // Close on overlay click
            if (smartAnalysisPanel) {
                smartAnalysisPanel.addEventListener('click', function(e) {
                    if (e.target === smartAnalysisPanel) {
                        hideSmartAnalysis();
                    }
                });
            }
            
            // Explore buttons
            document.querySelectorAll('.explore-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const exploreType = this.getAttribute('data-explore');
                    if (exploreType) {
                        exploreData(exploreType);
                    }
                });
            });
            
            // Filter functionality
            setupFilterControls();
        });

        // Format Button Functionality
        const formatButtons = document.querySelectorAll('.format-btn');
        let selectedFormat = 'json'; // Default format

        formatButtons.forEach(button => {
            button.addEventListener('click', function() {
                const format = this.dataset.format;
                
                // Export chat content directly in the selected format
                exportChat(format);
            });
        });
        
        // PDF Export Functionality
        const pdfExportBtn = document.getElementById('pdfExportBtn');
        if (pdfExportBtn) {
            pdfExportBtn.addEventListener('click', async function() {
                const pdfType = 'full'; // Always export full report
                
                // Disable button and show loading
                pdfExportBtn.disabled = true;
                const originalText = pdfExportBtn.innerHTML;
                pdfExportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Generating PDF...</span>';
                
                try {
                    // Get chat history from DOM to send with request
                    const chatMessages = document.getElementById('chatMessages');
                    let chatHistoryData = [];
                    
                    if (chatMessages) {
                        const messages = Array.from(chatMessages.children).slice(1); // Skip initial message
                        messages.forEach((message) => {
                            const isAI = message.classList.contains('ai-message');
                            const content = message.querySelector('.message-content');
                            const timestamp = message.querySelector('.message-timestamp');
                            
                            if (content) {
                                const messageText = content.textContent.trim();
                                if (messageText) {
                                    chatHistoryData.push({
                                        role: isAI ? 'assistant' : 'user',
                                        content: messageText,
                                        timestamp: timestamp ? timestamp.textContent : new Date().toISOString()
                                    });
                                }
                            }
                        });
                    }
                    
                    console.log(`Sending ${chatHistoryData.length} chat messages for PDF export`);
                    
                    const response = await fetch('/api/export/pdf', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            type: pdfType,
                            chat_history: chatHistoryData
                        })
                    });
                    
                    // Check if response is actually a PDF
                    const contentType = response.headers.get('Content-Type');
                    if (!response.ok) {
                        // Try to get error message
                        try {
                            const errorData = await response.json();
                            showNotification(errorData.message || 'Failed to generate PDF', 'error');
                        } catch (e) {
                            showNotification('Failed to generate PDF. Please try again.', 'error');
                        }
                        return;
                    }
                    
                    // Verify it's a PDF
                    if (contentType && contentType.includes('application/pdf')) {
                        // Get the PDF blob
                        const blob = await response.blob();
                        
                        // Verify blob is not empty and is actually a PDF
                        if (blob.size === 0) {
                            showNotification('PDF file is empty. Please try again.', 'error');
                            return;
                        }
                        
                        // Check if blob starts with PDF magic bytes
                        const blobStart = await blob.slice(0, 4).text();
                        if (!blobStart.startsWith('%PDF')) {
                            showNotification('Invalid PDF file generated. Please try again.', 'error');
                            return;
                        }
                        
                        // Create download
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.style.display = 'none';
                        
                        // Get filename from Content-Disposition header or use default
                        const contentDisposition = response.headers.get('Content-Disposition');
                        let filename = `Forensic_Report_${new Date().toISOString().split('T')[0]}.pdf`;
                        if (contentDisposition) {
                            const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                            if (filenameMatch && filenameMatch[1]) {
                                filename = filenameMatch[1].replace(/['"]/g, '');
                            }
                        }
                        
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        
                        // Clean up
                        setTimeout(() => {
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        }, 100);
                        
                        showNotification('PDF report generated successfully!', 'success');
                    } else {
                        // Not a PDF, might be an error JSON
                        const errorData = await response.json();
                        showNotification(errorData.message || 'Failed to generate PDF', 'error');
                    }
                } catch (error) {
                    console.error('Error exporting PDF:', error);
                    showNotification('Error generating PDF. Please check the console for details.', 'error');
                } finally {
                    // Re-enable button
                    pdfExportBtn.disabled = false;
                    pdfExportBtn.innerHTML = originalText;
                }
            });
        }

        function getCurrentDataForExport() {
            // This would typically get data from your application state
            // For now, we'll use a placeholder that gets the uploaded files
            return uploadedFiles.length > 0 ? uploadedFiles : null;
        }

        function exportAsJSON(data) {
            const jsonString = JSON.stringify(data, null, 2);
            downloadFile(jsonString, 'forensic-analysis.json', 'application/json');
            showNotification('Results exported as JSON successfully!', 'success');
        }

        function exportAsXML(data) {
            let xmlString = '<?xml version="1.0" encoding="UTF-8"?>\n';
            xmlString += '<forensic-analysis>\n';
            
            // Convert data to XML format
            Object.keys(data).forEach(key => {
                xmlString += `  <${key}>\n`;
                if (typeof data[key] === 'object') {
                    xmlString += `    ${JSON.stringify(data[key], null, 2).replace(/</g, '&lt;').replace(/>/g, '&gt;')}\n`;
                } else {
                    xmlString += `    ${data[key]}\n`;
                }
                xmlString += `  </${key}>\n`;
            });
            
            xmlString += '</forensic-analysis>';
            downloadFile(xmlString, 'forensic-analysis.xml', 'application/xml');
            showNotification('Results exported as XML successfully!', 'success');
        }

        function exportAsTXT(data) {
            let txtString = 'FORENSIC ANALYSIS REPORT\n';
            txtString += '========================\n\n';
            
            // Convert data to readable text format
            Object.keys(data).forEach(key => {
                txtString += `${key.toUpperCase()}:\n`;
                txtString += '-'.repeat(key.length + 1) + '\n';
                
                if (typeof data[key] === 'object') {
                    txtString += JSON.stringify(data[key], null, 2) + '\n\n';
                } else {
                    txtString += data[key] + '\n\n';
                }
            });
            
            downloadFile(txtString, 'forensic-analysis.txt', 'text/plain');
            showNotification('Results exported as TXT successfully!', 'success');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
                max-width: 300px;
                word-wrap: break-word;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Global variables
        let uploadedFiles = [];

        // DOM elements
        const fileInput = document.getElementById('fileInput');
        const uploadDropzone = document.getElementById('uploadDropzone');
        const clearUploadsBtn = document.getElementById('clearUploadsBtn');
        const uploadedFilesContainer = document.getElementById('uploadedFilesContainer');

        // Format structured LLM responses
        function formatStructuredResponse(message) {
            let formatted = message;
            let hasSections = false;
            let isFirstSection = true;
            
            // Format markdown-style headers (e.g., **SECURITY CONCERNS:**, **EVIDENCE PATTERNS:**)
            formatted = formatted.replace(/\*\*(SECURITY CONCERNS|EVIDENCE PATTERNS|INVESTIGATION FINDINGS|RECOMMENDATIONS|ANALYSIS SUMMARY|KEY FINDINGS|SUSPICIOUS INDICATORS|PATTERNS DETECTED):\*\*/gi, 
                (match, sectionName) => {
                    hasSections = true;
                    const sectionHtml = isFirstSection 
                        ? `<div class="analysis-section"><h4 class="section-header"><strong>${sectionName.toUpperCase()}</strong></h4><div class="section-content">`
                        : `</div></div><div class="analysis-section"><h4 class="section-header"><strong>${sectionName.toUpperCase()}</strong></h4><div class="section-content">`;
                    isFirstSection = false;
                    return sectionHtml;
                });
            
            // Check if message contains structured format indicators (enhanced forensic sections)
            if (message.includes('ðŸ”') || message.includes('ðŸ“Š') || message.includes('âš ï¸') || message.includes('ðŸ“ˆ') || message.includes('ðŸ’¡') || message.includes('ðŸ“‹') || message.includes('â±ï¸') || message.includes('ðŸ”—') || message.includes('ðŸ”¬')) {
                hasSections = true;
                
                // Format new comprehensive forensic sections
                formatted = formatted.replace(/ðŸ” EXECUTIVE SUMMARY:/gi, '<div class="analysis-section"><h4 class="section-header executive-summary-header"><i class="fas fa-file-alt"></i> EXECUTIVE SUMMARY</h4><div class="section-content">');
                formatted = formatted.replace(/ðŸ“‹ EVIDENCE DISCOVERED:/gi, '</div></div><div class="analysis-section"><h4 class="section-header evidence-header"><i class="fas fa-fingerprint"></i> EVIDENCE DISCOVERED</h4><div class="section-content">');
                formatted = formatted.replace(/â±ï¸ TIMELINE ANALYSIS:/gi, '</div></div><div class="analysis-section"><h4 class="section-header timeline-header"><i class="fas fa-clock"></i> TIMELINE ANALYSIS</h4><div class="section-content">');
                formatted = formatted.replace(/ðŸ”— RELATIONSHIP MAPPING:/gi, '</div></div><div class="analysis-section"><h4 class="section-header relationship-header"><i class="fas fa-project-diagram"></i> RELATIONSHIP MAPPING</h4><div class="section-content">');
                formatted = formatted.replace(/âš ï¸ SECURITY CONCERNS & ANOMALIES:/gi, '</div></div><div class="analysis-section"><h4 class="section-header security-header"><i class="fas fa-shield-alt"></i> SECURITY CONCERNS & ANOMALIES</h4><div class="section-content">');
                formatted = formatted.replace(/ðŸ“Š PATTERN ANALYSIS:/gi, '</div></div><div class="analysis-section"><h4 class="section-header pattern-header"><i class="fas fa-chart-line"></i> PATTERN ANALYSIS</h4><div class="section-content">');
                formatted = formatted.replace(/ðŸ’¡ INVESTIGATIVE RECOMMENDATIONS:/gi, '</div></div><div class="analysis-section"><h4 class="section-header recommendation-header"><i class="fas fa-lightbulb"></i> INVESTIGATIVE RECOMMENDATIONS</h4><div class="section-content">');
                formatted = formatted.replace(/ðŸ”¬ EVIDENCE INTEGRITY:/gi, '</div></div><div class="analysis-section"><h4 class="section-header integrity-header"><i class="fas fa-certificate"></i> EVIDENCE INTEGRITY</h4><div class="section-content">');
                
                // Legacy section formatting for backward compatibility
                formatted = formatted.replace(/ðŸ” ANALYSIS SUMMARY:/g, '<div class="analysis-section"><h4 class="section-header analysis-header"><i class="fas fa-search"></i> ANALYSIS SUMMARY</h4><div class="section-content">');
                formatted = formatted.replace(/ðŸ“Š KEY FINDINGS:/g, '</div></div><div class="analysis-section"><h4 class="section-header findings-header"><i class="fas fa-chart-bar"></i> KEY FINDINGS</h4><div class="section-content">');
                formatted = formatted.replace(/âš ï¸ SUSPICIOUS INDICATORS:/g, '</div></div><div class="analysis-section"><h4 class="section-header warning-header"><i class="fas fa-exclamation-triangle"></i> SUSPICIOUS INDICATORS</h4><div class="section-content">');
                formatted = formatted.replace(/ðŸ“ˆ PATTERNS DETECTED:/g, '</div></div><div class="analysis-section"><h4 class="section-header pattern-header"><i class="fas fa-chart-line"></i> PATTERNS DETECTED</h4><div class="section-content">');
                formatted = formatted.replace(/ðŸ’¡ RECOMMENDATIONS:/g, '</div></div><div class="analysis-section"><h4 class="section-header recommendation-header"><i class="fas fa-lightbulb"></i> RECOMMENDATIONS</h4><div class="section-content">');
                
                // Format evidence analysis sections
                formatted = formatted.replace(/ðŸ” EVIDENCE ANALYSIS:/g, '<div class="analysis-section"><h4 class="section-header analysis-header"><i class="fas fa-search"></i> EVIDENCE ANALYSIS</h4><div class="section-content">');
                formatted = formatted.replace(/ðŸ“‹ KEY DETAILS:/g, '</div></div><div class="analysis-section"><h4 class="section-header details-header"><i class="fas fa-clipboard-list"></i> KEY DETAILS</h4><div class="section-content">');
                formatted = formatted.replace(/âš ï¸ NOTABLE FINDINGS:/g, '</div></div><div class="analysis-section"><h4 class="section-header findings-header"><i class="fas fa-exclamation-circle"></i> NOTABLE FINDINGS</h4><div class="section-content">');
            }
            
            // Format bullet points
            formatted = formatted.replace(/â€¢ ([^\n]+)/g, '<div class="bullet-point"><i class="fas fa-chevron-right"></i> $1</div>');
            
            // Format other markdown bold text (but not headers that we already processed)
            // Only replace if it's not a section header pattern
            formatted = formatted.replace(/\*\*([^*]+):\*\*/g, (match, text) => {
                // If it looks like a section header we missed, format it
                const upperText = text.toUpperCase();
                if (upperText.includes('SECURITY') || upperText.includes('EVIDENCE') || upperText.includes('INVESTIGATION') || 
                    upperText.includes('RECOMMENDATION') || upperText.includes('FINDING') || upperText.includes('PATTERN')) {
                    return `<strong>${text.toUpperCase()}</strong>`;
                }
                return `<strong>${text}</strong>`;
            });
            // Handle remaining bold text
            formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // Close any open sections if we opened any
            if (hasSections && formatted.includes('analysis-section')) {
                formatted += '</div></div>';
            }
            
            // Replace newlines with breaks
            formatted = formatted.replace(/\n/g, '<br>');
            
            return formatted;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check if we have a session_id - if yes, don't clear everything
            const backendSessionId = '{{ session_id }}' || null;
            const hasSession = backendSessionId && backendSessionId !== 'None' && backendSessionId !== '';
            
            if (!hasSession) {
                // Reset all in-memory state only if no session
            uploadedFiles = [];
            
            // Clear server-side uploaded files
            clearUploadsSilently();
            
            // Clear uploaded files container UI
            const uploadedFilesContainer = document.getElementById('uploadedFilesContainer');
            if (uploadedFilesContainer) {
                uploadedFilesContainer.style.display = 'none';
                uploadedFilesContainer.innerHTML = '';
                }
            } else {
                // If we have a session, load uploaded files from server
                loadUploadedFilesFromServer();
            }
            
            // Clear chat input
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.value = '';
            }
            
            loadStats();
            setupEventListeners();
            setupUploadHandlers();
            setupUploadDropdown();
            setupStatsToggle();
            initializeModelDropdown();
        });

        // Setup upload dropdown toggle
        function setupUploadDropdown() {
            const headerUploadBtn = document.getElementById('headerUploadBtn');
            const headerUploadMenu = document.getElementById('headerUploadMenu');
            
            if (headerUploadBtn && headerUploadMenu) {
                // Toggle dropdown on button click
                headerUploadBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    headerUploadMenu.classList.toggle('active');
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!headerUploadBtn.contains(e.target) && !headerUploadMenu.contains(e.target)) {
                        headerUploadMenu.classList.remove('active');
                    }
                });
                
                // Prevent dropdown from closing when clicking inside
                headerUploadMenu.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }
        }

        // Setup sidebar tabs (History/Stats)
        function setupSidebarTabs() {
            const historyTab = document.getElementById('historyTab');
            const statsTab = document.getElementById('statsTab');
            const historyContent = document.getElementById('historyTabContent');
            const statsContent = document.getElementById('statsTabContent');
            
            if (!historyTab || !statsTab || !historyContent || !statsContent) {
                return;
            }
            
            // Load saved tab from localStorage
            const savedTab = localStorage.getItem('activeSidebarTab') || 'history';
            switchSidebarTab(savedTab);
            
            // Tab click handlers
            historyTab.addEventListener('click', () => {
                switchSidebarTab('history');
            });
            
            statsTab.addEventListener('click', () => {
                switchSidebarTab('stats');
            });
        }
        
        function switchSidebarTab(tabName) {
            const historyTab = document.getElementById('historyTab');
            const statsTab = document.getElementById('statsTab');
            const historyContent = document.getElementById('historyTabContent');
            const statsContent = document.getElementById('statsTabContent');
            
            if (!historyTab || !statsTab || !historyContent || !statsContent) {
                return;
            }
            
            // Remove active class from all tabs and content
            historyTab.classList.remove('active');
            statsTab.classList.remove('active');
            historyContent.classList.remove('active');
            statsContent.classList.remove('active');
                    
            // Add active class to selected tab and content
            if (tabName === 'history') {
                historyTab.classList.add('active');
                historyContent.classList.add('active');
            } else if (tabName === 'stats') {
                statsTab.classList.add('active');
                statsContent.classList.add('active');
            }
            
            // Save to localStorage
            localStorage.setItem('activeSidebarTab', tabName);
        }

        function initializeModelDropdown() {
            const dropdown = document.getElementById('modelDropdown');
            const options = document.getElementById('modelOptions');
            const currentModelName = document.getElementById('currentModelName');
            
            // Check if elements exist
            if (!dropdown || !options || !currentModelName) {
                console.warn('Model dropdown elements not found, retrying in 500ms...');
                setTimeout(initializeModelDropdown, 500);
                return;
            }
            
            // Load available models
            loadAvailableModels();
            
            // Toggle dropdown
            dropdown.addEventListener('click', function(e) {
                e.stopPropagation();
                dropdown.classList.toggle('active');
                options.classList.toggle('show');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!dropdown.contains(e.target) && !options.contains(e.target)) {
                    dropdown.classList.remove('active');
                    options.classList.remove('show');
                }
            });
        }

        async function loadAvailableModels() {
            const currentModelNameEl = document.getElementById('currentModelName');
            
            try {
                const response = await fetch('/api/models');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'SUCCESS') {
                    // Always update UI, even if models array is empty
                    if (data.models && data.models.length > 0) {
                        populateModelOptions(data.models, data.current_model);
                        updateCurrentModel(data.current_model, data.models);
                        
                        // Check if there's a restored model preference that needs to be applied
                        // This handles the case where session restoration happened before models loaded
                        const restoredModelId = sessionStorage.getItem('restored_model_id');
                        if (restoredModelId) {
                            console.log('ðŸ”„ Applying restored model preference:', restoredModelId);
                            // Check if the restored model is in the available models
                            const modelExists = data.models.find(m => m.id === restoredModelId);
                            if (modelExists && modelExists.available) {
                                // Switch to the restored model
                                try {
                                    await switchModel(restoredModelId);
                                } catch (e) {
                                    console.error('Error switching to restored model:', e);
                                    // Fallback if switchModel fails
                                    if (data.current_model) {
                                        console.log('âœ… Falling back to current model after error:', data.current_model);
                                        try {
                                            await switchModel(data.current_model);
                                        } catch (e2) {
                                            console.error('Error in fallback model switch:', e2);
                                        }
                                    }
                                }
                            } else {
                                console.warn('âš ï¸ Restored model not available:', restoredModelId);
                                // Fallback to current model or first available model
                                if (data.current_model) {
                                    console.log('âœ… Falling back to current model:', data.current_model);
                                    try {
                                        await switchModel(data.current_model);
                                    } catch (e) {
                                        console.error('Error in fallback model switch:', e);
                                    }
                                } else if (data.models && data.models.length > 0) {
                                    const firstAvailable = data.models.find(m => m.available);
                                    if (firstAvailable) {
                                        console.log('âœ… Falling back to first available model:', firstAvailable.id);
                                        try {
                                            await switchModel(firstAvailable.id);
                                        } catch (e) {
                                            console.error('Error in fallback model switch:', e);
                                        }
                                    }
                                }
                            }
                            // Clear the stored preference
                            sessionStorage.removeItem('restored_model_id');
                        }
                    } else {
                        // No models found - show default or current model
                        if (data.current_model) {
                            if (currentModelNameEl) {
                                currentModelNameEl.textContent = data.current_model;
                            }
                        } else {
                            // No models available at all
                            if (currentModelNameEl) {
                                currentModelNameEl.textContent = 'No models available';
                            }
                        }
                        // Clear options
                        const optionsContainer = document.getElementById('modelOptions');
                        if (optionsContainer) {
                            optionsContainer.innerHTML = '<div class="model-option" style="padding: 0.75rem; color: var(--text-secondary);">No models available. Please start LM Studio or enable Qwen2.5-VL.</div>';
                        }
                    }
                } else {
                    // API returned error status
                    if (currentModelNameEl) {
                        currentModelNameEl.textContent = 'Error loading models';
                    }
                    console.error('Error loading models:', data.message || 'Unknown error');
                }
            } catch (error) {
                console.error('Error loading models:', error);
                // Update UI to show error state
                if (currentModelNameEl) {
                    currentModelNameEl.textContent = 'Error loading models';
                }
                const optionsContainer = document.getElementById('modelOptions');
                if (optionsContainer) {
                    optionsContainer.innerHTML = '<div class="model-option" style="padding: 0.75rem; color: var(--text-secondary);">Failed to load models. Check console for details.</div>';
                }
            }
        }

        function populateModelOptions(models, currentModel) {
            const optionsContainer = document.getElementById('modelOptions');
            optionsContainer.innerHTML = '';
            
            models.forEach(model => {
                const option = document.createElement('div');
                option.className = `model-option ${model.id === currentModel ? 'selected' : ''} ${!model.available ? 'unavailable' : ''}`;
                option.dataset.modelId = model.id;
                
                const availabilityIcon = model.available ? 'âœ…' : 'âŒ';
                const availabilityText = model.available ? 'Available' : 'Not Installed';
                
                option.innerHTML = `
                    <div class="model-option-name">${model.name} ${availabilityIcon}</div>
                    <div class="model-option-description">${model.description}</div>
                    <div class="model-availability">${availabilityText}</div>
                `;
                
                if (model.available) {
                    option.addEventListener('click', function() {
                        switchModel(model.id);
                    });
                } else {
                    option.style.cursor = 'not-allowed';
                    option.style.opacity = '0.6';
                }
                
                optionsContainer.appendChild(option);
            });
        }

        function updateCurrentModel(modelId, models) {
            const currentModelNameEl = document.getElementById('currentModelName');
            if (!currentModelNameEl) {
                // Don't warn if sidebar isn't open yet - this is normal
                if (document.getElementById('settingsSidebar')?.classList.contains('active')) {
                    console.warn('currentModelName element not found (sidebar may not be initialized)');
                }
                return;
            }
            
            // If no models provided, try to use modelId directly
            if (!models || models.length === 0) {
                if (modelId) {
                    currentModelNameEl.textContent = modelId;
                } else {
                    currentModelNameEl.textContent = 'No model selected';
                }
                return;
            }
            
            const model = models.find(m => m.id === modelId);
            if (model) {
                currentModelNameEl.textContent = model.name;
            } else if (modelId) {
                // If model not found in list, just use the modelId
                currentModelNameEl.textContent = modelId;
            } else {
                // No model ID and no matching model - show first available or default
                const firstAvailable = models.find(m => m.available);
                if (firstAvailable) {
                    currentModelNameEl.textContent = firstAvailable.name;
                } else {
                    currentModelNameEl.textContent = 'Select a model';
                }
            }
        }

        async function switchModel(modelId) {
            // Save preference after switching
            setTimeout(() => savePreferencesToSession(), 500);
            try {
                const response = await fetch(`/api/models/${modelId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.status === 'SUCCESS') {
                    // Update UI
                    const options = document.querySelectorAll('.model-option');
                    options.forEach(option => {
                        option.classList.remove('selected');
                        if (option.dataset.modelId === modelId) {
                            option.classList.add('selected');
                        }
                    });
                    
                    // Update current model display
                    const modelName = document.getElementById('currentModelName');
                    const modelNames = {
                        'llama3.2': 'Llama 3.2',
                        'llama3.1': 'Llama 3.1', 
                        'llama2': 'Llama 2',
                        'gemma': 'Gemma',
                        'mistral': 'Mistral',
                        'qwen/qwen2.5-vl-7b': 'Qwen2.5-VL-7B',
                        'qwen2.5-vl-7b': 'Qwen2.5-VL-7B'
                    };
                    if (modelName) {
                        modelName.textContent = modelNames[modelId] || modelId;
                    } else {
                        console.warn('âš ï¸ currentModelName element not found when switching model');
                    }
                    
                    // Close dropdown (with null checks)
                    const modelDropdown = document.getElementById('modelDropdown');
                    const modelOptions = document.getElementById('modelOptions');
                    if (modelDropdown) {
                        modelDropdown.classList.remove('active');
                    }
                    if (modelOptions) {
                        modelOptions.classList.remove('show');
                    }
                    
                    // Show success message
                    showNotification(`Switched to ${modelNames[modelId] || modelId}`, 'success');
                    
                } else {
                    showNotification(`Error switching model: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('Error switching model:', error);
                showNotification('Error switching model', 'error');
            }
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            // Style the notification
            Object.assign(notification.style, {
                position: 'fixed',
                top: '20px',
                right: '20px',
                padding: '12px 20px',
                borderRadius: '8px',
                color: 'white',
                fontWeight: '500',
                zIndex: '10000',
                opacity: '0',
                transform: 'translateX(100%)',
                transition: 'all 0.3s ease',
                background: type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#2196f3'
            });
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        function setupEventListeners() {
            // (chat listeners are bound in setupChatHandlers to avoid double-binding)
            
            // Clear uploads button
            const clearUploadsBtn = document.getElementById('clearUploadsBtn');
            if (clearUploadsBtn) {
                clearUploadsBtn.addEventListener('click', clearUploads);
            }
            
        }

        // Use command from quick buttons (now sends as chat message)
        function useCommand(command) {
            sendChatMessage(command);
        }

        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                document.getElementById('totalFiles').textContent = stats.total_files || 0;
                document.getElementById('totalContacts').textContent = stats.total_contacts || 0;
                document.getElementById('totalMessages').textContent = stats.total_messages || 0;
                document.getElementById('totalCalls').textContent = stats.total_calls || 0;
                
                // Update images stat card (always visible)
                const imagesStatCard = document.getElementById('imagesStatCard');
                const imagesNavLink = document.getElementById('imagesNavLink');
                const totalImages = stats.total_images || 0;
                document.getElementById('totalImages').textContent = totalImages;
                
                // Show Images tab in navigation only when images are present
                if (totalImages > 0) {
                    if (imagesNavLink) {
                        imagesNavLink.style.display = 'flex';
                    }
                } else {
                    if (imagesNavLink) {
                        imagesNavLink.style.display = 'none';
                    }
                }
                
                // Update Smart Analysis button state based on stats
                updateSmartAnalysisButtonState();
                
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        

        // Export results
        function exportResults(format) {
            if (!currentResults) {
                showNotification('No results to export', 'warning');
                return;
            }

            const data = JSON.stringify(currentResults, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ufdr_results.${format}`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Results exported successfully!', 'success');
        }

        // Export chat functionality
        function exportChat(format) {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages || chatMessages.children.length <= 1) {
                showNotification('No chat messages to export', 'warning');
                return;
            }

            const messages = Array.from(chatMessages.children).slice(1); // Skip the initial AI message
            const chatData = {
                exportDate: new Date().toISOString(),
                totalMessages: messages.length,
                messages: []
            };

            messages.forEach((message, index) => {
                const isAI = message.classList.contains('ai-message');
                const content = message.querySelector('.message-content');
                const timestamp = message.querySelector('.message-timestamp');
                
                if (content) {
                    const messageData = {
                        index: index + 1,
                        sender: isAI ? 'Forensic AI Investigator' : 'User',
                        timestamp: timestamp ? timestamp.textContent : 'Unknown',
                        content: content.textContent.trim(),
                        isAI: isAI
                    };
                    chatData.messages.push(messageData);
                }
            });

            let exportContent;
            let filename;
            let mimeType;

            switch (format.toLowerCase()) {
                case 'txt':
                    exportContent = generateTxtExport(chatData);
                    filename = `chat_export_${new Date().toISOString().split('T')[0]}.txt`;
                    mimeType = 'text/plain';
                    break;
                case 'xml':
                    exportContent = generateXmlExport(chatData);
                    filename = `chat_export_${new Date().toISOString().split('T')[0]}.xml`;
                    mimeType = 'application/xml';
                    break;
                case 'json':
                    exportContent = generateJsonExport(chatData);
                    filename = `chat_export_${new Date().toISOString().split('T')[0]}.json`;
                    mimeType = 'application/json';
                    break;
                default:
                    showNotification('Unsupported export format', 'error');
                    return;
            }

            const blob = new Blob([exportContent], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification(`Chat exported as ${format.toUpperCase()} successfully!`, 'success');
        }

        function generateTxtExport(chatData) {
            const exportDate = new Date(chatData.exportDate).toLocaleString();
            const sessionDuration = calculateSessionDuration(chatData.messages);
            const messageStats = calculateMessageStats(chatData.messages);
            
            let txt = `â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n`;
            txt += `â•‘                    EVI SCAN FORENSIC CHAT EXPORT                    â•‘\n`;
            txt += `â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n`;
            txt += `â•‘ Export Date: ${exportDate.padEnd(42)} â•‘\n`;
            txt += `â•‘ Session Duration: ${sessionDuration.padEnd(35)} â•‘\n`;
            txt += `â•‘ Total Messages: ${chatData.totalMessages.toString().padEnd(36)} â•‘\n`;
            txt += `â•‘ User Messages: ${messageStats.userCount.toString().padEnd(37)} â•‘\n`;
            txt += `â•‘ AI Messages: ${messageStats.aiCount.toString().padEnd(38)} â•‘\n`;
            txt += `â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`;
            
            txt += `ðŸ“‹ CONVERSATION SUMMARY\n`;
            txt += `${'â”€'.repeat(60)}\n`;
            txt += `â€¢ Session started: ${messageStats.firstMessage}\n`;
            txt += `â€¢ Session ended: ${messageStats.lastMessage}\n`;
            txt += `â€¢ Average message length: ${messageStats.avgLength} characters\n`;
            txt += `â€¢ Longest message: ${messageStats.longestMessage} characters\n\n`;
            
            txt += `ðŸ’¬ MESSAGE LOG\n`;
            txt += `${'â•'.repeat(60)}\n\n`;

            chatData.messages.forEach((msg, index) => {
                const messageNumber = `[${String(index + 1).padStart(3, '0')}]`;
                const senderIcon = msg.isAI ? 'ðŸ¤–' : 'ðŸ‘¤';
                const senderLabel = msg.sender.padEnd(25);
                const timestamp = `[${msg.timestamp}]`;
                
                txt += `${messageNumber} ${senderIcon} ${senderLabel} ${timestamp}\n`;
                txt += `${'â”€'.repeat(60)}\n`;
                
                // Clean HTML tags and format content with improved structure
                const cleanContent = msg.content.replace(/<[^>]*>/g, '').trim();
                const formattedContent = formatStructuredTextForExport(cleanContent);
                txt += `${formattedContent}\n\n`;
            });
            
            txt += `\n${'â•'.repeat(60)}\n`;
            txt += `End of Chat Export - Generated by EVI SCAN Forensic System\n`;
            txt += `${'â•'.repeat(60)}\n`;

            return txt;
        }

        function generateXmlExport(chatData) {
            const exportDate = new Date(chatData.exportDate).toISOString();
            const sessionDuration = calculateSessionDuration(chatData.messages);
            const messageStats = calculateMessageStats(chatData.messages);
            
            let xml = `<?xml version="1.0" encoding="UTF-8"?>\n`;
            xml += `<!-- EVI SCAN Forensic Chat Export - Generated ${exportDate} -->\n`;
            xml += `<chatExport xmlns="http://ufdr.forensic/chat-export" version="1.0">\n`;
            
            // Header section
            xml += `  <header>\n`;
            xml += `    <title>EVI SCAN Forensic Chat Export</title>\n`;
            xml += `    <exportDate>${exportDate}</exportDate>\n`;
            xml += `    <system>EVI SCAN Forensic Analysis System</system>\n`;
            xml += `    <version>1.0</version>\n`;
            xml += `  </header>\n\n`;
            
            // Session metadata
            xml += `  <session>\n`;
            xml += `    <metadata>\n`;
            xml += `      <totalMessages>${chatData.totalMessages}</totalMessages>\n`;
            xml += `      <userMessages>${messageStats.userCount}</userMessages>\n`;
            xml += `      <aiMessages>${messageStats.aiCount}</aiMessages>\n`;
            xml += `      <sessionDuration>${sessionDuration}</sessionDuration>\n`;
            xml += `      <firstMessage>${escapeXml(messageStats.firstMessage)}</firstMessage>\n`;
            xml += `      <lastMessage>${escapeXml(messageStats.lastMessage)}</lastMessage>\n`;
            xml += `      <averageMessageLength>${messageStats.avgLength}</averageMessageLength>\n`;
            xml += `      <longestMessage>${messageStats.longestMessage}</longestMessage>\n`;
            xml += `    </metadata>\n`;
            xml += `  </session>\n\n`;
            
            // Messages section
            xml += `  <conversation>\n`;
            chatData.messages.forEach((msg, index) => {
                const cleanContent = msg.content.replace(/<[^>]*>/g, '').trim();
                xml += `    <message id="${index + 1}">\n`;
                xml += `      <sender type="${msg.isAI ? 'ai' : 'user'}">${escapeXml(msg.sender)}</sender>\n`;
                xml += `      <timestamp>${escapeXml(msg.timestamp)}</timestamp>\n`;
                xml += `      <content><![CDATA[${cleanContent}]]></content>\n`;
                xml += `      <metadata>\n`;
                xml += `        <length>${cleanContent.length}</length>\n`;
                xml += `        <hasHtml>${msg.content !== cleanContent ? 'true' : 'false'}</hasHtml>\n`;
                xml += `      </metadata>\n`;
                xml += `    </message>\n`;
            });
            xml += `  </conversation>\n\n`;
            
            // Footer
            xml += `  <footer>\n`;
            xml += `    <generatedBy>EVI SCAN Forensic System</generatedBy>\n`;
            xml += `    <exportComplete>true</exportComplete>\n`;
            xml += `  </footer>\n`;
            xml += `</chatExport>`;
            
            return xml;
        }

        function generateJsonExport(chatData) {
            const exportDate = new Date(chatData.exportDate).toISOString();
            const sessionDuration = calculateSessionDuration(chatData.messages);
            const messageStats = calculateMessageStats(chatData.messages);
            
            const structuredData = {
                "exportInfo": {
                    "title": "EVI SCAN Forensic Chat Export",
                    "version": "1.0",
                    "exportDate": exportDate,
                    "system": "EVI SCAN Forensic Analysis System",
                    "format": "JSON"
                },
                "session": {
                    "metadata": {
                        "totalMessages": chatData.totalMessages,
                        "userMessages": messageStats.userCount,
                        "aiMessages": messageStats.aiCount,
                        "sessionDuration": sessionDuration,
                        "firstMessage": messageStats.firstMessage,
                        "lastMessage": messageStats.lastMessage,
                        "averageMessageLength": messageStats.avgLength,
                        "longestMessage": messageStats.longestMessage
                    }
                },
                "conversation": {
                    "messages": chatData.messages.map((msg, index) => {
                        const cleanContent = msg.content.replace(/<[^>]*>/g, '').trim();
                        return {
                            "id": index + 1,
                            "sender": {
                                "name": msg.sender,
                                "type": msg.isAI ? "ai" : "user"
                            },
                            "timestamp": msg.timestamp,
                            "content": {
                                "raw": msg.content,
                                "clean": cleanContent,
                                "length": cleanContent.length,
                                "hasHtml": msg.content !== cleanContent
                            },
                            "metadata": {
                                "messageNumber": index + 1,
                                "isAI": msg.isAI
                            }
                        };
                    })
                },
                "statistics": {
                    "messageCounts": {
                        "total": chatData.totalMessages,
                        "user": messageStats.userCount,
                        "ai": messageStats.aiCount
                    },
                    "contentAnalysis": {
                        "averageLength": messageStats.avgLength,
                        "longestMessage": messageStats.longestMessage,
                        "shortestMessage": messageStats.shortestMessage,
                        "totalCharacters": messageStats.totalCharacters
                    },
                    "timing": {
                        "sessionDuration": sessionDuration,
                        "firstMessage": messageStats.firstMessage,
                        "lastMessage": messageStats.lastMessage
                    }
                },
                "footer": {
                    "generatedBy": "EVI SCAN Forensic System",
                    "exportComplete": true,
                    "notes": "This export contains the complete conversation history with forensic analysis metadata"
                }
            };
            
            return JSON.stringify(structuredData, null, 2);
        }

        function calculateSessionDuration(messages) {
            if (messages.length < 2) return "N/A";
            
            const firstMsg = messages[0];
            const lastMsg = messages[messages.length - 1];
            
            try {
                const startTime = new Date(`2000-01-01 ${firstMsg.timestamp}`);
                const endTime = new Date(`2000-01-01 ${lastMsg.timestamp}`);
                const duration = endTime - startTime;
                
                if (duration < 0) return "Unknown";
                
                const hours = Math.floor(duration / (1000 * 60 * 60));
                const minutes = Math.floor((duration % (1000 * 60 * 60)) / (1000 * 60));
                
                if (hours > 0) {
                    return `${hours}h ${minutes}m`;
                } else {
                    return `${minutes}m`;
                }
            } catch (error) {
                return "Unknown";
            }
        }

        function calculateMessageStats(messages) {
            const stats = {
                userCount: 0,
                aiCount: 0,
                totalCharacters: 0,
                longestMessage: 0,
                shortestMessage: Infinity,
                firstMessage: "Unknown",
                lastMessage: "Unknown"
            };
            
            if (messages.length === 0) return stats;
            
            stats.firstMessage = messages[0].timestamp;
            stats.lastMessage = messages[messages.length - 1].timestamp;
            
            messages.forEach(msg => {
                if (msg.isAI) {
                    stats.aiCount++;
                } else {
                    stats.userCount++;
                }
                
                const cleanContent = msg.content.replace(/<[^>]*>/g, '').trim();
                const length = cleanContent.length;
                
                stats.totalCharacters += length;
                stats.longestMessage = Math.max(stats.longestMessage, length);
                stats.shortestMessage = Math.min(stats.shortestMessage, length);
            });
            
            stats.avgLength = Math.round(stats.totalCharacters / messages.length);
            stats.shortestMessage = stats.shortestMessage === Infinity ? 0 : stats.shortestMessage;
            
            return stats;
        }

        function formatStructuredTextForExport(text) {
            // Check if this is a structured forensic report
            if (text.includes('INVESTIGATION FINDINGS:') || text.includes('SECURITY CONCERNS:') || 
                text.includes('EVIDENCE PATTERNS:') || text.includes('RECOMMENDATIONS:')) {
                
                let formatted = '';
                const lines = text.split('\n');
                let inSection = false;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // Check for section headers
                    if (line.match(/^(INVESTIGATION FINDINGS|SECURITY CONCERNS|EVIDENCE PATTERNS|RECOMMENDATIONS):$/)) {
                        if (inSection) formatted += '\n'; // Add spacing between sections
                        formatted += `\n${'='.repeat(60)}\n`;
                        formatted += `  ${line}\n`;
                        formatted += `${'='.repeat(60)}\n\n`;
                        inSection = true;
                    }
                    // Check for bullet points
                    else if (line.startsWith('â€¢')) {
                        const bulletContent = line.substring(1).trim();
                        formatted += `  â€¢ ${wrapText(bulletContent, 52)}\n\n`;
                    }
                    // Regular content lines
                    else if (line.length > 0) {
                        formatted += `  ${wrapText(line, 52)}\n\n`;
                    }
                    // Empty lines
                    else {
                        if (inSection) formatted += '\n';
                    }
                }
                
                return formatted.trim();
            }
            
            // For non-structured responses, use regular wrapping
            return wrapText(text, 58);
        }

        function wrapText(text, maxLength) {
            if (text.length <= maxLength) return text;
            
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';
            
            words.forEach(word => {
                if ((currentLine + word).length <= maxLength) {
                    currentLine += (currentLine ? ' ' : '') + word;
                } else {
                    if (currentLine) lines.push(currentLine);
                    currentLine = word;
                }
            });
            
            if (currentLine) lines.push(currentLine);
            return lines.join('\n');
        }

        function escapeXml(text) {
            return text.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;')
                      .replace(/'/g, '&#39;');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Show notification
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'var(--success-gradient)' : 
                           type === 'warning' ? 'var(--warning-gradient)' : 
                           type === 'error' ? 'var(--danger-gradient)' : 'var(--primary-gradient)'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 10px;
                box-shadow: var(--shadow);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Add fadeOut animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeOut {
                from { opacity: 1; transform: translateX(0); }
                to { opacity: 0; transform: translateX(100%); }
            }
        `;
        document.head.appendChild(style);
        
        // Setup file upload handlers
        function setupUploadHandlers() {
            // Click on dropzone to trigger file input
            uploadDropzone.addEventListener('click', () => {
                fileInput.click();
            });
            
            // Handle file selection
            fileInput.addEventListener('change', handleFileUpload);
            
            // Handle drag and drop
            uploadDropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadDropzone.classList.add('upload-dropzone-active');
            });
            
            uploadDropzone.addEventListener('dragleave', () => {
                uploadDropzone.classList.remove('upload-dropzone-active');
            });
            
            uploadDropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadDropzone.classList.remove('upload-dropzone-active');
                if (e.dataTransfer.files.length > 0) {
                    handleFiles(e.dataTransfer.files);
                }
            });
        }
        
        // Handle file upload
        function handleFileUpload(e) {
            const files = e.target.files;
            if (files.length > 0) {
                handleFiles(files);
            }
        }
        
        // Process uploaded files
        function handleFiles(files) {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.name.endsWith('.json') || file.name.endsWith('.zip') || file.name.endsWith('.html')) {
                    uploadFile(file);
                } else {
                    showNotification('Only JSON, ZIP, and HTML files are supported', 'warning');
                }
            }
            // Reset file input
            fileInput.value = '';
            // Close upload dropdown after file selection
            const headerUploadMenu = document.getElementById('headerUploadMenu');
            if (headerUploadMenu) {
                headerUploadMenu.classList.remove('active');
            }
        }
        
        // Upload file and process it
        async function uploadFile(file) {
            try {
                // Validate file size before upload
                const maxSize = 10 * 1024 * 1024 * 1024; // 10GB
                if (file.size > maxSize) {
                    showNotification(`File ${file.name} is too large (${formatFileSize(file.size)}). Maximum size is 10GB.`, 'error');
                    return;
                }
                
                if (file.size === 0) {
                    showNotification(`File ${file.name} is empty.`, 'error');
                    return;
                }
                
                // Show upload progress
                showNotification(`ðŸ“¤ Uploading ${file.name} (${formatFileSize(file.size)})...`, 'info');
                
                // Create FormData for file upload
                const formData = new FormData();
                formData.append('file', file);
                
                // Include session_id if available
                const backendSessionId = '{{ session_id }}' || null;
                if (backendSessionId && backendSessionId !== 'None' && backendSessionId !== '') {
                    formData.append('session_id', backendSessionId);
                    console.log('Including session_id in upload:', backendSessionId);
                } else {
                    console.warn('No session_id available for upload');
                }
                
                // Send file to backend
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                // Check if response is OK
                if (!response.ok) {
                    let errorMessage = `Upload failed with status ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        // If response is not JSON, get text
                        try {
                            const errorText = await response.text();
                            if (errorText) errorMessage = errorText;
                        } catch (e2) {
                            // Use default error message
                        }
                    }
                    showNotification(`âŒ Error uploading ${file.name}: ${errorMessage}`, 'error');
                    return;
                }
                
                const result = await response.json();
                
                if (result.status === 'SUCCESS') {
                    let message = `âœ… File ${file.name} uploaded successfully`;
                    
                    // Show validation info
                    if (result.validation && result.validation.message) {
                        message += ` - ${result.validation.message}`;
                    }
                    
                    showNotification(message, 'success');
                    
                    // Show warnings if any
                    if (result.warnings && result.warnings.length > 0) {
                        const warningMessage = `âš ï¸ Warnings for ${file.name}: ${result.warnings.join(', ')}`;
                        showNotification(warningMessage, 'warning');
                    }
                    
                    // Refresh uploaded files list and stats
                    await loadUploadedFilesFromServer();
                    // Optimistically update stats if quick_stats provided
                    if (result.quick_stats) {
                        try {
                            document.getElementById('totalFiles').textContent = result.quick_stats.total_files || 0;
                            document.getElementById('totalContacts').textContent = result.quick_stats.total_contacts || 0;
                            document.getElementById('totalMessages').textContent = result.quick_stats.total_messages || 0;
                            document.getElementById('totalCalls').textContent = result.quick_stats.total_calls || 0;
                            
                            // Update images count (stat card always visible)
                            const imagesCount = result.quick_stats.images_count || 0;
                            const imagesStatCard = document.getElementById('imagesStatCard');
                            const imagesNavLink = document.getElementById('imagesNavLink');
                            document.getElementById('totalImages').textContent = imagesCount;
                            
                            // Show Images tab in navigation only when images are present
                            if (imagesCount > 0) {
                                if (imagesNavLink) {
                                    imagesNavLink.style.display = 'flex';
                                }
                            } else {
                                if (imagesNavLink) {
                                    imagesNavLink.style.display = 'none';
                                }
                            }
                        } catch (e) {}
                    }
                    // Also fetch fresh stats from server
                    loadStats();
                    // Update Smart Analysis button state after upload
                    updateSmartAnalysisButtonState();
                } else {
                    showNotification(`âŒ Error uploading ${file.name}: ${result.message}`, 'error');
                }
            } catch (error) {
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    showNotification(`âŒ Network error uploading ${file.name}. Please check your connection.`, 'error');
                } else {
                    showNotification(`âŒ Error uploading ${file.name}: ${error.message}`, 'error');
                }
            }
        }
        
        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' bytes';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / 1048576).toFixed(1) + ' MB';
        }
        
        // Load uploaded files from server
        async function loadUploadedFilesFromServer() {
            try {
                // Include session_id in request if available
                const backendSessionId = '{{ session_id }}' || null;
                let url = '/api/uploaded-files';
                if (backendSessionId && backendSessionId !== 'None' && backendSessionId !== '') {
                    url += `?session_id=${encodeURIComponent(backendSessionId)}`;
                    console.log('Loading uploaded files for session:', backendSessionId);
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.uploaded_files && data.uploaded_files.length > 0) {
                    uploadedFilesContainer.style.display = 'block';
                    let html = '<h4>ðŸ“ Uploaded Files</h4>';
                    data.uploaded_files.forEach((file) => {
                        const displayName = file.filename || 'unknown';
                        const sizeText = (file.size_mb !== undefined) ? `${file.size_mb} MB` : `${file.size || 0} bytes`;
                        const activeBadge = file.active ? '<span class="file-status">Active</span>' : '';
                        const fileType = file.type || (displayName.endsWith('.zip') ? 'ZIP' : 'JSON');
                        html += `
                            <div class="uploaded-file-item">
                                <div class="file-info">
                                    <div class="file-name">${displayName}</div>
                                    <div class="file-size">${sizeText} ${activeBadge}</div>
                                </div>
                                <div class="file-actions">
                                    <button onclick="removeUploadedFile('${escapeHtml(displayName)}')" 
                                            class="file-action-btn">
                                        Remove
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    uploadedFilesContainer.innerHTML = html;
                    // Update Smart Analysis button state after files are loaded
                    updateSmartAnalysisButtonState();
                } else {
                    uploadedFilesContainer.style.display = 'none';
                    uploadedFilesContainer.innerHTML = '';
                    // Update Smart Analysis button state (no files available)
                    updateSmartAnalysisButtonState();
                }
            } catch (error) {
                console.error('Error loading uploaded files:', error);
                uploadedFilesContainer.innerHTML = '<div style="color: var(--danger-color);">Error loading uploaded files</div>';
            }
        }
        
        // Load uploaded files (wrapper function for compatibility)
        function loadUploadedFiles() {
            loadUploadedFilesFromServer();
        }
        
        // Remove uploaded file
        async function removeUploadedFile(filename) {
            try {
                const response = await fetch(`/api/remove-upload/${encodeURIComponent(filename)}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.status === 'SUCCESS') {
                    showNotification(`File ${filename} removed successfully`, 'success');
                    await loadUploadedFilesFromServer();
                    loadStats();
                } else {
                    showNotification(`Error removing file: ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`Error removing file: ${error.message}`, 'error');
            }
        }
        
        // Clear all data (uploads and chat)
        async function clearAllData() {
            if (!confirm('Are you sure you want to clear all data including uploads and chat history?')) {
                return;
            }
            
            try {
                // Clear uploads
                const uploadResponse = await fetch('/api/clear-uploads', {
                    method: 'POST'
                });
                
                // Clear chat
                clearChatHistory();
                
                // Clear command history
                document.getElementById('commandHistory').innerHTML = '';
                
                // Reload stats
                await loadStatsFromServer();
                await loadUploadedFilesFromServer();
                
                showNotification('All data cleared successfully', 'success');
            } catch (error) {
                console.error('Error clearing data:', error);
                showNotification(`Error clearing data: ${error.message}`, 'error');
            }
        }
        
        // Clear all uploads silently (for page reset)
        async function clearUploadsSilently() {
            try {
                const response = await fetch('/api/clear-uploads', {
                    method: 'POST'
                });
                const result = await response.json();
                if (result.status === 'SUCCESS') {
                    console.log('Server-side uploads cleared on page load');
                }
            } catch (error) {
                console.log('Note: Could not clear server uploads (may not be available)', error);
            }
        }

        // Clear all uploads
        async function clearUploads() {
            if (!confirm('Are you sure you want to clear all uploaded files?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/clear-uploads', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.status === 'SUCCESS') {
                    showNotification('All uploads cleared successfully', 'success');
                    await loadUploadedFilesFromServer();
                    loadStats();
                } else {
                    showNotification(`Error clearing uploads: ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`Error clearing uploads: ${error.message}`, 'error');
            }
        }

        // Chat Interface Functions
        const chatInput = document.getElementById('chatInput');
        const chatSendBtn = document.getElementById('chatSendBtn');
        const chatMessages = document.getElementById('chatMessages');

        // Setup chat event listeners
        function setupChatHandlers() {
            console.log('Setting up chat handlers');
            console.log('chatInput:', chatInput);
            console.log('chatSendBtn:', chatSendBtn);
            console.log('chatMessages:', chatMessages);

            if (chatSendBtn) {
                chatSendBtn.onclick = null;
                chatSendBtn.addEventListener('click', function(){
                    sendChatMessage();
                }, { once: false });
            }

            // Setup stop button
            const chatStopBtn = document.getElementById('chatStopBtn');
            if (chatStopBtn) {
                chatStopBtn.onclick = null;
                chatStopBtn.addEventListener('click', function(){
                    stopChatResponse();
                }, { once: false });
            }

            if (chatInput) {
                chatInput.onkeypress = null;
                chatInput.onkeydown = null;
                chatInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendChatMessage();
                    }
                }, { once: false });
            }
        }

        // Global abort controller for stopping chat responses
        let currentAbortController = null;

        async function sendChatMessage(messageText = null) {
            console.log('sendChatMessage called');
            const message = messageText || chatInput.value.trim();
            console.log('Message:', message);
            
            if (!message) {
                console.log('Empty message, returning');
                return;
            }

            // Add user message to chat
            addChatMessage(message, 'user');
            
            // Clear input only if message came from input field
            if (!messageText) {
                chatInput.value = '';
                chatInput.style.height = '';
                updateSendButton();
            }
            
            // Show typing indicator
            showTypingIndicator();
            
            // Show stop button and hide send button
            const stopBtn = document.getElementById('chatStopBtn');
            const sendBtn = document.getElementById('chatSendBtn');
            if (stopBtn) stopBtn.style.display = 'flex';
            if (sendBtn) sendBtn.style.display = 'none';
            
            // Create new AbortController for this request
            currentAbortController = new AbortController();
            const signal = currentAbortController.signal;
            
            try {
                // Use streaming endpoint for real-time token streaming
                const response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: message }),
                    signal: signal
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Hide typing indicator
                hideTypingIndicator();
                
                // Create a placeholder message div for streaming
                let streamingMessageDiv = null;
                let streamingContent = '';
                let confidence = null;
                let responseTime = null;
                let llmUsed = false;
                let isFinalized = false; // Flag to prevent duplicate finalization
                
                // Read the stream
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                while (true) {
                    // Check if request was aborted
                    if (signal.aborted) {
                        reader.cancel();
                        break;
                    }
                    
                    const { done, value } = await reader.read();
                    
                    if (done) {
                        break;
                    }
                    
                    // Decode the chunk
                    buffer += decoder.decode(value, { stream: true });
                    
                    // Process complete lines (SSE format)
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || ''; // Keep incomplete line in buffer
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                
                                if (data.type === 'start') {
                                    // Create initial message div
                                    streamingMessageDiv = createStreamingMessageDiv();
                                    streamingContent = '';
                                    isFinalized = false;
                                } else if (data.type === 'token') {
                                    // Append token to content
                                    streamingContent += data.content;
                                    // Update the message div in real-time
                                    if (streamingMessageDiv) {
                                    updateStreamingMessage(streamingMessageDiv, streamingContent);
                                        // Ensure cursor is visible after each update
                                        const cursor = streamingMessageDiv.querySelector('.streaming-cursor');
                                        if (cursor) {
                                            cursor.style.display = 'inline-block';
                                            cursor.style.visibility = 'visible';
                                        }
                                    }
                                } else if (data.type === 'stats') {
                                    // Update stats immediately when received
                                    if (data.quick_stats) {
                                        document.getElementById('totalContacts').textContent = data.quick_stats.total_contacts || 0;
                                        document.getElementById('totalMessages').textContent = data.quick_stats.total_messages || 0;
                                        document.getElementById('totalCalls').textContent = data.quick_stats.total_calls || 0;
                                        const imagesCount = data.quick_stats.images_count || 0;
                                        document.getElementById('totalImages').textContent = imagesCount;
                                    }
                                } else if (data.type === 'done') {
                                    // Finalize the message with metadata (only once)
                                    if (!isFinalized) {
                                        confidence = data.confidence || null;
                                        responseTime = data.response_time || null;
                                        llmUsed = data.llm_used || false;
                                        const imageCitations = data.image_citations || [];
                                        const hasImages = data.has_images || false;
                                        // Phase 1: Extract quality indicator from validation
                                        // Update stats if provided in response
                                        if (data.quick_stats) {
                                            document.getElementById('totalContacts').textContent = data.quick_stats.total_contacts || 0;
                                            document.getElementById('totalMessages').textContent = data.quick_stats.total_messages || 0;
                                            document.getElementById('totalCalls').textContent = data.quick_stats.total_calls || 0;
                                            const imagesCount = data.quick_stats.images_count || 0;
                                            document.getElementById('totalImages').textContent = imagesCount;
                                        }
                                        
                                        finalizeStreamingMessage(streamingMessageDiv, streamingContent, confidence, responseTime, llmUsed, imageCitations, hasImages);
                                        isFinalized = true;
                                    }
                                } else if (data.type === 'error') {
                                    // Handle error
                                    hideTypingIndicator();
                                    if (streamingMessageDiv) {
                                        streamingMessageDiv.remove();
                                    }
                                    const errorMessage = data.response || data.message || 'An error occurred';
                                    addChatMessage(errorMessage, 'ai', null, false, 0, false, null);
                                    return;
                                }
                            } catch (e) {
                                console.error('Error parsing SSE data:', e, line);
                            }
                        }
                    }
                }
                
                // If we didn't get a 'done' event, finalize anyway (only if not already finalized)
                if (!isFinalized && streamingMessageDiv && streamingContent) {
                    finalizeStreamingMessage(streamingMessageDiv, streamingContent, confidence, responseTime, llmUsed, [], false, null);
                    isFinalized = true;
                } else if (!isFinalized && streamingMessageDiv && !streamingContent) {
                    // If we created a message div but got no content, remove it
                    streamingMessageDiv.remove();
                }
                
                // Hide stop button and show send button
                if (stopBtn) stopBtn.style.display = 'none';
                if (sendBtn) sendBtn.style.display = 'flex';
                currentAbortController = null;
                
            } catch (error) {
                console.error('Error sending chat message:', error);
                hideTypingIndicator();
                
                // Hide stop button and show send button
                if (stopBtn) stopBtn.style.display = 'none';
                if (sendBtn) sendBtn.style.display = 'flex';
                currentAbortController = null;
                
                // Remove streaming message div if it exists
                const existingStreaming = document.querySelector('.streaming-message-wrapper');
                if (existingStreaming) {
                    existingStreaming.remove();
                }
                
                // Don't show error if it was aborted by user
                if (error.name === 'AbortError') {
                    console.log('Request aborted by user');
                    // Save the user's query to chat history even if aborted (so context is maintained)
                    // The query was already added to chat when sendChatMessage was called
                    // But we should note that the response was aborted
                    const lastUserMessage = document.querySelector('.user-message:last-child');
                    if (lastUserMessage) {
                        // Add a note that response was interrupted
                        const note = document.createElement('div');
                        note.className = 'aborted-note';
                        note.style.cssText = 'font-size: 0.75rem; color: var(--text-secondary); font-style: italic; margin-top: 0.25rem;';
                        note.textContent = '(Response interrupted)';
                        lastUserMessage.appendChild(note);
                    }
                    return;
                }
                
                // Build detailed error message for network/parsing errors
                let errorMessage = `ðŸŒ **NETWORK ERROR**\n\nFailed to communicate with the server.\n\n**Error:** ${error.message}\n\n**Possible causes:**\nâ€¢ Flask server is not running\nâ€¢ Network connectivity issue\nâ€¢ Server is overloaded\n\n**Solutions:**\n1. Check if Flask server is running\n2. Refresh the page\n3. Check browser console for details`;
                
                addChatMessage(errorMessage, 'ai', null, false, 0, false, null);
            }
        }

        // Stop chat response generation
        function stopChatResponse() {
            if (currentAbortController) {
                currentAbortController.abort();
                currentAbortController = null;
                
                // Hide typing indicator
                hideTypingIndicator();
                
                // Hide stop button and show send button
                const stopBtn = document.getElementById('chatStopBtn');
                const sendBtn = document.getElementById('chatSendBtn');
                if (stopBtn) stopBtn.style.display = 'none';
                if (sendBtn) sendBtn.style.display = 'flex';
                
                // Remove streaming message div if it exists
                const existingStreaming = document.querySelector('.streaming-message-wrapper');
                if (existingStreaming) {
                    existingStreaming.remove();
                }
                
                console.log('Chat response stopped by user');
            }
        }
        
        // Global variable to track scroll maintenance
        let scrollMaintenanceActive = false;
        let scrollMaintenanceRaf = null;
        
        function createStreamingMessageDiv() {
            // Create wrapper div
            const wrapperDiv = document.createElement('div');
            wrapperDiv.className = 'chat-message-wrapper streaming-message-wrapper';
            wrapperDiv.id = 'streaming-message-' + Date.now();
            
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const messageContent = `
                <div class="chat-message ai-message">
                    <div class="chat-message-bubble ai streaming-text">
                        <span class="streaming-content"></span>
                        <span class="streaming-cursor" id="cursor-${Date.now()}"></span>
                    </div>
                    <div class="chat-message-timestamp">${timestamp}</div>
                </div>
            `;
            
            wrapperDiv.innerHTML = messageContent;
            chatMessages.appendChild(wrapperDiv);
            
            // Ensure cursor is immediately visible and animated
            const cursor = wrapperDiv.querySelector('.streaming-cursor');
            if (cursor) {
                cursor.style.display = 'inline-block';
                cursor.style.visibility = 'visible';
                cursor.style.opacity = '1';
            }
            
            // Scroll to bottom once when streaming starts
            requestAnimationFrame(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
            
            return wrapperDiv;
        }
        
        function updateStreamingMessage(messageDiv, content) {
            if (!messageDiv) return;
            
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;
            
            // Check if user is near bottom (within 150px) before updating
            const scrollThreshold = 150;
            const wasNearBottom = chatMessages.scrollHeight - chatMessages.scrollTop - chatMessages.clientHeight < scrollThreshold;
            
            const contentSpan = messageDiv.querySelector('.streaming-content');
            const cursorSpan = messageDiv.querySelector('.streaming-cursor');
            
            if (contentSpan) {
                // Format the content (support markdown-like formatting)
                const formattedContent = formatStructuredResponse(content);
                
                // Update content while preserving cursor
                contentSpan.innerHTML = formattedContent;
                
                // Ensure cursor is still present and visible after content update
                if (!cursorSpan || !cursorSpan.parentElement) {
                    // Cursor was removed, re-add it
                    const bubble = messageDiv.querySelector('.chat-message-bubble');
                    if (bubble) {
                        const newCursor = document.createElement('span');
                        newCursor.className = 'streaming-cursor';
                        bubble.appendChild(newCursor);
                    }
                } else {
                    // Ensure cursor is visible and properly positioned
                    cursorSpan.style.display = 'inline-block';
                    cursorSpan.style.visibility = 'visible';
                }
                
                // Auto-scroll to bottom if user was near bottom
                // Use a single, simple scroll method to avoid conflicts
                if (wasNearBottom) {
                    // Cancel any existing scroll maintenance
                    if (scrollMaintenanceRaf) {
                        cancelAnimationFrame(scrollMaintenanceRaf);
                    }
                    
                    // Use a single RAF call to scroll after layout
                    scrollMaintenanceRaf = requestAnimationFrame(() => {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        scrollMaintenanceRaf = null;
                    });
                }
            }
        }
        
        function finalizeStreamingMessage(messageDiv, content, confidence, responseTime, llmUsed, imageCitations = [], hasImages = false) {
            if (!messageDiv) return;
            
            // Check if already finalized (prevent duplicates)
            if (messageDiv.classList.contains('finalized')) {
                return;
            }
            messageDiv.classList.add('finalized');
            
            // Cancel any active scroll maintenance
            if (scrollMaintenanceRaf) {
                cancelAnimationFrame(scrollMaintenanceRaf);
                scrollMaintenanceRaf = null;
            }
            
            // Remove streaming classes and cursor
            messageDiv.classList.remove('streaming-message-wrapper');
            const bubble = messageDiv.querySelector('.chat-message-bubble');
            if (bubble) {
                bubble.classList.remove('streaming-text');
            }
            const cursor = messageDiv.querySelector('.streaming-cursor');
            if (cursor) {
                cursor.remove();
            }
            
            // Format final content
            const formattedContent = formatStructuredResponse(content);
            const contentSpan = messageDiv.querySelector('.streaming-content');
            if (contentSpan) {
                contentSpan.innerHTML = formattedContent;
            }
            
            // Get the message bubble to add metadata
            const messageBubble = messageDiv.querySelector('.chat-message-bubble');
            if (messageBubble) {
                const hasConfidence = messageBubble.querySelector('.confidence-indicator');
                const hasResponseTime = messageBubble.querySelector('.response-time-indicator');
                const hasQualityBadge = messageBubble.querySelector('.quality-badge');
                
                // Phase 1: Add quality indicator badge (evidence validation)
                
                // Add confidence indicator (only if not already present)
                if (confidence !== null && !hasConfidence) {
                    const confidenceClass = confidence >= 0.8 ? 'confidence-high' : 
                                          confidence >= 0.6 ? 'confidence-medium' : 'confidence-low';
                    const confidenceIcon = confidence >= 0.8 ? 'fa-check-circle' : 
                                          confidence >= 0.6 ? 'fa-exclamation-triangle' : 'fa-exclamation-circle';
                    
                    const confidenceHtml = `
                        <div class="confidence-indicator ${confidenceClass}">
                            <i class="fas ${confidenceIcon}"></i>
                            <span>Confidence: ${confidence.toFixed(3)}</span>
                            <div class="confidence-bar">
                                <div class="confidence-fill ${confidence >= 0.8 ? 'high' : confidence >= 0.6 ? 'medium' : 'low'}" 
                                     style="width: ${confidence * 100}%"></div>
                            </div>
                        </div>
                    `;
                    messageBubble.insertAdjacentHTML('beforeend', confidenceHtml);
                }
                
                // Add response time indicator (only if not already present)
                if (responseTime !== null && !hasResponseTime) {
                    const responseTimeHtml = `
                        <div class="response-time-indicator">
                            <i class="fas fa-clock"></i>
                            <span>Response time: ${responseTime}s</span>
                        </div>
                    `;
                    messageBubble.insertAdjacentHTML('beforeend', responseTimeHtml);
                }
                
                // Add image citations gallery if images are available
                if (hasImages && imageCitations && imageCitations.length > 0) {
                    const imageGalleryHtml = renderImageGallery(imageCitations);
                    messageBubble.insertAdjacentHTML('beforeend', imageGalleryHtml);
                    // Attach click handlers after HTML is inserted
                    setTimeout(() => {
                        attachImageClickHandlers();
                    }, 100);
                }
            }
            
            // Save chat history with metadata to session
            if (currentSessionId) {
                const session = investigationSessions.find(s => s.id === currentSessionId);
                if (session) {
                    // Find the last assistant message and update it with metadata
                    const lastMessage = session.messages[session.messages.length - 1];
                    if (lastMessage && (lastMessage.role === 'assistant' || lastMessage.sender === 'assistant' || lastMessage.sender === 'ai')) {
                        // Update existing message with metadata
                        lastMessage.content = content;
                        lastMessage.text = content; // Keep for backward compatibility
                        if (!lastMessage.metadata) {
                            lastMessage.metadata = {};
                        }
                        lastMessage.metadata.confidence = confidence;
                        lastMessage.metadata.response_time = responseTime;
                        lastMessage.metadata.responseTime = responseTime; // Both formats
                        lastMessage.metadata.llm_used = llmUsed;
                        lastMessage.metadata.llmUsed = llmUsed; // Both formats
                        lastMessage.metadata.image_citations = imageCitations;
                        lastMessage.metadata.imageCitations = imageCitations; // Both formats
                        lastMessage.metadata.has_images = hasImages;
                        lastMessage.metadata.hasImages = hasImages; // Both formats
                        saveSessions();
                    } else {
                        // If message not found, add it with full metadata
                        session.messages.push({
                            role: 'assistant',
                            sender: 'ai',
                            content: content,
                            text: content,
                            timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                            metadata: {
                                confidence: confidence,
                                response_time: responseTime,
                                responseTime: responseTime,
                                llm_used: llmUsed,
                                llmUsed: llmUsed,
                                image_citations: imageCitations,
                                imageCitations: imageCitations,
                                has_images: hasImages,
                                hasImages: hasImages
                            }
                        });
                        saveSessions();
                    }
                }
            }
            
            // Save chat history
            saveChatHistory();
            
            // Ensure scroll position is at bottom after finalization
            // Use double RAF to ensure all DOM updates and layout recalculations are complete
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        // Override smooth behavior for instant scroll
                        chatMessages.scrollTo({
                            top: chatMessages.scrollHeight,
                            behavior: 'auto'
                        });
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        // Additional safeguard
                        if (chatMessages.scrollTop + chatMessages.clientHeight < chatMessages.scrollHeight - 10) {
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }
                    });
                });
            }
            
            // Play completion sound
            playCompletionSound();
        }

        function addChatMessage(message, sender, detailedResults = null, llmUsed = false, confidence = null, ragUsed = false, responseTime = null, imageCitations = null, hasImages = false) {
            // Create wrapper div
            const wrapperDiv = document.createElement('div');
            wrapperDiv.className = `chat-message-wrapper ${sender}-message`;
            
            // Detect if this is an error message
            const isError = message.includes('ðŸš¨') || message.includes('ERROR') || message.includes('âŒ') || 
                           message.includes('CONNECTION ERROR') || message.includes('TIMEOUT') || 
                           message.includes('NETWORK ERROR') || (confidence === 0 && sender === 'ai');
            
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const senderLabel = sender === 'user' ? 'You' : 'Forensic AI Investigator';
            
            // Add LLM badge if Llama was used
            const llmBadge = llmUsed ? '<span class="llm-badge">Llama 3.2</span>' : '';
            
            // Add RAG badge if RAG was used
            const ragBadge = ragUsed ? '<span class="rag-badge">RAG</span>' : '';
            
            // Add confidence indicator for AI messages
            let confidenceHtml = '';
            if (confidence !== null && sender === 'ai') {
                const confidenceClass = confidence >= 0.8 ? 'confidence-high' : 
                                      confidence >= 0.6 ? 'confidence-medium' : 'confidence-low';
                const confidenceIcon = confidence >= 0.8 ? 'fa-check-circle' : 
                                      confidence >= 0.6 ? 'fa-exclamation-triangle' : 'fa-exclamation-circle';
                
                confidenceHtml = `
                    <div class="confidence-indicator ${confidenceClass}">
                        <i class="fas ${confidenceIcon}"></i>
                        <span>Confidence: ${confidence.toFixed(3)}</span>
                        <div class="confidence-bar">
                            <div class="confidence-fill ${confidence >= 0.8 ? 'high' : confidence >= 0.6 ? 'medium' : 'low'}" 
                                 style="width: ${confidence * 100}%"></div>
                        </div>
                    </div>
                `;
            }
            
            // Add response time indicator for AI messages
            let responseTimeHtml = '';
            if (responseTime !== null && sender === 'ai') {
                responseTimeHtml = `
                    <div class="response-time-indicator">
                        <i class="fas fa-clock"></i>
                        <span>Response time: ${responseTime}s</span>
                    </div>
                `;
            }
            
            // Format structured responses
            const formattedMessage = formatStructuredResponse(message);
            
            // Add image gallery if available
            let imageGalleryHtml = '';
            if (hasImages && imageCitations && imageCitations.length > 0 && sender === 'ai') {
                imageGalleryHtml = renderImageGallery(imageCitations);
            }
            
            let messageContent = `
                <div class="chat-message ${sender}-message${isError ? ' error-message' : ''}">
                    <div class="chat-message-bubble ${sender}">
                        ${formattedMessage}
                        ${confidenceHtml}
                        ${responseTimeHtml}
                        ${imageGalleryHtml}
                    </div>
                    <div class="chat-message-timestamp">${timestamp}</div>
                </div>
            `;
            
            wrapperDiv.innerHTML = messageContent;
            chatMessages.appendChild(wrapperDiv);
            
            // Attach image click handlers if images are present
            if (hasImages && imageCitations && imageCitations.length > 0 && sender === 'ai') {
                setTimeout(() => {
                    attachImageClickHandlers();
                }, 100);
            }
            
            // Save chat history to localStorage
            saveChatHistory();
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Play completion sound for AI messages
            if (sender === 'ai') {
                playCompletionSound();
            }
        }

        // Image Gallery Functions
        function renderImageGallery(imageCitations) {
            if (!imageCitations || imageCitations.length === 0) {
                return '';
            }
            
            let galleryHtml = `
                <div class="image-citations-section">
                    <div class="image-citations-header">
                        <i class="fas fa-images"></i>
                        <strong>Relevant Images Found (${imageCitations.length})</strong>
                    </div>
                    <div class="image-gallery">
            `;
            
            // Show first 12 images in grid, rest in collapsible section
            const visibleImages = imageCitations.slice(0, 12);
            const hiddenImages = imageCitations.slice(12);
            
            visibleImages.forEach((citation, index) => {
                const imageUrl = `/api/media/${encodeURIComponent(citation.filename)}`;
                const safeFilename = citation.filename.replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                const contextBadge = citation.context === 'message_attachment' ? 
                    '<span class="context-badge attachment-badge">ðŸ“Ž Message</span>' : 
                    '<span class="context-badge file-badge">ðŸ“ File</span>';
                
                galleryHtml += `
                    <div class="image-gallery-item" data-image-index="${index}" data-image-url="${imageUrl}" data-image-filename="${safeFilename}">
                        <div class="image-thumbnail-container">
                            <img src="${imageUrl}" 
                                 alt="${citation.filename}" 
                                 class="image-thumbnail"
                                 loading="lazy"
                                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\'%3E%3Crect fill=\'%23ddd\' width=\'200\' height=\'200\'/%3E%3Ctext fill=\'%23999\' font-family=\'Arial\' font-size=\'14\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\'%3EImage not found%3C/text%3E%3C/svg%3E';">
                            <div class="image-overlay">
                                <i class="fas fa-search-plus"></i>
                            </div>
                        </div>
                        <div class="image-info">
                            <div class="image-filename" title="${citation.filename}">${citation.filename}</div>
                            ${contextBadge}
                        </div>
                    </div>
                `;
            });
            
            galleryHtml += '</div>'; // Close image-gallery
            
            // Add "Show more" section if there are more images
            if (hiddenImages.length > 0) {
                const moreId = 'more-images-' + Date.now();
                galleryHtml += `
                    <div class="more-images-section">
                        <button class="more-images-btn" onclick="toggleMoreImages('${moreId}')">
                            <i class="fas fa-chevron-down"></i>
                            Show ${hiddenImages.length} more images
                        </button>
                        <div id="${moreId}" class="more-images-grid" style="display: none;">
                `;
                
                hiddenImages.forEach((citation, index) => {
                    const imageUrl = `/api/media/${encodeURIComponent(citation.filename)}`;
                    const safeFilename = citation.filename.replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                    const contextBadge = citation.context === 'message_attachment' ? 
                        '<span class="context-badge attachment-badge">ðŸ“Ž Message</span>' : 
                        '<span class="context-badge file-badge">ðŸ“ File</span>';
                    
                    galleryHtml += `
                        <div class="image-gallery-item" data-image-url="${imageUrl}" data-image-filename="${safeFilename}">
                            <div class="image-thumbnail-container">
                                <img src="${imageUrl}" 
                                     alt="${citation.filename}" 
                                     class="image-thumbnail"
                                     loading="lazy"
                                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\'%3E%3Crect fill=\'%23ddd\' width=\'200\' height=\'200\'/%3E%3Ctext fill=\'%23999\' font-family=\'Arial\' font-size=\'14\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\'%3EImage not found%3C/text%3E%3C/svg%3E';">
                                <div class="image-overlay">
                                    <i class="fas fa-search-plus"></i>
                                </div>
                            </div>
                            <div class="image-info">
                                <div class="image-filename" title="${citation.filename}">${citation.filename}</div>
                                ${contextBadge}
                            </div>
                        </div>
                    `;
                });
                
                galleryHtml += `
                        </div>
                    </div>
                `;
            }
            
            galleryHtml += '</div>'; // Close image-citations-section
            
            // Use setTimeout to attach event listeners after HTML is inserted
            setTimeout(() => {
                attachImageClickHandlers();
            }, 100);
            
            return galleryHtml;
        }
        
        function attachImageClickHandlers() {
            // Use event delegation for image clicks
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;
            
            // Remove existing listeners to avoid duplicates
            chatMessages.removeEventListener('click', handleImageClick);
            // Add new listener
            chatMessages.addEventListener('click', handleImageClick);
        }
        
        function handleImageClick(e) {
            // Check if clicked element is an image or inside an image gallery item
            const imageItem = e.target.closest('.image-gallery-item');
            if (imageItem) {
                const imageUrl = imageItem.getAttribute('data-image-url');
                const imageFilename = imageItem.getAttribute('data-image-filename');
                if (imageUrl && imageFilename) {
                    openImageModal(imageUrl, imageFilename);
                }
            }
        }
        
        function toggleMoreImages(elementId) {
            const element = document.getElementById(elementId);
            const btn = element.previousElementSibling;
            if (element.style.display === 'none') {
                element.style.display = 'grid';
                btn.innerHTML = '<i class="fas fa-chevron-up"></i> Show less';
            } else {
                element.style.display = 'none';
                btn.innerHTML = '<i class="fas fa-chevron-down"></i> Show more';
            }
        }
        
        function openImageModal(imageUrl, filename) {
            // Decode HTML entities in filename
            const decodedFilename = filename.replace(/&#39;/g, "'").replace(/&quot;/g, '"');
            
            // Create modal overlay
            const modal = document.createElement('div');
            modal.className = 'image-modal-overlay';
            modal.innerHTML = `
                <div class="image-modal-content">
                    <button class="image-modal-close" onclick="this.closest('.image-modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                    <img src="${imageUrl}" alt="${decodedFilename}" class="image-modal-image" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'400\'%3E%3Crect fill=\'%23ddd\' width=\'400\' height=\'400\'/%3E%3Ctext fill=\'%23999\' font-family=\'Arial\' font-size=\'16\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\'%3EImage not found%3C/text%3E%3C/svg%3E';">
                    <div class="image-modal-info">
                        <strong>${decodedFilename}</strong>
                    </div>
                </div>
            `;
            
            // Close on overlay click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            // Close on Escape key
            const closeHandler = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', closeHandler);
                }
            };
            document.addEventListener('keydown', closeHandler);
            
            document.body.appendChild(modal);
        }

        // Chat persistence functions
        function saveChatHistory() {
            try {
                const chatMessages = document.getElementById('chatMessages');
                if (!chatMessages) return;
                
                const messages = Array.from(chatMessages.children).slice(1); // Skip the initial AI message
                const chatHistory = {
                    timestamp: new Date().toISOString(),
                    messages: []
                };
                
                messages.forEach((message) => {
                    const isAI = message.classList.contains('ai-message');
                    const content = message.querySelector('.message-content');
                    const timestamp = message.querySelector('.message-timestamp');
                    
                    if (content) {
                        chatHistory.messages.push({
                            sender: isAI ? 'ai' : 'user',
                            content: content.innerHTML, // Keep HTML formatting
                            timestamp: timestamp ? timestamp.textContent : 'Unknown',
                            isAI: isAI
                        });
                    }
                });
                
                localStorage.setItem('ufdr_chat_history', JSON.stringify(chatHistory));
            } catch (error) {
                console.error('Error saving chat history:', error);
            }
        }

        function loadChatHistory() {
            try {
                const savedHistory = localStorage.getItem('ufdr_chat_history');
                if (!savedHistory) return;
                
                const chatHistory = JSON.parse(savedHistory);
                const chatMessages = document.getElementById('chatMessages');
                if (!chatMessages || !chatHistory.messages || chatHistory.messages.length === 0) return;
                
                // Clear existing messages except the initial AI message
                const initialMessage = chatMessages.children[0];
                chatMessages.innerHTML = '';
                chatMessages.appendChild(initialMessage);
                
                // Restore saved messages
                chatHistory.messages.forEach((msg) => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `chat-message ${msg.isAI ? 'ai-message' : 'user-message'}`;
                    
                    const messageContent = `
                        <div class="message-content">
                            ${msg.content}
                        </div>
                        <div class="message-timestamp">
                            ${msg.timestamp}
                        </div>
                    `;
                    
                    messageDiv.innerHTML = messageContent;
                    chatMessages.appendChild(messageDiv);
                });
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                console.log(`Loaded ${chatHistory.messages.length} chat messages from history`);
            } catch (error) {
                console.error('Error loading chat history:', error);
            }
        }

        function clearChatHistory() {
            try {
                localStorage.removeItem('ufdr_chat_history');
                const chatMessages = document.getElementById('chatMessages');
                if (chatMessages) {
                    // Clear everything including welcome message
                    chatMessages.innerHTML = '';
                }
                console.log('Chat history cleared');
            } catch (error) {
                console.error('Error clearing chat history:', error);
            }
        }

        function clearChatAndShowWelcome() {
            clearChatHistory();
            // Optionally re-add welcome message if needed
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages && chatMessages.children.length === 0) {
                const welcomeWrapper = document.createElement('div');
                welcomeWrapper.className = 'chat-message-wrapper';
                welcomeWrapper.innerHTML = `
                    <div class="chat-message">
                        <div class="chat-message-bubble ai">
                            Ready to investigate. What would you like to know about this case?
                        </div>
                        <div class="chat-message-timestamp" id="welcomeTimestamp"></div>
                    </div>
                `;
                chatMessages.appendChild(welcomeWrapper);
                addWelcomeMessage();
            }
        }

        function clearChatOnly() {
            if (!confirm('Are you sure you want to clear the chat? This will remove all messages including the welcome message.')) {
                return;
            }
            
            try {
                // Clear all messages including welcome
                const chatMessages = document.getElementById('chatMessages');
                if (chatMessages) {
                    chatMessages.innerHTML = '';
                }
                
                // Clear localStorage chat history
                localStorage.removeItem('ufdr_chat_history');
                
                // Clear current session messages
                if (currentSessionId) {
                    const session = investigationSessions.find(s => s.id === currentSessionId);
                    if (session) {
                        session.messages = [];
                        saveSessions();
                    }
                }
                
                showNotification('Chat cleared successfully!', 'success');
            } catch (error) {
                console.error('Error clearing chat:', error);
                showNotification('Failed to clear chat', 'error');
            }
        }

        function formatDetailedResults(results) {
            let html = '';
            
            // Generic matches array (contacts/messages/calls/files/device)
            if (results && Array.isArray(results.matches) && results.matches.length > 0) {
                html += '<h4>Forensic Evidence Matches</h4>';
                html += `<div class="forensic-summary">Found ${results.total_matches || results.matches.length} evidence items</div>`;
                html += '<ul>';
                results.matches.forEach((item, index) => {
                    const type = (item.type || 'item').toString();
                    html += '<li class="result-item">';
                    
                    if (type === 'contact') {
                        html += `
                            <div class="item-header">
                                <span class="item-type">Contact</span>
                                <span class="item-source">${item.source_file || 'Unknown Source'}</span>
                            </div>
                            <div class="item-content">
                                <strong>${item.name || 'Unknown Name'}</strong><br/>
                                Phone: ${item.phone || 'N/A'}
                            </div>
                            <div class="item-meta">
                                <span>Contact Record</span>
                                <span>${item.source_file || 'Unknown'}</span>
                            </div>
                        `;
                    } else if (type === 'call') {
                        html += `
                            <div class="item-header">
                                <span class="item-type">Call Log</span>
                                <span class="item-source">${item.source_file || 'Unknown Source'}</span>
                            </div>
                            <div class="item-content">
                                <strong>${item.from || 'Unknown'} â†’ ${item.to || 'Unknown'}</strong><br/>
                                Duration: ${item.duration || 'N/A'}s
                            </div>
                            <div class="item-meta">
                                <span>${item.timestamp || 'Unknown Time'}</span>
                                <span>${item.source_file || 'Unknown'}</span>
                            </div>
                        `;
                    } else if (type === 'message') {
                        const txt = (item.text || '').toString().slice(0, 150);
                        html += `
                            <div class="item-header">
                                <span class="item-type">Message</span>
                                <span class="item-source">${item.source_file || 'Unknown Source'}</span>
                            </div>
                            <div class="item-content">
                                <strong>${item.from || 'Unknown'} â†’ ${item.to || 'Unknown'}</strong><br/>
                                ${txt}${txt.length >= 150 ? '...' : ''}
                            </div>
                            <div class="item-meta">
                                <span>${item.timestamp || 'Unknown Time'}</span>
                                <span>${item.source_file || 'Unknown'}</span>
                            </div>
                        `;
                    } else {
                        const summary = [
                            item.name ? `Name: ${item.name}` : '',
                            item.phone ? `Phone: ${item.phone}` : '',
                            item.text ? `${item.text}` : '',
                            item.timestamp ? `@ ${item.timestamp}` : ''
                        ].filter(Boolean).join(' Â· ');
                        html += `
                            <div class="item-header">
                                <span class="item-type">${type.toUpperCase()}</span>
                                <span class="item-source">${item.source_file || 'Unknown Source'}</span>
                            </div>
                            <div class="item-content">${summary}</div>
                        `;
                    }
                    html += '</li>';
                });
                html += '</ul>';
            }

            if (results.search_matches && results.search_matches.length > 0) {
                html += '<h4>Search Pattern Matches</h4><ul>';
                results.search_matches.forEach(match => {
                    html += `<li class="result-item">
                        <div class="item-content">${match}</div>
                    </li>`;
                });
                html += '</ul>';
            }
            
            if (results.semantic_analysis) {
                html += '<h4>Forensic Analysis</h4><ul>';
                Object.entries(results.semantic_analysis).forEach(([key, value]) => {
                    html += `<li class="result-item">
                        <div class="item-header">
                            <span class="item-type">Analysis</span>
                        </div>
                        <div class="item-content">
                            <strong>${key}:</strong> ${value}
                        </div>
                    </li>`;
                });
                html += '</ul>';
            }
            
            if (results.recommendations && results.recommendations.length > 0) {
                html += '<h4>Investigation Recommendations</h4><ul>';
                results.recommendations.forEach(rec => {
                    html += `<li class="result-item">
                        <div class="item-header">
                            <span class="item-type">Recommendation</span>
                        </div>
                        <div class="item-content">${rec}</div>
                    </li>`;
                });
                html += '</ul>';
            }
            
            if (!html) {
                try {
                    html = `<pre>${JSON.stringify(results, null, 2)}</pre>`;
                } catch (e) {
                    html = '<em>No details available.</em>';
                }
            }
            
            return html;
        }

        function toggleDetailedResults(detailsId) {
            const detailsDiv = document.getElementById(detailsId);
            const button = detailsDiv.previousElementSibling;
            
            if (detailsDiv.style.display === 'none') {
                detailsDiv.style.display = 'block';
                button.textContent = 'Hide detailed results';
            } else {
                detailsDiv.style.display = 'none';
                button.textContent = 'Show detailed results';
            }
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
                <span>Forensic AI Investigator is analyzing evidence...</span>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }



        // Test function to verify chat functionality
        function testChat() {
            console.log('Test chat function called');
            console.log('chatInput element:', chatInput);
            console.log('chatSendBtn element:', chatSendBtn);
            console.log('chatMessages element:', chatMessages);
            
            // Set a test message
            if (chatInput) {
                chatInput.value = 'test message from button';
                console.log('Set test message');
                sendChatMessage();
            } else {
                console.error('chatInput element not found!');
            }
        }

        // Initialize chat handlers when page loads (guard against double-binding)
        let __chatHandlersInitialized = false;
        document.addEventListener('DOMContentLoaded', function() {
            if (!__chatHandlersInitialized) {
                setupChatHandlers();
                __chatHandlersInitialized = true;
            }
        });

        // LLM Status Management - Removed (replaced by model dropdown)

    </script>

    <!-- File Preview Modal -->
    <div id="filePreviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>File Preview</h3>
                <button class="modal-close" onclick="closeFilePreview()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="file-info" id="fileInfo">
                    <!-- File information will be populated here -->
                </div>
                <div class="file-preview" id="filePreviewContent">
                    <!-- File content will be displayed here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeFilePreview()">
                    Cancel
                </button>
                <button class="btn btn-primary" onclick="confirmUpload()">
                    Upload File
                </button>
            </div>
        </div>
    </div>
</body>
</html>

